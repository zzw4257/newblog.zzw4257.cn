---  
import dayjs from "@utils/dayjs";  
import { USER_NAME, DATE_FORMAT, t, umamiConfig } from "@config";  
import type { PostData } from "@interfaces/data";  
import { Icon } from "astro-icon/components";  
import PostFilter from "./PostFilter.astro";  
  
const { title, url, pubDate, badge, categories = [], tags = [], word, time } = Astro.props as PostData;  
const displayDate = pubDate ? dayjs(pubDate).format(DATE_FORMAT) : "";  
  
// 从 URL 中提取 slug  
const slug = url ? url.toString().split('/').filter(Boolean).pop() : undefined;  
  
const socialLinks = [  
  {  
    name: "X (Twitter)",  
    icon: "ri:twitter-x-line",  
    class: "bg-black hover:bg-gray-800",  
    url: `https://twitter.com/intent/tweet/?text=${title}&url=${url}`,  
  },  
  {  
    name: "Telegram",  
    icon: "ri:telegram-line",  
    class: "bg-[#26a5e4] hover:bg-[#1e96d1]",  
    url: `https://telegram.me/share/url?text=${title}&url=${url}`,  
  },
  {  
    name: "Reddit",  
    icon: "ri:reddit-line",  
    class: "bg-[#ff4500] hover:bg-[#e63e00]",  
    url: `https://reddit.com/submit/?url=${url}&title=${title}`,  
  },  
  {  
    name: "Facebook",  
    icon: "ri:facebook-circle-line",  
    class: "bg-[#0866ff] hover:bg-[#0755d6]",  
    url: `https://facebook.com/sharer/sharer.php?u=${url}`,  
  },  
  {  
    name: "Email",  
    icon: "ri:mail-line",  
    class: "bg-gray-600 hover:bg-gray-700",  
    url: `mailto:?subject=${title}&body=${url}`,  
  },  
];  
---  
  
<hr />  
<div class="container p-0">  
  <div class="text-right text-sm text-base-content/60 italic mb-2">  
    <Icon name="ri:heart-line" class="w-4 h-4 inline-block align-text-bottom text-error" /> Thanks for reading!  
  </div>  
  
  <div class="card bg-base-200 overflow-visible">  
    <div class="card-body relative p-4 sm:p-6 lg:p-8">  
      <!-- License Icon -->  
      <div class="absolute -top-8 left-8">  
        <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center shadow-lg">  
          <Icon name="ri:creative-commons-line" class="w-10 h-10 text-primary-content" />  
        </div>  
      </div>  
  
      <!-- Article Metadata -->  
      <div class="space-y-4">  
        <h3 class="text-lg sm:text-xl lg:text-2xl font-bold">{title}</h3>  
  
        <!-- Stats Row -->  
        <div class="flex flex-wrap gap-2 sm:gap-4 text-xs sm:text-sm opacity-75">  
          {  
            displayDate && (  
              <span class="flex items-center gap-1">  
                <Icon name="lucide:calendar" class="h-4 w-4" />  
                {displayDate}  
              </span>  
            )  
          }  
  
          {  
            badge && (  
              <span class="flex items-center gap-1">  
                <Icon name="lucide:bookmark" class="h-4 w-4" />  
                {badge}  
              </span>  
            )  
          }  
  
          {  
            word && time && (  
              <div class="flex items-center gap-1">  
                <Icon name="lucide:book-open" class="h-4 w-4" />  
                <span>  
                  {word} {t("label.wordCount")} · {time} {t("label.readTime")}  
                </span>  
              </div>  
            )  
          }  
  
          {  
            slug && umamiConfig.enable && (  
              <>
                <div class="flex items-center gap-1">  
                  <Icon name="lucide:eye" class="h-4 w-4 text-primary" />  
                  <span id="license-page-views">-</span>  
                </div>  
                <div class="flex items-center gap-1">  
                  <Icon name="lucide:user" class="h-4 w-4 text-primary" />  
                  <span id="license-page-visitors">-</span>  
                </div>
              </>
            )  
          }   
        </div>  
  
        <!-- Categories and Tags -->  
        <div class="mt-4">  
          <PostFilter categories={categories} tags={tags} />  
          <!-- License Info -->  
          <hr class="my-4" />  
          <div class="flex justify-between items-center flex-wrap gap-4">  
            <div class="text-sm opacity-75">  
              © {USER_NAME} |  
              <a  
                href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed"  
                target="_blank"  
                rel="noopener noreferrer"  
                class="hover:text-primary transition-colors"  
              >  
                CC BY-NC-SA 4.0  
              </a>  
            </div>  
            <div class="flex gap-2">
              <!-- Reward Button -->
              <button class="btn btn-secondary btn-outline" onclick="reward_modal.showModal()">
                赞赏
                <Icon name="ri:hand-heart-line" class="w-5 h-5" />
              </button>
              <!-- Share Button -->  
              <button class="btn btn-primary btn-outline" onclick="share_modal.showModal()">  
                {t("label.share")}  
                <Icon name="ri:share-line" class="w-5 h-5" />  
              </button>
            </div>  
          </div>  
        </div>  
      </div>  
    </div>  
  </div>  
  
  <!-- Share Modal -->  
  <dialog id="share_modal" class="modal modal-bottom sm:modal-middle">  
    <div class="modal-box max-w-2xl rounded-none sm:rounded-xl relative">  
      <h3 class="font-bold text-lg sm:text-xl mb-6 text-center">  
        {t("label.shareCard")}  
      </h3>  
      <div class="flex flex-wrap gap-4 justify-center">  
        {  
          socialLinks.map(({ name, icon, class: bgClass, url }) => (  
            <a  
              href={url}  
              class={`btn btn-circle btn-lg transition-transform hover:scale-110 ${bgClass}`}  
              target="_blank"  
              rel="noopener noreferrer"  
              title={name}  
            >  
              <span class="sr-only">{name}</span>  
              <Icon name={icon} class="w-6 h-6 text-white" />  
            </a>  
          ))  
        }
        <!-- Copy Link Button -->
        <button
          class="btn btn-circle btn-lg transition-transform hover:scale-110 bg-neutral hover:bg-neutral-focus"
          title="Copy Link"
          onclick={`navigator.clipboard.writeText(window.location.href).then(() => {
            const btn = this;
            const toast = document.getElementById('copy-toast');
            btn.classList.add('btn-success');
            if (toast) {
              toast.classList.remove('opacity-0', 'translate-y-4');
            }
            setTimeout(() => {
              btn.classList.remove('btn-success');
              if (toast) {
                toast.classList.add('opacity-0', 'translate-y-4');
              }
            }, 2000);
          })`}
        >
          <span class="sr-only">Copy Link</span>
          <Icon name="ri:links-line" class="w-6 h-6 text-white" />
        </button>  
      </div>

      <!-- Toast Notification inside Modal -->
      <div id="copy-toast" class="absolute left-1/2 -translate-x-1/2 bottom-20 transition-all duration-300 opacity-0 translate-y-4 pointer-events-none z-50 w-max">
        <div class="alert alert-success shadow-lg text-white py-2 px-4 text-sm">
          <Icon name="ri:checkbox-circle-line" class="w-5 h-5" />
          <span>链接已复制成功！</span>
        </div>
      </div>

      <div class="modal-action">  
        <form method="dialog">  
          <button class="btn btn-ghost hover:scale-105 transition-transform">  
            {t("label.close")}  
          </button>  
        </form>  
      </div>  
    </div>  
    <form method="dialog" class="modal-backdrop">  
      <button>{t("label.close")}</button>  
    </form>  
  </dialog>

  <!-- Reward Modal -->
  <dialog id="reward_modal" class="modal modal-middle">
    <div class="modal-box w-11/12 max-w-4xl rounded-xl relative overflow-x-hidden">
      <h3 class="font-bold text-lg sm:text-xl mb-6 text-center">
        赞赏支持
      </h3>
      
      <div class="flex flex-row justify-center items-center gap-4 md:gap-8 p-4">
        <!-- WeChat -->
        <div class="flex flex-col items-center gap-2">
          <div class="w-28 h-28 md:w-44 md:h-44 bg-white rounded-xl overflow-hidden shadow-lg border border-base-300 flex items-center justify-center">
            <img src="/weixin.jpg" alt="微信收款码" class="w-full h-full object-contain" />
          </div>
          <div class="flex items-center gap-1 md:gap-2 text-success font-bold text-xs md:text-base">
            <Icon name="ri:wechat-pay-line" class="w-4 h-4 md:w-6 md:h-6" />
            <span>微信</span>
          </div>
        </div>

        <!-- Alipay -->
        <div class="flex flex-col items-center gap-2">
          <div class="w-28 h-28 md:w-44 md:h-44 bg-white rounded-xl overflow-hidden shadow-lg border border-base-300 flex items-center justify-center">
            <img src="/zhifubao.jpg" alt="支付宝收款码" class="w-full h-full object-contain" />
          </div>
          <div class="flex items-center gap-1 md:gap-2 text-[#1677ff] font-bold text-xs md:text-base">
            <Icon name="ri:alipay-line" class="w-4 h-4 md:w-6 md:h-6" />
            <span>支付宝</span>
          </div>
        </div>
      </div>

      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-ghost hover:scale-105 transition-transform">
            {t("label.close")}
          </button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>{t("label.close")}</button>
    </form>
  </dialog>
</div>  
  
{slug && umamiConfig.enable && (  
  <script define:vars={{ slug, umamiConfig }} is:inline>  
    // 获取浏览量统计  
    async function fetchLicensePageViews() {  
      if (!umamiConfig.enable) {  
        return;  
      }  
        
      const checkInterval = setInterval(async () => {
        if (typeof window.fetchUmamiStats === 'function') {
          clearInterval(checkInterval);
          try {
            const queryPath = `/blog/${slug}`;
            
            const statsData = await window.fetchUmamiStats(umamiConfig.baseUrl, umamiConfig.shareId, {
              timezone: umamiConfig.timezone,
              path: queryPath
            });
            
            const pageViews = (typeof statsData.pageviews === 'object' ? statsData.pageviews.value : statsData.pageviews) || 0;
            const visits = (typeof statsData.visitors === 'object' ? statsData.visitors.value : statsData.visitors) || 0;
            
            const viewsElement = document.getElementById('license-page-views');
            const visitorsElement = document.getElementById('license-page-visitors');
            
            if (viewsElement) viewsElement.textContent = `${pageViews} 浏览`;
            if (visitorsElement) visitorsElement.textContent = `${visits} 人`;
            
          } catch (error) {
            console.error('Error fetching page views for license:', error);
            const viewsElement = document.getElementById('license-page-views');
            const visitorsElement = document.getElementById('license-page-visitors');
            if (viewsElement) viewsElement.textContent = '-';
            if (visitorsElement) visitorsElement.textContent = '-';
          }
        }
      }, 100);
      
      // Stop checking after 10 seconds
      setTimeout(() => clearInterval(checkInterval), 10000);
    }  
  
    // 页面加载完成后获取统计数据  
    document.addEventListener('astro:page-load', fetchLicensePageViews);
    if (document.readyState === 'complete') fetchLicensePageViews();
    else document.addEventListener('DOMContentLoaded', fetchLicensePageViews);
  </script>  
)}  
  
<style>  
  .modal-backdrop button {  
    cursor: default;  
    width: 100%;  
    height: 100%;  
    opacity: 0;  
  }  
  
  /* Remove underlines from PostFilter buttons */  
  :global(.card-body .btn-category),  
  :global(.card-body .btn-tag) {  
    text-decoration: none;  
  }  
</style>