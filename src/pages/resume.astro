---
import BaseLayout from '@/layouts/BaseLayout.astro'
import { ResumeViewer } from '@/components/resume/ResumeViewer'
import type { ResumeData } from '@/interface/resume'
import fs from 'node:fs'
import path from 'node:path'
import { loadResumeData } from '@/lib/resume'

const resume = loadResumeData() as ResumeData
const printMode = Astro.url.searchParams.get('print') === '1'

const pdfPath = path.resolve('public/resume.pdf')
const pdfExists = fs.existsSync(pdfPath)

const headings = [
  { depth: 1, slug: 'resume', text: 'Resume' },
  ...(resume.education?.length ? [{ depth: 2, slug: 'education', text: 'Education' }] : []),
  ...(resume.experience?.length ? [{ depth: 2, slug: 'experience', text: 'Experience' }] : []),
  ...(resume.projects?.length ? [{ depth: 2, slug: 'projects', text: 'Projects' }] : []),
  ...(resume.skills?.length ? [{ depth: 2, slug: 'skills', text: 'Skills' }] : []),
  ...(resume.publications?.length ? [{ depth: 2, slug: 'publications', text: 'Publications' }] : []),
  ...((resume.languages?.length || resume.certifications?.length || resume.awards?.length) ? [{ depth: 2, slug: 'highlights', text: 'Highlights' }] : []),
]
---

<BaseLayout
  title="Resume"
  headings={headings}
  showTOC={!printMode}
  showSidebar={!printMode}
  showBanner={!printMode}
  isIndexed={false}
>
  {!printMode && <div id="resume-scroll-progress"></div>}
  {!printMode && (
    <div class="w-full max-w-4xl mx-auto">
      <div class="flex flex-wrap items-center justify-end gap-2 mb-4 animate-fade-in-up">
        <a href="/resume/edit" class="btn btn-primary btn-sm rounded-full">
          编辑
        </a>

        <a href="/resume?print=1" class="btn btn-outline btn-sm rounded-full" target="_blank" rel="noreferrer">
          导出 PDF（打印）
        </a>

        <button id="resume-open-latex" class="btn btn-outline btn-sm rounded-full" type="button">
          LaTeX 预览
        </button>
        <a href="/resume.tex" class="btn btn-ghost btn-sm rounded-full" target="_blank" rel="noreferrer">
          LaTeX 链接
        </a>

        <button
          id="resume-open-pdf"
          class:list={['btn btn-outline btn-sm rounded-full', !pdfExists ? 'btn-disabled opacity-60' : '']}
          type="button"
          disabled={!pdfExists}
        >
          PDF 预览
        </button>
        <a
          href="/resume.pdf"
          class:list={['btn btn-ghost btn-sm rounded-full', !pdfExists ? 'btn-disabled opacity-60' : '']}
          target="_blank"
          rel="noreferrer"
          aria-disabled={!pdfExists}
        >
          PDF 链接
        </a>
      </div>
    </div>
  )}

  <ResumeViewer data={resume} client:load />

  <script is:inline>
    // Calm reveal for sections (breathing)
    document.addEventListener('astro:page-load', () => {
      const sections = Array.from(document.querySelectorAll('.resume-section'))
      if (!sections.length) return

      const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches
      if (prefersReduced) {
        sections.forEach(s => s.classList.add('is-visible'))
        return
      }

      const io = new IntersectionObserver((entries) => {
        for (const e of entries) {
          if (!e.isIntersecting) continue
          const target = e.target
          if (target instanceof HTMLElement) {
            target.classList.add('is-visible')
            io.unobserve(target)
          } else {
            io.unobserve(target)
          }
        }
      }, { rootMargin: '0px 0px -10% 0px', threshold: 0.12 })

      sections.forEach(s => io.observe(s))
      document.addEventListener('astro:before-swap', () => io.disconnect(), { once: true })
    })
  </script>

  {!printMode && (
    <script is:inline>
      document.addEventListener('astro:page-load', () => {
        const bar = document.getElementById('resume-scroll-progress')
        const hero = document.querySelector('[data-resume-hero]')
        if (!bar) return

        const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches

        function updateProgress() {
          const doc = document.documentElement
          const scrollTop = window.scrollY || doc.scrollTop || 0
          const max = Math.max(1, (doc.scrollHeight - window.innerHeight))
          const p = Math.min(1, Math.max(0, scrollTop / max))
          bar.style.width = `${(p * 100).toFixed(3)}%`
        }

        let raf = 0
        function onScroll() {
          if (raf) return
          raf = window.requestAnimationFrame(() => {
            updateProgress()
            raf = 0
          })
        }
        window.addEventListener('scroll', onScroll, { passive: true })
        updateProgress()

        // Tiny parallax for hero mesh (subtle, theme-friendly)
        if (!prefersReduced && hero) {
          let mraf = 0
          const onMove = (e) => {
            if (mraf) return
            mraf = window.requestAnimationFrame(() => {
              const rect = hero.getBoundingClientRect()
              const x = (e.clientX - rect.left) / Math.max(1, rect.width) - 0.5
              const y = (e.clientY - rect.top) / Math.max(1, rect.height) - 0.5
              hero.style.setProperty('--rx', `${x * 14}px`)
              hero.style.setProperty('--ry', `${y * 10}px`)
              mraf = 0
            })
          }
          hero.addEventListener('mousemove', onMove, { passive: true })
          hero.addEventListener('mouseleave', () => {
            hero.style.setProperty('--rx', '0px')
            hero.style.setProperty('--ry', '0px')
          })
        }

        document.addEventListener('astro:before-swap', () => {
          window.removeEventListener('scroll', onScroll)
          if (raf) cancelAnimationFrame(raf)
        }, { once: true })
      })
    </script>
  )}

  {printMode && (
    <script is:inline>
      // Print-focused mode: auto trigger print after layout
      window.addEventListener('load', () => {
        setTimeout(() => {
          window.print()
        }, 350)
      })
    </script>
  )}

  {!printMode && (
  <dialog id="resume_latex_modal" class="modal">
    <div class="modal-box w-11/12 max-w-5xl bg-base-100 rounded-2xl shadow-2xl border border-base-content/10">
      <div class="flex items-center justify-between gap-4">
        <h3 class="font-bold text-lg">LaTeX 预览</h3>
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost" aria-label="Close">✕</button>
        </form>
      </div>
      <div class="mt-4">
        <div class="flex items-center justify-between gap-2 mb-3">
          <div class="text-sm text-base-content/60">
            来源：<a class="link link-primary" href="/resume.tex" target="_blank" rel="noreferrer">/resume.tex</a>
          </div>
          <a class="btn btn-sm btn-outline rounded-full" href="/resume.tex" target="_blank" rel="noreferrer">打开</a>
        </div>
        <pre class="p-4 rounded-xl bg-base-200/50 border border-base-content/10 overflow-auto text-sm leading-relaxed"><code id="resume-latex-code">加载中…</code></pre>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <dialog id="resume_pdf_modal" class="modal">
    <div class="modal-box w-11/12 max-w-6xl bg-base-100 rounded-2xl shadow-2xl border border-base-content/10">
      <div class="flex items-center justify-between gap-4">
        <h3 class="font-bold text-lg">PDF 预览</h3>
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost" aria-label="Close">✕</button>
        </form>
      </div>
      <div class="mt-4">
        {
          pdfExists ? (
            <iframe
              title="Resume PDF Preview"
              src="/resume.pdf#view=FitH"
              class="w-full h-[75vh] rounded-xl border border-base-content/10 bg-base-200"
            />
          ) : (
            <div class="p-6 rounded-xl bg-base-200/50 border border-base-content/10 text-base-content/70">
              未检测到 `public/resume.pdf`，请把你的 PDF 放到 `public/resume.pdf` 后刷新。
            </div>
          )
        }
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <script is:inline>
    document.addEventListener('astro:page-load', () => {
      const btnLatex = document.getElementById('resume-open-latex')
      const btnPdf = document.getElementById('resume-open-pdf')
      const latexModal = document.getElementById('resume_latex_modal')
      const pdfModal = document.getElementById('resume_pdf_modal')
      const codeEl = document.getElementById('resume-latex-code')

      btnLatex?.addEventListener('click', async () => {
        try {
          if (codeEl) codeEl.textContent = '加载中…'
          latexModal?.showModal()
          const res = await fetch('/resume.tex', { cache: 'no-store' })
          const text = await res.text()
          if (codeEl) codeEl.textContent = text
        } catch (e) {
          if (codeEl) codeEl.textContent = '加载失败，请刷新重试。'
        }
      })

      btnPdf?.addEventListener('click', () => {
        pdfModal?.showModal()
      })
    })
  </script>
  )}
</BaseLayout>

